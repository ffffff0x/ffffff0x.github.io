<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>Music Bot Setup | bo0s</title>
  <meta name="author" content="hitman">
  
  <meta name="description" content="My Blog/Website, will Tutorials, and just my general thoughts.">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="Music Bot Setup"/>
  <meta property="og:site_name" content="bo0s"/>

  
    <meta property="og:image" content=""/>
  

  
  
    <link href="/12favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  




<meta name="generator" content="Hexo 5.0.0"><link rel="stylesheet" href="/css/prism-vs.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">bo0s</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="全部文章">
			  <i class="fa fa-archive"></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="标签">
			  <i class="fa fa-tag"></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="我是谁.">
			  <i class="fa fa-user"></i>About
			</a>
		  </li>
		  
		  <li>
			<a href="/wiki/#/" title="WiKi.">
			  <i class="fa fa-book"></i>WiKi
			</a>
		  </li>
		  
		  <li>
			<a href="/tool" title="工具">
			  <i class="fa fa-space-shuttle"></i>Tool
			</a>
		  </li>
		  
		  <li>
			<a href="/logs" title="日志">
			  <i class="fa fa-tachometer"></i>Logs
			</a>
		  </li>
		  
		  <li>
			<a href="/code/landing/" title="Discord.JS Bot Code">
			  <i class="fa fa-code"></i>Tutorials / Code
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 
	
		<div class="page-header">
			<h1> Music Bot Setup</h1>
		</div>
	



<div class="row page">
	<!-- cols -->
	
	<div class="col-md-12"> 
	

	<!-- content -->
	<div class="mypage">		
	  		

	  <h2 id="Welcome"><a href="#Welcome" class="headerlink" title="Welcome!"></a>Welcome!</h2><p>In this tutorial we take the code from the <a href="/code/topics/discordjs/advancedbot">Advanced Bot Tutorial</a> and add onto it to create a Music feature set. </p>
<p>It is entirely possible to integrate this code into a bot that doesn’t follow the tutorial, in fact- it’s been written to explain very clearly where the files and code should go - however it may still be helpful to view the Advanced Bot Tutorial to ensure your bot is setup in a proper way, or so that you understand where the tutorial is referencing.</p>
<p><strong>Note</strong> This is a music bot that does <strong>not</strong> use youtube. Music bots that use youtube break the youtube terms of service, and stream copyrighted content that was posted in video format. This is not something I wish to promote. Youtube will ban IP addresses of bots that do this. Larger music bots utilize a system of rotating IPv6 addresses to get around these blocks, which can become expensive, and by doing this they are knowingly breaking the terms of service. I do not condone this type of behavior, and as such will not be creating a tutorial based around youtube for specific song playback.</p>
<p><strong>Without</strong> further ado, let’s get into it!</p>
<hr>
<h2 id="Prerequisites"><a href="#Prerequisites" class="headerlink" title="Prerequisites"></a>Prerequisites</h2><p>There are a few modules we need to install with NPM first, we need <a target="_blank" rel="noopener" href="https://www.npmjs.com/package/ffmpeg">FFmpeg</a>*, <a target="_blank" rel="noopener" href="https://www.npmjs.com/package/fluent-ffmpeg">Fluent-ffmpeg</a>, and lastly, <a target="_blank" rel="noopener" href="https://www.npmjs.com/package/@discordjs/opus">@discord.js/opus</a></p>
<p>You can install them all with </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install ffmpeg fluent-ffmpeg @discordjs/opus --save</span><br></pre></td></tr></table></figure>

<p>Now we must ensure FFmpeg is installed on the OS the bot is running on. For Debian based Linux Distros it is as easy as doing <code>sudo apt install ffmpeg</code> but for Windows users it is a bit more complicated.</p>
<p>For windows users you must first download FFmpeg from <a target="_blank" rel="noopener" href="https://ffmpeg.zeranoe.com/builds/">the official downloads page</a>.<br>From here you must do the following to ensure FFmpeg is registered</p>
<ul>
<li>Extract the download into a location of your choice</li>
<li>Rename the extracted folder to <code>FFmpeg</code> for clarity</li>
<li>Go to <code>Control Panel &gt; System and Security &gt; System &gt; Advanced System Settings</code></li>
<li>From here, click on <code>Environment Variables</code> in the Advanced Settings window</li>
<li>Double click on the <code>Path</code> value in the table shown</li>
<li>Click <code>new</code> to add a new variable to the path</li>
<li>Add your FFmpeg folder path into the table and click <code>ok</code></li>
<li>Restart your command line/terminal, and FFmpeg should be installed!</li>
</ul>
<p>Once FFmpeg is installed, you should be all set to move on!</p>
<hr>
<h2 id="Bot-Setup"><a href="#Bot-Setup" class="headerlink" title="Bot Setup"></a>Bot Setup</h2><p>We will need to add some new properties to the Client. To do this in a clean and future proof way, we will be storing the properties in a separate file, and requiring them in the <code>index.js</code> file we created in the Advanced Bot. For those not following from that tutorial, this should be the launching point for your bot, or where you store the Client creation and login.</p>
<p>To do this we should create a new folder under <code>/bot/connectors</code>, in other words, create a folder called <code>connectors</code> under the main folder for your bot. Make sure it is outside the commands and events folder!</p>
<p>Once you have done that, we need to create a <code>music.js</code> file to store the properties in. For this tutorial, we will use the following code in the <code>music.js</code> file.<br>Note: You will see some functions below, we will use this later on in the tutorial. For now, just keep them in this file for future use! They will be explained later.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">Client</span>) =&gt;</span> &#123;</span><br><span class="line">    Client.music = &#123;&#125; <span class="comment">// base object</span></span><br><span class="line">    Client.music.stations = [] <span class="comment">// array of stations available</span></span><br><span class="line">    Client.music.servers = <span class="keyword">new</span> <span class="built_in">Map</span>() <span class="comment">// a Map to store server data/settings</span></span><br><span class="line">    Client.music.getStation = <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getStation</span>(<span class="params">station</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// this will get the station/stream info</span></span><br><span class="line">    &#125;</span><br><span class="line">    Client.music.servers.recordPlayback = <span class="function"><span class="keyword">function</span> <span class="title">tracker</span>(<span class="params">data, station, info</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// this will set the servers map when playback begins or changes</span></span><br><span class="line">    &#125;</span><br><span class="line">    Client.music.servers.play = <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">playStation</span>(<span class="params">station, message</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// this will contain the play functionality</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>This code ensures we can use <code>require</code> to attach the properties and functions to the Client. We will have a queue Map, a servers Map, and a stations array to hold data. Along with this we will have *<em>three</em> very important functions for the future that allow for proper playback!</p>
<p>Once you have the <code>music.js</code> file setup, we should go ahead and require it to “connect” it to the Client. Inside your <code>index.js</code> file place the following code</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">&quot;./connectors/music.js&quot;</span>)(Client)</span><br></pre></td></tr></table></figure>
<p>This passes in the Client to the <code>music.js</code> file! Now your properties and functions exist on the bot and we can continue!</p>
<p>For reference, your folder structure should look something like this in the end.<br><img src="../../../../assets/musicbotstructure.PNG" alt="File Tree"></p>
<hr>
<h2 id="Ready-Event-Station-Fetching"><a href="#Ready-Event-Station-Fetching" class="headerlink" title="Ready Event / Station Fetching"></a>Ready Event / Station Fetching</h2><p><strong>Before</strong> we can get started, we will need to fetch the list of stations that the bot can play. This will allow us to sort by genre, and station in the later commands. For this tutorial we will be using a constantly updated list of stations that I curate on this site. That is the JSON structure we will be working with as well. If you would prefer to selfhost this list, you absolutely can, but remember to update this event with the correct URL to hit on ready.</p>
<p>The link to my stations list is <code>https://ajnicoloff.me/code/stationlist/index.json</code></p>
<p>To get the JSON we will need to use and require the <code>node-fetch</code> module. We will also be setting up the stations array for the future by mapping the json response. Let’s go ahead and do that. Inside your <code>ready</code> event, let’s use the following code. Do note, if your ready event is not asyncronous, it needs to be.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fetch = <span class="built_in">require</span>(<span class="string">&quot;node-fetch&quot;</span>) <span class="comment">// require the module</span></span><br><span class="line">    <span class="keyword">await</span> fetch(<span class="string">&quot;https://ajnicoloff.me/code/stationlist/index.json&quot;</span>)</span><br><span class="line">        .then(<span class="function"><span class="params">res</span> =&gt;</span> res.json())</span><br><span class="line">        .then(<span class="function"><span class="params">json</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// set the stations array for use while the bot is online</span></span><br><span class="line">            Client.music.stations = json.map(<span class="function"><span class="params">stream</span> =&gt;</span> [stream.name, stream.url, stream.statspos, stream.genre, stream.website, stream.donate, stream.description, stream.outdated])</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>
<p>Let’s go over what we did to set the array up. We mapped the stream name, url, statistic position, genre, website, donation website, stream description, AND whether or not the station is outdated into a nice array. That’s a lot! But it’s all information you will need. Let’s break it down.</p>
<ul>
<li>Stream Name / Radio Station Name</li>
<li>URL of the Stream</li>
<li>Position to read from the stations source*</li>
<li>The station Genre</li>
<li>Station website</li>
<li>Donation website,</li>
<li>Station description</li>
<li>If the station is outdated</li>
</ul>
<p>These are all important to know and will be used in the commands we create!<br>*Position - When we fetch a stream we obtain the stations status page which is in JSON format, with an array for each audio stream. The position listed in this gives us the proper array position to grab, as some stations have multiple streams going and multiple array positions!</p>
<p>With that, you should be all set to move onto the commands!</p>
<hr>
<h2 id="Play-by-Genre-Play-Command-1-4"><a href="#Play-by-Genre-Play-Command-1-4" class="headerlink" title="Play by Genre | Play Command [1/4]"></a>Play by Genre | Play Command [1/4]</h2><p><strong>Note</strong> This section includes subsections that are <strong>very</strong> important to follow. Without the subsections your command will not work!</p>
<p>So now it’s time to get to playing music! Lets go ahead and make a <code>music</code> commands folder and category, and create <code>play.js</code> as a command file.</p>
<p>We should go ahead and import the <code>Discord.js</code> module to be used for embeds while we are at it. </p>
<p>Your command should look like this (if following from the advanced bot tutorial)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exports</span>.run = <span class="keyword">async</span> (Client, message, args) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> Discord = <span class="built_in">require</span>(<span class="string">&quot;discord.js&quot;</span>)</span><br><span class="line">    <span class="keyword">const</span> embed = <span class="keyword">new</span> Discord.MessageEmbed()</span><br><span class="line">    embed</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">exports</span>.help = &#123;</span><br><span class="line">    name: <span class="string">&quot;play&quot;</span>,</span><br><span class="line">    aliases: [<span class="string">&quot;p&quot;</span>],</span><br><span class="line">    category: <span class="string">&quot;Music&quot;</span>,</span><br><span class="line">    description: <span class="string">&quot;Your_Description_Here&quot;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>This command should be all setup for building on now. It contains the basic command export structure, and it sets up a DiscordJS Message Embed.</p>
<blockquote>
<p>If your command structure doesn’t look quite like this, that’s fine! The real important part is the code inside the command.</p>
</blockquote>
<p><strong>Now</strong> to begin we want to check if the member of the discord is in a voice channel when they use this command, to do that we should check the message.member object for their voice status like so. While we are at it, we should send an embed to let them know! I’ve styled the embeds following this point to what I think looks nice, feel free to change it up as we go along!</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line">    <span class="keyword">if</span> (!message.member.voice.channel) <span class="keyword">return</span> embed.setAuthor(<span class="string">&quot;Join a VC First!&quot;</span>, <span class="string">`<span class="subst">$&#123;message.author.displayAvatarURL()&#125;</span>`</span>), message.channel.send(embed)</span><br><span class="line"><span class="comment">//...</span></span><br></pre></td></tr></table></figure>
<p>Now that we have a check to see if they are in a voice channel, lets talk about the command functions. In this tutorial the play command will have three functions. <code>genre</code>, <code>station</code>, and <code>manual</code> playing. Genre will play a random station from the available genres, while Station will play a station of the users choice, and lastly, Manual will allow a user to input a stream of their choice to play.</p>
<p><strong>Next</strong> we want to check if the user is providing an argument for a function to use. If not, stop and tell them to provide one.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!args[<span class="number">0</span>]) <span class="keyword">return</span> embed.setAuthor(<span class="string">&quot;Correct Usage - genre [genre], station [station], or manual [stream]&quot;</span>, <span class="string">`<span class="subst">$&#123;message.author.displayAvatarURL()&#125;</span>`</span>), message.channel.send(embed)</span><br></pre></td></tr></table></figure>
<p>Next lets get started with playing by genre!<br>We will be using the following code to do that, I will explain it in-depth and in the code comments.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (args[<span class="number">0</span>].toLowerCase() == <span class="string">&quot;genre&quot;</span>) &#123; <span class="comment">// is their argument &quot;genre&quot;, if yes, proceed</span></span><br><span class="line">    <span class="keyword">let</span> genres = Client.music.stations.map(<span class="function"><span class="params">channels</span> =&gt;</span> channels[<span class="number">3</span>].toLowerCase()) <span class="comment">// lets grab just the genre names from the available stations</span></span><br><span class="line">    args = args.splice(<span class="number">1</span>, args.length) <span class="comment">// remove &quot;genre&quot; from the arguments list now that we no longer need it.</span></span><br><span class="line">    <span class="keyword">if</span> (!args[<span class="number">0</span>]) <span class="keyword">return</span> embed.setAuthor(<span class="string">&quot;Please include the genre you&#x27;d like to hear!&quot;</span>, <span class="string">`<span class="subst">$&#123;message.author.displayAvatarURL()&#125;</span>`</span>), message.channel.send(embed) </span><br><span class="line">    <span class="comment">// [Above] if there is nothing left in args, they didn&#x27;t provide a genre</span></span><br><span class="line">    <span class="comment">// [Below] Check if the list of genres includes what they asked for</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!genres.includes(args.join(<span class="string">&quot; &quot;</span>).toLowerCase())) <span class="keyword">return</span> embed.setAuthor(<span class="string">&quot;That genre is unavailable.&quot;</span>, <span class="string">`<span class="subst">$&#123;message.author.displayAvatarURL()&#125;</span>`</span>), message.channel.sen(embed)</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// if everything checks out, grab all of the stations in that Genre, and select a random one!</span></span><br><span class="line">        <span class="keyword">var</span> channelList = Client.music.stations.filter(<span class="function"><span class="params">channel</span> =&gt;</span> channel[<span class="number">3</span>].toLowerCase() == args.join(<span class="string">&quot; &quot;</span>).toLowerCase())</span><br><span class="line">        <span class="comment">// begin the playback process by providing a station object, and the message content to the play function we setup above.</span></span><br><span class="line">        <span class="keyword">await</span> Client.music.servers.play(channelList[<span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * channelList.length)], message)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The code above has comments to help understand it, but lets go over what we are doing. First we are checking if the argument is asking for genre playback, if yes, lets run the inner code. Then we are grabbing all the genres from the available stations. Next, now that we have used the <code>genre</code> argument, we remove it. Leaving us with the genre the user provided. We then check if the user provided a genre to find, if not, we let them know. IF they did, we check if the genre exists in our array, if not, we once again let them know. If all has checked out so far, we grab a random station object from the genre, and pass it into the play function along with our message content. </p>
<p>With that, you have a play command that plays by genre of music. Now, it doesn’t quite play yet because we haven’t set up the functions in <code>music.js</code> remember those? Lets go ahead and set them up.</p>
<hr>
<h2 id="Play-Functions-Play-Command-2-4"><a href="#Play-Functions-Play-Command-2-4" class="headerlink" title="Play Functions | Play Command [2/4]"></a>Play Functions | Play Command [2/4]</h2><p>So we need those functions we setup earlier to do something, you know, the ones in <code>music.js</code>! Let’s make them get to work, no slacking off this time!<br>Let’s start with the getStation function. Let’s update the code to the following. I’ll explain below, and in the code comments.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Client.music.getStation = <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getStation</span>(<span class="params">station</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> fetch = <span class="built_in">require</span>(<span class="string">&quot;node-fetch&quot;</span>) <span class="comment">// require the node-fetch module</span></span><br><span class="line">    <span class="keyword">var</span> foundStation = &#123;&#125; <span class="comment">// setup our foundStation variable. This will hold the station info when fetched.</span></span><br><span class="line">    <span class="keyword">await</span> fetch(<span class="string">`<span class="subst">$&#123;(station[<span class="number">1</span>].split(<span class="string">&quot;/&quot;</span>)[<span class="number">0</span>]).includes(<span class="string">&quot;https&quot;</span>) ? <span class="string">&quot;https&quot;</span> : <span class="string">&quot;http&quot;</span>&#125;</span>://<span class="subst">$&#123;station[<span class="number">1</span>].split(<span class="string">&quot;/&quot;</span>)[<span class="number">2</span>]&#125;</span>/status-json.xsl`</span>).then(<span class="function"><span class="params">res</span> =&gt;</span> res.json()).then(<span class="function"><span class="params">json</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// check if the url is http, or https. Then get the main url without any paths, and request the status page.</span></span><br><span class="line">        <span class="keyword">if</span> (!json.icestats || !json.icestats.source) foundStation = <span class="literal">false</span>; <span class="comment">// if there is no source, the station isn&#x27;t going to work with the bot.</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!json.icestats.source[<span class="number">0</span>]) json.icestats.source = [json.icestats.source]</span><br><span class="line">        <span class="comment">// [Above] if there is a source, but it isn&#x27;t an array, lets go ahead and put it in one.</span></span><br><span class="line">        foundStation = json.icestats</span><br><span class="line">    &#125;).catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">//console.log(err) // This is useful if you are doing debugging and a channel isn&#x27;t working.</span></span><br><span class="line">        foundStation = <span class="literal">false</span> <span class="comment">// If there is an error, go ahead and say the station isn&#x27;t found.</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> foundStation; <span class="comment">// return the foundStation variable after everything has been run.</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>In the above code, we first check if the site we are getting is <code>http</code> or <code>https</code> - this is important! We then grab the main url without any paths, and request the status page from it. We take the response, and put it into JSON format. Then we check if the json has a icestats element. If it doesn’t - the station won’t work with the bot. If it does, but it doesn’t have a source in an array at the initial position, then it must only have one stream, so we put it into an array format. If there is an error along the way, we make sure we don’t return bad data. Then lastly, we return the contents of the station stats.</p>
<p>If this seems confusing, try logging the data we get from fetching the stats, an example of what that looks like is always helpful. I’ve included the stats for one station below.<br><img src="../../../../assets/stats.PNG" alt="Station Stats"></p>
<p><strong>Next</strong> let’s setup the <code>recordPlayback</code> function! This function will help us record the data of the station being played, and the playback object in the guild.<br>We will use the following code to do this, which is explained in the code comments, and in-depth below.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Client.music.servers.recordPlayback = <span class="function"><span class="keyword">function</span> <span class="title">tracker</span>(<span class="params">data, station</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// We pass in the &quot;data&quot; object when beginning playback.</span></span><br><span class="line">    <span class="comment">// Data Object: &#123; guild: DJS Guild Object, dispatcher: Connection Object, user: User who used the command, player: Player Object, summoned: ChannelID where command was used &#125;</span></span><br><span class="line">    <span class="comment">// The station object passed is the station we are playing - name, url, stats position.</span></span><br><span class="line">    Client.music.servers.set(data.guild.id, &#123; <span class="comment">// set the server in the servers map by ID</span></span><br><span class="line">    guild: data.guild, <span class="comment">// guild data</span></span><br><span class="line">    spawnedChannel: data.summoned, <span class="comment">// save the channel id where the command was last used</span></span><br><span class="line">    station: station, <span class="comment">// save the station data</span></span><br><span class="line">    dispatcher: data.dispatcher, <span class="comment">// save the dispatcher data</span></span><br><span class="line">    player: data.player, <span class="comment">// save the player object to be used in other commands</span></span><br><span class="line">    userControl: data.user, <span class="comment">// who has control of the player</span></span><br><span class="line">    lastRequest: <span class="built_in">Date</span>.now() + <span class="number">15000</span> <span class="comment">// when did the server last request the song playing?</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>In this code we simply set the servers map with the guild data. All the details are in the code comments, so I won’t dig too deep into them. But this is basically data we will need for other commands! It’s good to have.</p>
<p><strong>Next</strong> lets setup the play function! The one we have all been waiting for.<br>This command may look a bit messy, but it has everything we need, as condensed as possible. I’ll explain what is happening in the code comments, and in the description below.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Client.music.servers.play = <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">playStation</span>(<span class="params">station, message</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> Discord = <span class="built_in">require</span>(<span class="string">&quot;discord.js&quot;</span>)</span><br><span class="line">    <span class="keyword">const</span> embed = <span class="keyword">new</span> Discord.MessageEmbed()</span><br><span class="line">    <span class="comment">// [Above] Setup embeds</span></span><br><span class="line">    <span class="keyword">var</span> songDetails = <span class="keyword">await</span> Client.music.getStation(station) <span class="comment">// fetch the station stream details</span></span><br><span class="line">    <span class="keyword">if</span> (!songDetails) <span class="keyword">return</span> embed.setAuthor(<span class="string">`Incompatible Stream, ensure the stream is powered by IceCast or SHOUTcast.`</span>, <span class="string">`<span class="subst">$&#123;message.author.displayAvatarURL()&#125;</span>`</span>), message.channel.send(embed)</span><br><span class="line">    <span class="comment">// [Above] If the stream returns false, it isn&#x27;t compatible</span></span><br><span class="line">    <span class="keyword">const</span> bitrate = (songDetails.source[station[<span class="number">2</span>]].bitrate) ? songDetails.source[station[<span class="number">2</span>]].bitrate : (songDetails.source[station[<span class="number">2</span>]].audio_bitrate) ? songDetails.source[station[<span class="number">2</span>]].audio_bitrate : <span class="string">&quot;Unknown&quot;</span></span><br><span class="line">    <span class="comment">// [Above] Once we have the song/stream details, set the bitrate variable. You could do this within the embed, but I found it very hard to read.</span></span><br><span class="line">    <span class="keyword">if</span> (Client.music.servers.get(message.guild.id) &amp;&amp; message.author.id !== Client.music.servers.get(message.guild.id).userControl.id &amp;&amp; !message.member.hasPermission(<span class="string">&quot;MANAGE_GUILD&quot;</span>)) <span class="keyword">return</span> embed.setAuthor(<span class="string">`<span class="subst">$&#123;Client.music.servers.get(message.guild.id).userControl.tag&#125;</span> controls the audio right now.`</span>, <span class="string">`<span class="subst">$&#123;message.author.displayAvatarURL()&#125;</span>`</span>), message.channel.send(embed)</span><br><span class="line">    <span class="comment">// if someone else is controlling the audio already, don&#x27;t let others mess with it</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        message.member.voice.channel.join().then(<span class="keyword">async</span> connection =&gt; &#123; <span class="comment">// join the voice channel if not already joined</span></span><br><span class="line">        <span class="keyword">const</span> player = connection.play(<span class="string">`<span class="subst">$&#123;station[<span class="number">1</span>]&#125;</span>`</span>, &#123; <span class="attr">bitrate</span>: <span class="string">&quot;auto&quot;</span> &#125;) <span class="comment">// setup the player and go ahead and start playing a new stream</span></span><br><span class="line">            Client.music.servers.recordPlayback(&#123; <span class="attr">guild</span>: message.guild, <span class="attr">dispatcher</span>: connection, <span class="attr">user</span>: message.author, <span class="attr">player</span>: player, <span class="attr">summoned</span>: message.channel.id &#125;, station)</span><br><span class="line">            <span class="comment">// [Above] go ahead and record the new playback settings and info. we update this on each play command just incase something changes, or the bot was accidentally kicked from a vc (new connection)</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    embed.setAuthor(<span class="string">&quot;🎵 Playback Beginning 🎵&quot;</span>, <span class="string">`<span class="subst">$&#123;message.author.displayAvatarURL()&#125;</span>`</span>)</span><br><span class="line">    embed.addField(<span class="string">`Station`</span>, <span class="string">`<span class="subst">$&#123;station[<span class="number">0</span>] == <span class="string">&quot;Manual&quot;</span> ? songDetails.source[station[<span class="number">2</span>]].server_name : station[<span class="number">0</span>]&#125;</span>`</span>, <span class="literal">true</span>)</span><br><span class="line">    embed.addField(<span class="string">`Station Genre`</span>, <span class="string">`<span class="subst">$&#123;songDetails.source[station[<span class="number">2</span>]].genre ? songDetails.source[station[<span class="number">2</span>]].genre : station[<span class="number">3</span>]&#125;</span>`</span>, <span class="literal">true</span>)</span><br><span class="line">    embed.addField(<span class="string">`Stream Location`</span>, <span class="string">`<span class="subst">$&#123;songDetails.location&#125;</span>`</span>, <span class="literal">true</span>)</span><br><span class="line">    embed.addField(<span class="string">`Audio Bitrate`</span>, <span class="string">`<span class="subst">$&#123;bitrate&#125;</span>`</span>, <span class="literal">true</span>)</span><br><span class="line">    embed.addField(<span class="string">`Listeners`</span>, <span class="string">`<span class="subst">$&#123;songDetails.source[station[<span class="number">2</span>]].listeners ? songDetails.source[station[<span class="number">2</span>]].listeners : <span class="string">&quot;Just you!&quot;</span>&#125;</span>`</span>, <span class="literal">true</span>)</span><br><span class="line">    embed.addField(<span class="string">`Current Song`</span>, <span class="string">`<span class="subst">$&#123;songDetails.source[station[<span class="number">2</span>]].title ? songDetails.source[station[<span class="number">2</span>]].title : <span class="string">&quot;Unknown&quot;</span>&#125;</span>`</span>, <span class="literal">true</span>)</span><br><span class="line">    <span class="keyword">return</span> message.channel.send(embed)</span><br><span class="line">    <span class="comment">// [Above] Setup the embed to send, and... send it!</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The above code may seem complex but it really isn’t! First we setup the embed variable, then we fetch the stations stream info so we can use it. If there is no stream data, or it is incompatible, let the user know. We then setup a variable for bitrate for readability sake - checking for which icecast bitrate variable they are using - if none, we say “Unknown”. Then we check if the user of the command is the controller of the audio stream - if they aren’t they can’t mess around. If there is no stream, they are free to start one! Next we join the voice channel and we begin playback from the station stream URL. Once we have done that, we set the <code>Client.music.servers</code> map with the playback details! Lastly we setup the embed with all the details.</p>
<p>Hopefully you are able to understand the code written, I attempted to make it as short and condensed as possible, so you may need to take a moment ot disect it, the comments are there to help!</p>
<p><strong>Next</strong> Lets try to run the play command, searching for the <code>chill</code> genre, we want to make sure everything works! If done correctly, it should output a random station and begin playback like so<br><img src="../../../../assets/playgenre.PNG" alt="Station Stats"></p>
<p><strong>If</strong> it worked, congrats! Let’s move onto the next part. <strong>if</strong> not, look over the code again and make sure you didn’t miss something. You’ll get it!</p>
<hr>
<h2 id="Play-By-Station-Play-Command-3-4"><a href="#Play-By-Station-Play-Command-3-4" class="headerlink" title="Play By Station | Play Command [3/4]"></a>Play By Station | Play Command [3/4]</h2><p>Let’s continue from the play by genre block by adding a check for the “station” argument, and proceed with the code. I’ll be leaving comments, and I’ll have a description below.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (args[<span class="number">0</span>].toLowerCase() == <span class="string">&quot;station&quot;</span>) &#123; <span class="comment">// check if the &quot;station&quot; argument exists</span></span><br><span class="line">    <span class="keyword">if</span> (!args[<span class="number">1</span>]) <span class="keyword">return</span> embed.setAuthor(<span class="string">`Please include the station you&#x27;d like to hear!`</span>, <span class="string">`<span class="subst">$&#123;message.author.displayAvatarURL()&#125;</span>`</span>), message.channel.send(embed)</span><br><span class="line">    <span class="comment">// [Above] If no station name is provided, say they need one</span></span><br><span class="line">    args = args.splice(<span class="number">1</span>, args.length) <span class="comment">// remove all arguments that aren&#x27;t the station name</span></span><br><span class="line">    <span class="keyword">var</span> selected = Client.music.stations.filter(<span class="function"><span class="params">channel</span> =&gt;</span> channel[<span class="number">0</span>].toLowerCase().includes(args.join(<span class="string">&quot; &quot;</span>).toLowerCase()))</span><br><span class="line">    <span class="comment">// [Above] Get the channel closest to the station name provided</span></span><br><span class="line">    <span class="keyword">if</span> (!selected[<span class="number">0</span>]) <span class="keyword">return</span> embed.setAuthor(<span class="string">`Unable to find that station, sorry!`</span>, <span class="string">`<span class="subst">$&#123;message.author.displayAvatarURL()&#125;</span>`</span>), message.channel.send(embed)</span><br><span class="line">    <span class="comment">// [Above] if no station found, let them know</span></span><br><span class="line">    <span class="keyword">else</span> Client.music.servers.play(selected[<span class="number">0</span>], message) <span class="comment">// begin playback</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Super simple now that we have the actual music functions out of the way! We begin by making sure the “station” arguement is used. If it is, we then check to make sure the user provided a station to play - if the station isn’t provided, we tell the user to provide one - and if the station isn’t found, we let them know. Lastly, if all else went as planned, we begin playback.</p>
<p>It should look like this on success!<br><img src="../../../../assets/playstation.PNG" alt="File Tree"></p>
<p>You should be able to test the command and have output similar to the play by genre function! If it didn’t work, check and make sure you didn’t miss something. I believe in you!</p>
<hr>
<h2 id="Play-by-Manual-URL-Invalid-Function-Play-Command-4-4"><a href="#Play-by-Manual-URL-Invalid-Function-Play-Command-4-4" class="headerlink" title="Play by Manual URL / Invalid Function | Play Command [4/4]"></a>Play by Manual URL / Invalid Function | Play Command [4/4]</h2><p>Home stretch! We are almost done with the play command! Then we get to have fun with the simpler commands. </p>
<p>Let’s add a final check for the “manual” argument, and allow for manual URL inputs! And while we are at it, let’s add a final else statement so that if the arguement submitted doesn’t match, we let them know the proper command syntax!</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(args[<span class="number">0</span>].toLowerCase() == <span class="string">&quot;manual&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(!args[<span class="number">1</span>]) <span class="keyword">return</span> embed.setAuthor(<span class="string">`You must specify a supported stream URL!`</span>, <span class="string">`<span class="subst">$&#123;message.author.displayAvatarURL()&#125;</span>`</span>), message.channel.send(embed)</span><br><span class="line">        <span class="comment">// [Above] If there is not a stream url given, tell them to give one</span></span><br><span class="line">        <span class="comment">// [Below] Setup a stream array to pass in</span></span><br><span class="line">        <span class="comment">// [Stream Name, URL, Stats Position, Genre]</span></span><br><span class="line">        Client.music.servers.play([<span class="string">&quot;Manual&quot;</span>, args[<span class="number">1</span>], <span class="number">0</span>, <span class="string">&quot;Unknown&quot;</span>], message)</span><br><span class="line">        <span class="comment">// [Below] Lastly, if they didn&#x27;t use &quot;genre&quot;, &quot;station&quot;, or &quot;manual&quot; tell them to use one!</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">return</span> embed.setAuthor(<span class="string">`Specify genre [genre], station [station] or manual [stream]`</span>, <span class="string">`<span class="subst">$&#123;message.author.displayAvatarURL()&#125;</span>`</span>), message.channel.send(embed)</span><br></pre></td></tr></table></figure>
<p>It should look like this on success!<br><img src="../../../../assets/playmanual.PNG" alt="File Tree"></p>
<p>With that, we now have a finalized play command! This last segment just adds a manual stream array to playback, and a statement to tell a user to use the proper command syntax.<br>You should now have a final play command, that works to play any compatible station a user wants! </p>
<hr>
<h2 id="Station-List-Station-Info-Command"><a href="#Station-List-Station-Info-Command" class="headerlink" title="Station List / Station Info Command"></a>Station List / Station Info Command</h2><p>For this command, since it utilizes similar code to the play command, I won’t go as in depth, but rather leave information in the code comments.<br>Essentially, if a user does not provide a station to lookup with the “info” argument, it displays all available stations. If a user does provide a station to lookup, it fetches the station information!</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exports</span>.run = <span class="keyword">async</span> (Client, message, args) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> Discord = <span class="built_in">require</span>(<span class="string">&quot;discord.js&quot;</span>)</span><br><span class="line">    <span class="keyword">const</span> embed = <span class="keyword">new</span> Discord.MessageEmbed()</span><br><span class="line">    <span class="comment">// [Above] Create new embed</span></span><br><span class="line">    <span class="keyword">if</span> (!args[<span class="number">0</span>]) &#123; <span class="comment">// If no argument, display all stations</span></span><br><span class="line">        embed.setAuthor(<span class="string">&quot;Available Stations&quot;</span>, <span class="string">`<span class="subst">$&#123;message.author.displayAvatarURL()&#125;</span>`</span>)</span><br><span class="line">        embed.setDescription(<span class="string">&quot;🎹 These are the available Stations to listen to!&quot;</span>)</span><br><span class="line">        embed.addField(<span class="string">&quot;Stations List&quot;</span>, <span class="string">`\`<span class="subst">$&#123;Client.music.stations.map(stations =&gt; stations[<span class="number">0</span>]).join(<span class="string">&quot;\`, \`&quot;</span>)&#125;</span>\``</span>)</span><br><span class="line">        message.channel.send(embed)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(args[<span class="number">0</span>].toLowerCase() == <span class="string">&quot;info&quot;</span>) &#123; <span class="comment">// if argument is &quot;info&quot; run this</span></span><br><span class="line">        <span class="keyword">if</span>(!args[<span class="number">1</span>]) <span class="keyword">return</span> embed.setAuthor(<span class="string">&quot;You must provide a station to lookup!&quot;</span>, <span class="string">`<span class="subst">$&#123;message.author.displayAvatarURL()&#125;</span>`</span>), message.channel.send(embed)</span><br><span class="line">        args = args.splice(<span class="number">1</span>, args.length) <span class="comment">// remove &quot;info&quot; from the argument</span></span><br><span class="line">        <span class="keyword">var</span> station = Client.music.stations.filter(<span class="function"><span class="params">channel</span> =&gt;</span> channel[<span class="number">0</span>].toLowerCase().includes(args.join(<span class="string">&quot; &quot;</span>).toLowerCase())))[<span class="number">0</span>] <span class="comment">// fetch the station info</span></span><br><span class="line">        <span class="keyword">if</span>(!station || !station[<span class="number">0</span>]) <span class="keyword">return</span> embed.setAuthor(<span class="string">&quot;Unknown station. Sorry I couldn&#x27;t find anything!&quot;</span>, <span class="string">`<span class="subst">$&#123;message.author.displayAvatarURL()&#125;</span>`</span>), message.channel.send(embed)</span><br><span class="line">        embed.setAuthor(<span class="string">`<span class="subst">$&#123;station[<span class="number">0</span>]&#125;</span>`</span>, <span class="string">`<span class="subst">$&#123;message.author.displayAvatarURL()&#125;</span>`</span>)</span><br><span class="line">        embed.setDescription(<span class="string">`<span class="subst">$&#123;station[<span class="number">6</span>]&#125;</span>`</span>)</span><br><span class="line">        embed.addField(<span class="string">&quot;Website&quot;</span>, <span class="string">`<span class="subst">$&#123;station[<span class="number">4</span>]&#125;</span>`</span>, <span class="literal">true</span>)</span><br><span class="line">        <span class="keyword">if</span>(station[<span class="number">5</span>]) embed.addField(<span class="string">&quot;Donate&quot;</span>, <span class="string">`<span class="subst">$&#123;station[<span class="number">5</span>]&#125;</span>`</span>, <span class="literal">true</span>)</span><br><span class="line">        embed.addField(<span class="string">&quot;Genre&quot;</span>, <span class="string">`<span class="subst">$&#123;station[<span class="number">3</span>]&#125;</span>`</span>, <span class="literal">true</span>)</span><br><span class="line">        <span class="keyword">return</span> message.channel.send(embed)</span><br><span class="line">        <span class="comment">// [Above] Send the embed with specific station info</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">return</span> embed.setAuthor(<span class="string">&quot;Unknown request. Did you mean &#x27;station info [station]&#x27;?&quot;</span>, <span class="string">`<span class="subst">$&#123;message.author.displayAvatarURL()&#125;</span>`</span>), message.channel.send(embed)</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">exports</span>.help = &#123;</span><br><span class="line">    name: <span class="string">&quot;stations&quot;</span>,</span><br><span class="line">    aliases: [],</span><br><span class="line">    category: <span class="string">&quot;Music&quot;</span>,</span><br><span class="line">    description: <span class="string">&quot;Lists available stations and station specifics&quot;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="Genres-Command"><a href="#Genres-Command" class="headerlink" title="Genres Command"></a>Genres Command</h2><p>This command is almost identical to the Stations command, but with a minor change to what is mapped.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exports</span>.run = <span class="keyword">async</span> (Client, message, args) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> Discord = <span class="built_in">require</span>(<span class="string">&quot;discord.js&quot;</span>)</span><br><span class="line">    <span class="keyword">const</span> embed = <span class="keyword">new</span> Discord.MessageEmbed()</span><br><span class="line">    embed.setAuthor(<span class="string">&quot;Available Genres&quot;</span>, <span class="string">`<span class="subst">$&#123;message.author.displayAvatarURL()&#125;</span>`</span>)</span><br><span class="line">    embed.setDescription(<span class="string">&quot;🎹 These are the available Genres to listen to!&quot;</span>)</span><br><span class="line">    embed.addField(<span class="string">&quot;Genre List&quot;</span>, <span class="string">`\`<span class="subst">$&#123;[...<span class="keyword">new</span> <span class="built_in">Set</span>(Client.music.stations.map(stations =&gt; stations[<span class="number">3</span>]))].join(<span class="string">&quot;\`, \`&quot;</span>)&#125;</span>\``</span>)</span><br><span class="line">    message.channel.send(embed)</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">exports</span>.help = &#123;</span><br><span class="line">    name: <span class="string">&quot;genres&quot;</span>,</span><br><span class="line">    aliases: [],</span><br><span class="line">    category: <span class="string">&quot;Music&quot;</span>,</span><br><span class="line">    description: <span class="string">&quot;Lists available genres&quot;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="Now-Playing-Command"><a href="#Now-Playing-Command" class="headerlink" title="Now Playing Command"></a>Now Playing Command</h2><p>This command does a few things. It first creates a new embed, then it checks to see if the bot is playing anything. It checks to see it the server exists in the <code>Client.music.servers</code> map, and if it doesn’t it doesn’t fetch any info. If it is, then it checks to see if they have run the command recently. By default you should have at least 15 seconds between fetching a radio stations stream information, don’t allow users to flood a station. If they have checked in the past 15 seconds, tell them to wait. If now, fetch the stream stats of the playing station, and send the embed, as well as add another 15 second wait.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exports</span>.run = <span class="keyword">async</span> (Client, message, args) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> Discord = <span class="built_in">require</span>(<span class="string">&quot;discord.js&quot;</span>)</span><br><span class="line">    <span class="keyword">const</span> embed = <span class="keyword">new</span> Discord.MessageEmbed()</span><br><span class="line">    <span class="comment">// [Above] Create new embed</span></span><br><span class="line">    <span class="keyword">if</span>(!Client.music.servers.get(message.guild.id)) <span class="keyword">return</span> embed.setAuthor(<span class="string">&quot;I&#x27;m not currently playing anything!&quot;</span>, <span class="string">`<span class="subst">$&#123;message.author.displayAvatarURL()&#125;</span>`</span>), message.channel.send(embed)</span><br><span class="line">    <span class="comment">// [Above] Check if the server is in the servers map, if yes continue, if not, say it isn&#x27;t playing</span></span><br><span class="line">    <span class="comment">// [Below] Check if it has been 15 seconds since the last Now Playing request</span></span><br><span class="line">    <span class="keyword">if</span>(Client.music.servers.get(message.guild.id).lastRequest &gt; <span class="built_in">Date</span>.now()) <span class="keyword">return</span> embed.setAuthor(<span class="string">`Please wait <span class="subst">$&#123;<span class="built_in">Math</span>.floor(Client.music.servers.get(message.guild.id).lastRequest-<span class="built_in">Date</span>.now())/<span class="number">1000</span>&#125;</span> seconds before checking again.`</span>, <span class="string">`<span class="subst">$&#123;message.author.displayAvatarURL()&#125;</span>`</span>), message.channel.send(embed)</span><br><span class="line">    <span class="keyword">const</span> streamLatest = <span class="keyword">await</span> Client.music.getStation(Client.music.servers.get(message.guild.id).station)</span><br><span class="line">    <span class="comment">// [Above] Fetch the station stream information</span></span><br><span class="line">    <span class="comment">// [Below] For readability sake, make a title variable</span></span><br><span class="line">    <span class="keyword">const</span> title = streamLatest.source[Client.music.servers.get(message.guild.id).station[<span class="number">2</span>]].title </span><br><span class="line">    embed.setAuthor(<span class="string">`Playing Station <span class="subst">$&#123;Client.music.servers.get(message.guild.id).station[<span class="number">0</span>]&#125;</span>`</span>, <span class="string">`<span class="subst">$&#123;message.author.displayAvatarURL()&#125;</span>`</span>)</span><br><span class="line">    embed.setDescription(<span class="string">&quot;🎵 Songs can be checked every 15 seconds!&quot;</span>)</span><br><span class="line">    embed.addField(<span class="string">&quot;Current Track&quot;</span>, <span class="string">`<span class="subst">$&#123;title ? title : <span class="string">&quot;Unknown&quot;</span>&#125;</span>`</span>)</span><br><span class="line">    message.channel.send(embed) <span class="comment">// send the embed</span></span><br><span class="line">    <span class="comment">// [Below] Add a 15 second wait to the guild for the command</span></span><br><span class="line">    <span class="keyword">return</span> Client.music.servers.get(message.guild.id).lastRequest = <span class="built_in">Date</span>.now()+<span class="number">15000</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">exports</span>.help = &#123;</span><br><span class="line">    name: <span class="string">&quot;np&quot;</span>,</span><br><span class="line">    aliases: [],</span><br><span class="line">    category: <span class="string">&quot;Music&quot;</span>,</span><br><span class="line">    description: <span class="string">&quot;Fetches the song playing&quot;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>If all worked properly, it will look like this in the end<br><img src="../../../../assets/nowplaying.PNG" alt="File Tree"></p>
<hr>
<h2 id="Pause-Command"><a href="#Pause-Command" class="headerlink" title="Pause Command"></a>Pause Command</h2><p>This command is very simple! It first checks if the bot is playing a station, then it makes sure the user requesting the pause is the audio controller, if they aren’t then they aren’t allowed to pause, if yes, then make sure it isn’t paused already. If all else checks out, pause the stream!</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exports</span>.run = <span class="keyword">async</span> (Client, message, args) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> Discord = <span class="built_in">require</span>(<span class="string">&quot;discord.js&quot;</span>)</span><br><span class="line">    <span class="keyword">const</span> embed = <span class="keyword">new</span> Discord.MessageEmbed()</span><br><span class="line">    <span class="comment">// [Above] create new embed</span></span><br><span class="line">    <span class="comment">// [Below] Check if the bot is playing</span></span><br><span class="line">    <span class="keyword">if</span>(!Client.music.servers.get(message.guild.id)) <span class="keyword">return</span> embed.setAuthor(<span class="string">&quot;I&#x27;m not currently playing anything!&quot;</span>, <span class="string">`<span class="subst">$&#123;message.author.displayAvatarURL()&#125;</span>`</span>), message.channel.send(embed)</span><br><span class="line">    <span class="comment">// [Below] check if the user is the player controller</span></span><br><span class="line">    <span class="keyword">if</span>(message.author.id !== Client.music.servers.get(message.guild.id).userControl.id &amp;&amp; !message.member.hasPermission(<span class="string">&quot;MANAGE_GUILD&quot;</span>)) <span class="keyword">return</span> embed.setAuthor(<span class="string">`<span class="subst">$&#123;Client.music.servers.get(message.guild.id).userControl.tag&#125;</span> controls the audio right now.`</span>, <span class="string">`<span class="subst">$&#123;message.author.displayAvatarURL()&#125;</span>`</span>), message.channel.send(embed)</span><br><span class="line">    <span class="comment">// [Below] Make sure the player isn&#x27;t already paused</span></span><br><span class="line">    <span class="keyword">if</span>(Client.music.servers.get(message.guild.id).player.paused) <span class="keyword">return</span> embed.setAuthor(<span class="string">`I&#x27;m already paused! Try resuming!`</span>, <span class="string">`<span class="subst">$&#123;message.author.displayAvatarURL()&#125;</span>`</span>), message.channel.send(embed)</span><br><span class="line">    Client.music.servers.get(message.guild.id).player.pause() <span class="comment">// Pause</span></span><br><span class="line">    embed.setAuthor(<span class="string">`Paused! I&#x27;ll be here when you want to resume.`</span>, <span class="string">`<span class="subst">$&#123;message.author.displayAvatarURL()&#125;</span>`</span>), message.channel.send(embed) <span class="comment">// Send embed</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">exports</span>.help = &#123;</span><br><span class="line">    name: <span class="string">&quot;pause&quot;</span>,</span><br><span class="line">    aliases: [],</span><br><span class="line">    category: <span class="string">&quot;Music&quot;</span>,</span><br><span class="line">    description: <span class="string">&quot;Pauses playback&quot;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>It will result in something like this<br><img src="../../../../assets/pausecommand.PNG" alt="File Tree"></p>
<hr>
<h2 id="Resume-Command"><a href="#Resume-Command" class="headerlink" title="Resume Command"></a>Resume Command</h2><p>This one is exactly like pause but with a method change, see if you can spot the difference!</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exports</span>.run = <span class="keyword">async</span> (Client, message, args) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> Discord = <span class="built_in">require</span>(<span class="string">&quot;discord.js&quot;</span>)</span><br><span class="line">    <span class="keyword">const</span> embed = <span class="keyword">new</span> Discord.MessageEmbed()</span><br><span class="line">    <span class="keyword">if</span>(!Client.music.servers.get(message.guild.id)) <span class="keyword">return</span> embed.setAuthor(<span class="string">&quot;I&#x27;m not currently playing anything!&quot;</span>, <span class="string">`<span class="subst">$&#123;message.author.displayAvatarURL()&#125;</span>`</span>), message.channel.send(embed)</span><br><span class="line">    <span class="keyword">if</span>(message.author.id !== Client.music.servers.get(message.guild.id).userControl.id &amp;&amp; !message.member.hasPermission(<span class="string">&quot;MANAGE_GUILD&quot;</span>)) <span class="keyword">return</span> embed.setAuthor(<span class="string">`<span class="subst">$&#123;Client.music.servers.get(message.guild.id).userControl.tag&#125;</span> controls the audio right now.`</span>, <span class="string">`<span class="subst">$&#123;message.author.displayAvatarURL()&#125;</span>`</span>), message.channel.send(embed)</span><br><span class="line">    <span class="keyword">if</span>(!Client.music.servers.get(message.guild.id).player.paused) <span class="keyword">return</span> embed.setAuthor(<span class="string">`I&#x27;m not paused right now, sorry!`</span>, <span class="string">`<span class="subst">$&#123;message.author.displayAvatarURL()&#125;</span>`</span>), message.channel.send(embed)</span><br><span class="line">    Client.music.servers.get(message.guild.id).player.resume()</span><br><span class="line">    embed.setAuthor(<span class="string">`Resuming the Stream! Hope you enjoy!`</span>, <span class="string">`<span class="subst">$&#123;message.author.displayAvatarURL()&#125;</span>`</span>), message.channel.send(embed)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">exports</span>.help = &#123;</span><br><span class="line">    name: <span class="string">&quot;resume&quot;</span>,</span><br><span class="line">    aliases: [],</span><br><span class="line">    category: <span class="string">&quot;Music&quot;</span>,</span><br><span class="line">    description: <span class="string">&quot;Resumes playback&quot;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>It should in the end look like this if you didn’t customize the wording/design<br><img src="../../../../assets/resuming.PNG" alt="File Tree"></p>
<hr>
<h2 id="Stop-Command"><a href="#Stop-Command" class="headerlink" title="Stop Command"></a>Stop Command</h2><p>Again, just like the pause command but without the paused/resumed check and a method change</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exports</span>.run = <span class="keyword">async</span> (Client, message, args) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> Discord = <span class="built_in">require</span>(<span class="string">&quot;discord.js&quot;</span>)</span><br><span class="line">    <span class="keyword">const</span> embed = <span class="keyword">new</span> Discord.MessageEmbed()</span><br><span class="line">    <span class="keyword">if</span>(!Client.music.servers.get(message.guild.id)) <span class="keyword">return</span> embed.setAuthor(<span class="string">&quot;I&#x27;m not currently playing anything!&quot;</span>, <span class="string">`<span class="subst">$&#123;message.author.displayAvatarURL()&#125;</span>`</span>), message.channel.send(embed)</span><br><span class="line">    <span class="keyword">if</span>(message.author.id !== Client.music.servers.get(message.guild.id).userControl.id &amp;&amp; !message.member.hasPermission(<span class="string">&quot;MANAGE_GUILD&quot;</span>)) <span class="keyword">return</span> embed.setAuthor(<span class="string">`<span class="subst">$&#123;Client.music.servers.get(message.guild.id).userControl.tag&#125;</span> controls the audio right now.`</span>, <span class="string">`<span class="subst">$&#123;message.author.displayAvatarURL()&#125;</span>`</span>), message.channel.send(embed)</span><br><span class="line">    Client.music.servers.get(message.guild.id).dispatcher.disconnect()</span><br><span class="line">    embed.setAuthor(<span class="string">`Alright, I&#x27;ve stopped and left the channel. See you later!`</span>, <span class="string">`<span class="subst">$&#123;message.author.displayAvatarURL()&#125;</span>`</span>), message.channel.send(embed)</span><br><span class="line">    <span class="keyword">return</span> Client.music.servers.delete(message.guild.id)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">exports</span>.help = &#123;</span><br><span class="line">    name: <span class="string">&#x27;stop&#x27;</span>,</span><br><span class="line">    aliases: [<span class="string">&quot;leave&quot;</span>],</span><br><span class="line">    category: <span class="string">&#x27;Music&#x27;</span>,</span><br><span class="line">    description: <span class="string">&quot;Stops playback&quot;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="Volume-Command"><a href="#Volume-Command" class="headerlink" title="Volume Command"></a>Volume Command</h2><p>The wonderful volume command! This allows for the changing of volume up to 2x, and as low as 1!<br>It’s almost identical to the pause, stop, and resume commands except that it checks is the volume is a number, and between 1 and 200.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exports</span>.run = <span class="keyword">async</span> (Client, message, args) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> Discord = <span class="built_in">require</span>(<span class="string">&quot;discord.js&quot;</span>)</span><br><span class="line">    <span class="keyword">const</span> embed = <span class="keyword">new</span> Discord.MessageEmbed()</span><br><span class="line">    <span class="keyword">if</span>(!Client.music.servers.get(message.guild.id)) <span class="keyword">return</span> embed.setAuthor(<span class="string">&quot;I&#x27;m not currently playing anything!&quot;</span>, <span class="string">`<span class="subst">$&#123;message.author.displayAvatarURL()&#125;</span>`</span>), message.channel.send(embed)</span><br><span class="line">    <span class="keyword">if</span>(message.author.id !== Client.music.servers.get(message.guild.id).userControl.id &amp;&amp; !message.member.hasPermission(<span class="string">&quot;MANAGE_GUILD&quot;</span>)) <span class="keyword">return</span> embed.setAuthor(<span class="string">`<span class="subst">$&#123;Client.music.servers.get(message.guild.id).userControl.tag&#125;</span> controls the audio right now.`</span>, <span class="string">`<span class="subst">$&#123;message.author.displayAvatarURL()&#125;</span>`</span>), message.channel.send(embed)</span><br><span class="line">    <span class="comment">// [Below] Check if the supplied volume is between 1 and 200, and is a number</span></span><br><span class="line">    <span class="keyword">if</span>(!args[<span class="number">0</span>] || <span class="built_in">isNaN</span>(args[<span class="number">0</span>] || args[<span class="number">0</span>] &lt; <span class="number">1</span> || args[<span class="number">0</span>] &gt; <span class="number">200</span>)) <span class="keyword">return</span> embed.setAuthor(<span class="string">&quot;Volume Specified must be between 1-200&quot;</span>, <span class="string">`<span class="subst">$&#123;message.author.displayAvatarURL()&#125;</span>`</span>), message.channel.send(embed)</span><br><span class="line">    Client.music.servers.get(message.guild.id).player.setVolume(args[<span class="number">0</span>]/<span class="number">100</span>) <span class="comment">// Update volume</span></span><br><span class="line">    embed.setAuthor(<span class="string">`Volume set to <span class="subst">$&#123;<span class="built_in">Math</span>.floor(args[<span class="number">0</span>])&#125;</span>%`</span>, <span class="string">`<span class="subst">$&#123;message.author.displayAvatarURL()&#125;</span>`</span>), message.channel.send(embed)</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">exports</span>.help = &#123;</span><br><span class="line">    name: <span class="string">&quot;volume&quot;</span>,</span><br><span class="line">    aliases: [],</span><br><span class="line">    category: <span class="string">&quot;Music&quot;</span>,</span><br><span class="line">    description: <span class="string">&quot;Adjusts player volume&quot;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>A final volume command will look like this!<br><img src="../../../../assets/volumecommand.PNG" alt="File Tree"></p>
<hr>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p><strong>Hooray!</strong> You got through the entire tutorial. I know this one was long, but I wanted to make sure I was providing readers with a good music bot. You should now have a music bot that plays all different types of Radio stations and genres, and a station catalog that auto updates as I grow the station list!</p>
<p>I really hope you enjoyed the tutorial, and found it useful, if you have any questions, I recommend checking the <a target="_blank" rel="noopener" href="https://discord.js.org/">Discord.js Docs</a> OR joining a community bot development server like <a target="_blank" rel="noopener" href="https://discord.gg/EYHTgJX">Top.GG</a> to ask other developers for some assistance. Remember, don’t ask to be spoon fed, you will need to figure out a solution <strong>with them</strong> not get one <strong>from</strong> them.</p>
<p>With that being said, enjoy having a music bot that doesn’t break the youtube terms of service, and doesn’t require IP changes to get around youtube bans/blocks!</p>

	  <div class="article-footer-copyright">

    本博客采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议(CC BY-NC-SA 4.0) 发布.</a>
</div>

	</div>

	
	<span id="/code/topics/discordjs/musicbot/" class="leancloud-visitors view" data-flag-title="Music Bot Setup">
		<em class="post-meta-item-text"> Page View </em> <i class="leancloud-visitors-count"></i>
	</span>
	
	<div>
  	<center>

	<div class="pagination">

    
</div>

    </center>
	</div>
	
	<!-- comment -->
	<!--
-->
	
	</div> <!-- col-md-9/col-md-12 -->


		

</div><!-- row -->

<!--
 -->



	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  
  &copy; 2024 hitman's Blog
  
      . wubba <a href="http://hexo.io/" target="_blank">lubba</a> dub <a href="https://github.com/Ares-X/hexo-theme-freemind.bithack" target="_blank"> dub.</a>  
</p>

 </footer>
</div> <!-- container-narrow -->
  



  
<a id="gotop" href="#">   
  <span>⬆︎TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

</body>
   </html>
